{
  "name": "ADICIONAR_NO_WORKFLOW_PRINCIPAL",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "20cf51d3-4254-4cd3-9ad2-3395debddf46",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "1ccc6b0b-c3bb-4102-bd09-36b159332d8f",
      "name": "Webhook: Nova Mensagem",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        22560,
        -768
      ],
      "webhookId": "20cf51d3-4254-4cd3-9ad2-3395debddf46"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 1. VALIDAR E PROCESSAR (V5 - COM RECORDATÃ“RIO HÃBRIDO)\n// =====================================================\n// CORREÃ‡Ã•ES:\n// 1. Suporte a recordatÃ³rio hÃ­brido (foto + texto + Ã¡udio)\n// 2. Mescla informaÃ§Ãµes de mÃºltiplas fontes\n// =====================================================\n\nconst inputData = $input.first().json;\n\n// ðŸ” Tentar encontrar os dados na raiz ou dentro de 'body'\nconst data = inputData.body || inputData;\n\nconsole.log('=== DEBUG PAYLOAD ===');\nconsole.log('Keys na raiz:', Object.keys(inputData));\nconsole.log('Keys em data:', Object.keys(data));\nconsole.log('ConversationId:', data.conversationId);\n\n// Apenas processar mensagens de PACIENTES\nif (data.senderRole !== 'patient') {\n  return {\n    json: {\n      skipped: true,\n      reason: 'Mensagem do prescritor - nÃ£o precisa processar',\n      conversationId: data.conversationId\n    }\n  };\n}\n\n// Normalizar attachments\nlet attachments = data.attachments || [];\nif (attachments.length === 0 && data.mediaUrl) {\n  attachments.push({\n    url: data.mediaUrl,\n    type: data.type || 'file'\n  });\n}\n\n// =====================================================\n// ðŸ”¥ DETECÃ‡ÃƒO DE FOTO - PRIORIDADE ABSOLUTA\n// =====================================================\nconst hasImage = \n  data.hasImage === true ||\n  data.type === 'image' ||\n  (attachments && attachments.some(a => \n    a.type === 'image' || \n    a.contentType?.startsWith('image/')\n  )) ||\n  !!data.imageUrl;\n\nconst hasAudio = \n  data.hasAudio === true ||\n  data.type === 'audio' ||\n  !!data.audioUrl;\n\n// =====================================================\n// âœ… NOVO: SUPORTE A RECORDATÃ“RIO HÃBRIDO\n// =====================================================\n\n// Criar objeto de recordatÃ³rio\nconst recordatorio = {\n  fontes: [],\n  textoDescritivo: null,\n  audioTranscricao: null, // SerÃ¡ preenchido pelo nÃ³ de transcriÃ§Ã£o\n  ehHibrido: false\n};\n\nif (hasImage) recordatorio.fontes.push('foto');\nif (data.content && data.content.trim().length > 3) {\n  recordatorio.fontes.push('texto');\n  recordatorio.textoDescritivo = data.content.trim();\n}\nif (hasAudio) recordatorio.fontes.push('audio');\n\nrecordatorio.ehHibrido = recordatorio.fontes.length > 1;\n\nconsole.log('ðŸ“¥ [VALIDAR] Fontes detectadas:', recordatorio.fontes.join(', '));\nconsole.log('ðŸ“¥ [VALIDAR] Ã‰ recordatÃ³rio hÃ­brido:', recordatorio.ehHibrido);\nif (recordatorio.textoDescritivo) {\n  console.log('ðŸ“ [VALIDAR] Texto:', recordatorio.textoDescritivo.substring(0, 50) + '...');\n}\n\n// Flag de prioridade: tem foto com URL vÃ¡lida\nconst photoPriority = hasImage && !!(data.mediaUrl || data.imageUrl || attachments[0]?.url);\n\nif (photoPriority) {\n  console.log('ðŸ”¥ [VALIDAR] FOTO DETECTADA - PRIORIDADE MÃXIMA');\n  console.log('ðŸ“¸ [VALIDAR] URL:', (data.mediaUrl || data.imageUrl || attachments[0]?.url)?.substring(0, 60) + '...');\n}\n\n// =====================================================\n// RETORNO SANITIZADO COM FLAGS DE PRIORIDADE\n// =====================================================\nreturn {\n  json: {\n    // Dados bÃ¡sicos\n    conversationId: String(data.conversationId || '').trim(),\n    messageId: String(data.messageId || '').trim(),\n    senderId: String(data.senderId || '').trim(),\n    senderRole: data.senderRole,\n    content: String(data.content || '').trim(),\n    type: data.type || 'text',\n    \n    // MÃ­dia\n    mediaUrl: data.mediaUrl || data.imageUrl || null,\n    imageUrl: data.imageUrl || (hasImage ? data.mediaUrl : null),\n    audioUrl: data.audioUrl || (hasAudio ? data.mediaUrl : null),\n    hasImage: hasImage,\n    hasAudio: hasAudio,\n    attachments: attachments,\n    \n    // IDs\n    patientId: data.patientId || data.senderId,\n    prescriberId: data.prescriberId,\n    \n    // Metadados\n    timestamp: data.timestamp || new Date().toISOString(),\n    patientPhone: data.patientPhone,\n    patientName: data.patientName || data.senderName,\n    channel: data.channel || 'whatsapp',\n    source: data.source || 'whatsapp-baileys',\n    \n    // ðŸ”¥ FLAGS DE PRIORIDADE - CRUCIAL!\n    _photoPriority: photoPriority,\n    _skipGenericResponse: photoPriority,  // NÃ£o enviar \"Oi, hora do almoÃ§o!\"\n    _waitForAnalysis: photoPriority,       // Esperar anÃ¡lise completar\n    _mediaType: hasImage ? 'image' : (hasAudio ? 'audio' : 'text'),\n    \n    // âœ… NOVO: RecordatÃ³rio hÃ­brido\n    recordatorio: recordatorio,\n    ehRecordatorioHibrido: recordatorio.ehHibrido,\n    \n    // Debug\n    _raw: inputData\n  }\n};\n"
      },
      "id": "c3315cf2-8a87-418d-8a63-ef1ef064129e",
      "name": "1. Validar e Processar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        22784,
        -768
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "caa174a2-ef1b-45ff-a257-17d5250f2234",
              "leftValue": "={{ $json.filtered === true || $json.filtered === 'true' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "fde02f8f-26b7-429c-9e9f-ad94bb00f606",
      "name": "2. Foi Filtrado?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        23008,
        -768
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, filtered: true, reason: $json.reason } }}",
        "options": {}
      },
      "id": "b4ca1d77-c4bb-4173-908d-d04f63e899a2",
      "name": "Responder: Filtrado",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        23232,
        -1344
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "8c5e3d7b-9a1c-4b2e-9d8f-7e6a5b4c3d2e",
              "leftValue": "={{ $json.data.patientStatus }}",
              "rightValue": "active",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "7e975784-5fdb-4c85-95a7-fd4359bfc2db",
      "name": "3-bis. Checar Assinatura",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        25152,
        -288
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "a1b2c3d4-e5f6-4a5b-bcde-f1e2d3c4b5a6",
              "leftValue": "={{ $json.data.patientStatus }}",
              "rightValue": "active",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "012e7f02-d464-4553-93dc-6d92cd6da804",
      "name": "4-bis. Checar (FOTO)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        24128,
        -800
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: false, error: 'suspended', message: 'âš ï¸ Seu acesso ao NutriBuddy estÃ¡ pendente de regularizaÃ§Ã£o.\\\n\\\nPara continuar registrando suas refeiÃ§Ãµes e recebendo acompanhamento nutricional inteligente, regularize seu plano agora em: https://nutri-buddy-novo-git-main-drpauloguimaraesjrs-projects.vercel.app/regularizar?p=' + ($json.data.patientId || $json.patientId) } }}",
        "options": {}
      },
      "id": "cbd46060-b721-4e59-8344-845b6a3af4fb",
      "name": "Responder: Assinatura Suspensa",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        25376,
        -960
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $('1. Validar e Processar' ).item.json.conversationId }}\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "7c8c4678-5ade-41a1-b87d-64ac897761de",
      "name": "3. Buscar Conversa",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        24864,
        -288
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $('1. Validar e Processar').item.json.conversationId }}/messages?limit=100",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "a1440604-95ca-481f-9ff4-41145e087871",
      "name": "4. Buscar HistÃ³rico",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        25600,
        -192
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/patients/{{ $('1. Validar e Processar').item.json.patientId }}/diet",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "f94fda46-b998-4e4a-a285-b4180ec4f9f0",
      "name": "5. Buscar Dieta do Paciente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        25824,
        -192
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// 6. CONSTRUIR CONTEXTO IA (VERSÃƒO FINAL CORRIGIDA)\n// ============================================\n// Este nÃ³ monta o contexto completo para a IA (GPT-4o)\n// incluindo dados do paciente, dieta, histÃ³rico e instruÃ§Ãµes de raciocÃ­nio\n\n// 1. RECUPERAR CONTEÃšDO DA MENSAGEM (PRIORIZANDO TRANSCRIÃ‡ÃƒO)\nlet userContent = '';\nlet isTranscribed = false;\n\ntry {\n  const audioItem = $('AUDIO: 4. Parse TranscriÃ§Ã£o').first();\n  if (audioItem && audioItem.json && audioItem.json.content) {\n    userContent = audioItem.json.content;\n    isTranscribed = true;\n    console.log('ðŸŽ™ï¸ TranscriÃ§Ã£o recuperada:', userContent);\n  }\n} catch (e) {\n  // Ignora erro se o nÃ³ nÃ£o foi executado (mensagem de texto normal)\n}\n\nif (!userContent) {\n  try {\n    userContent = $('1. Validar e Processar').first().json.content;\n    console.log('ðŸ“ ConteÃºdo original (texto):', userContent);\n  } catch (e) {\n    userContent = '';\n    console.log('âš ï¸ ConteÃºdo vazio');\n  }\n}\n\n// Objeto consolidado da mensagem atual\nconst currentItem = {\n  ...$('1. Validar e Processar').first().json,\n  content: userContent,\n  isTranscribed: isTranscribed\n};\n\n// Extrair dados bÃ¡sicos\nconst patientId = $('1. Validar e Processar').first().json.patientId || $('1. Validar e Processar').first().json.body?.patientId;\nconst prescriberId = $('1. Validar e Processar').first().json.prescriberId || $('1. Validar e Processar').first().json.body?.prescriberId;\nconst conversationId = $('1. Validar e Processar').first().json.conversationId || $('1. Validar e Processar').first().json.body?.conversationId;\nconst messageContent = userContent || $('1. Validar e Processar').first().json.content || '';\nconst senderRole = $('1. Validar e Processar').first().json.senderRole || $('1. Validar e Processar').first().json.body?.senderRole || 'patient';\n\n// ============================================\n// CONTEXTO TEMPORAL (HORÃRIO ATUAL)\n// ============================================\nconst brazilTime = new Date().toLocaleString(\"en-US\", { timeZone: \"America/Sao_Paulo\" });\nconst agora = new Date(brazilTime);\nconst horaAtual = agora.getHours();\nconst minutosAtual = agora.getMinutes();\nconst horaFormatada = `${String(horaAtual).padStart(2, '0')}:${String(minutosAtual).padStart(2, '0')}`;\n\n// Determinar refeiÃ§Ã£o esperada baseada no horÃ¡rio\nlet refeicaoEsperada = 'lanche';\nlet refeicoesPossiveis = [];\nlet refeicoesPassadas = [];\n\nif (horaAtual >= 5 && horaAtual < 10) {\n  // ManhÃ£ (5h - 9h59): CafÃ© da manhÃ£\n  refeicaoEsperada = 'cafÃ© da manhÃ£';\n  refeicoesPossiveis = ['cafÃ© da manhÃ£'];\n  refeicoesPassadas = [];\n} else if (horaAtual >= 10 && horaAtual < 12) {\n  // Meio da manhÃ£ (10h - 11h59): Lanche ou cafÃ© da manhÃ£ tardio\n  refeicaoEsperada = 'lanche da manhÃ£';\n  refeicoesPossiveis = ['lanche da manhÃ£', 'cafÃ© da manhÃ£'];\n  refeicoesPassadas = ['cafÃ© da manhÃ£'];\n} else if (horaAtual >= 12 && horaAtual < 15) {\n  // AlmoÃ§o (12h - 14h59)\n  refeicaoEsperada = 'almoÃ§o';\n  refeicoesPossiveis = ['almoÃ§o'];\n  refeicoesPassadas = ['cafÃ© da manhÃ£', 'lanche da manhÃ£'];\n} else if (horaAtual >= 15 && horaAtual < 18) {\n  // Tarde (15h - 17h59): Lanche da tarde\n  refeicaoEsperada = 'lanche da tarde';\n  refeicoesPossiveis = ['lanche da tarde'];\n  refeicoesPassadas = ['cafÃ© da manhÃ£', 'lanche da manhÃ£', 'almoÃ§o'];\n} else if (horaAtual >= 18 && horaAtual < 22) {\n  // Noite (18h - 21h59): Jantar\n  refeicaoEsperada = 'jantar';\n  refeicoesPossiveis = ['jantar'];\n  refeicoesPassadas = ['cafÃ© da manhÃ£', 'lanche da manhÃ£', 'almoÃ§o', 'lanche da tarde'];\n} else {\n  // Madrugada (22h - 4h59): Ceia ou nada\n  refeicaoEsperada = 'ceia';\n  refeicoesPossiveis = ['ceia'];\n  refeicoesPassadas = ['cafÃ© da manhÃ£', 'lanche da manhÃ£', 'almoÃ§o', 'lanche da tarde', 'jantar'];\n}\n\nconst contextoTemporal = `\n=== CONTEXTO TEMPORAL ===\nHorÃ¡rio Atual: ${horaFormatada} (${horaAtual}h${minutosAtual > 0 ? minutosAtual : ''})\nRefeiÃ§Ã£o Esperada Neste HorÃ¡rio: ${refeicaoEsperada}\nRefeiÃ§Ãµes PossÃ­veis Agora: ${refeicoesPossiveis.join(', ')}\nRefeiÃ§Ãµes que JÃ¡ Passaram Hoje: ${refeicoesPassadas.length > 0 ? refeicoesPassadas.join(', ') : 'Nenhuma ainda'}\n\nâš ï¸ REGRAS TEMPORAIS IMPORTANTES:\n1. NUNCA pergunte sobre refeiÃ§Ãµes que ainda nÃ£o aconteceram no horÃ¡rio atual\n   - Se sÃ£o ${horaFormatada} da manhÃ£ â†’ NÃƒO pergunte sobre almoÃ§o ou jantar\n   - Se sÃ£o ${horaFormatada} da tarde â†’ NÃƒO pergunte sobre jantar (ainda nÃ£o chegou)\n   - Se sÃ£o ${horaFormatada} da noite â†’ Pode perguntar sobre qualquer refeiÃ§Ã£o do dia\n\n2. Quando o paciente perguntar sobre uma refeiÃ§Ã£o:\n   - Se a refeiÃ§Ã£o JÃ PASSOU â†’ Busque no histÃ³rico e responda\n   - Se a refeiÃ§Ã£o AINDA NÃƒO ACONTECEU â†’ Diga: \"Ainda nÃ£o Ã© horÃ¡rio de ${refeicaoEsperada}. O horÃ¡rio atual Ã© ${horaFormatada}.\"\n\n3. Exemplos de respostas corretas (RESUMIDAS):\n   - Paciente Ã s 9h: \"O que comi no almoÃ§o?\" â†’ \"Ainda nÃ£o Ã© horÃ¡rio de almoÃ§o! SÃ£o ${horaFormatada}. Quer saber sobre o cafÃ© da manhÃ£? â˜•\"\n   - Paciente Ã s 14h: \"O que comi no almoÃ§o?\" â†’ \"No almoÃ§o vocÃª comeu: [lista alimentos]. Total: X kcal, P: Xg C: Xg G: Xg.\"\n   - Paciente Ã s 9h: \"O que comi no cafÃ©?\" â†’ \"No cafÃ© vocÃª comeu: [lista alimentos]. Total: X kcal.\"\n   - IMPORTANTE: Seja DIRETO. NÃ£o explique demais. VÃ¡ direto ao ponto.\n\n4. Seja INTELIGENTE sobre contexto temporal:\n   - Considere o horÃ¡rio ao responder perguntas sobre refeiÃ§Ãµes\n   - NÃ£o assuma que refeiÃ§Ãµes futuras jÃ¡ aconteceram\n   - Use bom senso sobre o que faz sentido perguntar naquele horÃ¡rio\n`;\n\n// Buscar dados do paciente do Firebase (via nÃ³ 5z)\nlet patientData = null;\nlet dietPlanData = null;\n\ntry {\n  const patientContextNode = $('5z. Buscar Contexto Completo do Paciente');\n  if (patientContextNode && patientContextNode.first()) {\n    const contextData = patientContextNode.first().json.context || {};\n    patientData = contextData.patient || null;\n    dietPlanData = contextData.dietPlan || null;\n    console.log('âœ… Dados do paciente recuperados do nÃ³ 5z');\n  }\n} catch (e) {\n  console.log('âš ï¸ NÃ£o foi possÃ­vel buscar dados do paciente do nÃ³ 5z:', e.message);\n}\n\n// Se nÃ£o encontrou, tentar buscar do nÃ³ de dieta\nif (!dietPlanData) {\n  try {\n    const dietNode = $('5. Buscar Dieta do Paciente');\n    if (dietNode && dietNode.first()) {\n      dietPlanData = dietNode.first().json.data || null;\n    }\n  } catch (e) {\n    console.log('âš ï¸ NÃ£o foi possÃ­vel buscar dieta');\n  }\n}\n\n// Buscar histÃ³rico formatado (se disponÃ­vel)\nlet historicoFormatado = '';\nlet temHistorico = false;\nlet summaryMacros = null;\nlet logsPorData = {};\n\ntry {\n  const historicoNode = $('4. Buscar HistÃ³rico');\n  if (historicoNode && historicoNode.first()) {\n    const historicoData = historicoNode.first().json;\n    const messages = historicoData.messages || [];\n    \n    if (messages.length > 0) {\n      temHistorico = true;\n      \n      // Agrupar por data\n      const hoje = new Date().toISOString().split('T')[0];\n      const logsHoje = [];\n      \n      messages.forEach(msg => {\n        const msgDate = msg.date || msg.createdAt?.split('T')[0] || hoje;\n        if (!logsPorData[msgDate]) {\n          logsPorData[msgDate] = [];\n        }\n        logsPorData[msgDate].push(msg);\n        \n        if (msgDate === hoje) {\n          logsHoje.push(msg);\n        }\n      });\n      \n      // Formatar histÃ³rico do dia atual\n      if (logsHoje.length > 0) {\n        historicoFormatado = logsHoje.map(log => {\n          const tipo = log.type || 'refeiÃ§Ã£o';\n          const alimentos = log.foods || log.alimentos || [];\n          const macros = log.macros || {};\n          \n          return `${tipo}: ${alimentos.map(a => a.nome || a.name || 'Alimento').join(', ')} - P:${macros.protein || macros.proteinas || 0}g C:${macros.carbs || macros.carboidratos || 0}g G:${macros.fats || macros.gorduras || 0}g Cal:${macros.calories || macros.calorias || 0}kcal`;\n        }).join('\\n');\n        \n        // Calcular totais do dia\n        summaryMacros = logsHoje.reduce((acc, log) => {\n          const macros = log.macros || {};\n          return {\n            protein: (acc.protein || 0) + (macros.protein || macros.proteinas || 0),\n            carbs: (acc.carbs || 0) + (macros.carbs || macros.carboidratos || 0),\n            fats: (acc.fats || 0) + (macros.fats || macros.gorduras || 0),\n            calories: (acc.calories || 0) + (macros.calories || macros.calorias || 0),\n            date: hoje\n          };\n        }, { protein: 0, carbs: 0, fats: 0, calories: 0 });\n      }\n    }\n  }\n} catch (e) {\n  console.log('âš ï¸ HistÃ³rico nÃ£o disponÃ­vel:', e.message);\n}\n\n// Buscar histÃ³rico de conversas (Ãºltimas mensagens)\nlet conversationHistory = [];\ntry {\n  const historyNode = $('4. Buscar HistÃ³rico');\n  if (historyNode && historyNode.first()) {\n    const historyData = historyNode.first().json;\n    if (Array.isArray(historyData.messages)) {\n      conversationHistory = historyData.messages.slice(-10); // Ãšltimas 10 mensagens\n    }\n  }\n} catch (e) {\n  console.log('âš ï¸ HistÃ³rico de conversa nÃ£o disponÃ­vel');\n}\n\n// Formatar histÃ³rico de conversa para o prompt\nconst conversationHistoryText = conversationHistory.length > 0\n  ? conversationHistory.map(msg => {\n      const role = msg.senderRole === 'patient' ? 'Paciente' : 'NutriBuddy';\n      const content = msg.content || '';\n      return `${role}: ${content}`;\n    }).join('\\n')\n  : 'Nenhuma conversa anterior registrada.';\n\n// Buscar dados da conversa (com tratamento de erro caso o nÃ³ nÃ£o tenha sido executado)\n// âœ… CORREÃ‡ÃƒO: A variÃ¡vel 'conversation' nÃ£o Ã© usada no cÃ³digo, entÃ£o podemos simplesmente nÃ£o acessÃ¡-la\n// Se precisar dos dados da conversa no futuro, adicione aqui com tratamento de erro adequado\nlet conversation = null;\n\n// NOTA: O nÃ³ \"3. Buscar Conversa\" pode nÃ£o ser executado em fluxos de histÃ³rico.\n// Como a variÃ¡vel 'conversation' nÃ£o Ã© usada neste cÃ³digo, nÃ£o precisamos acessÃ¡-la.\n// Se no futuro precisar dos dados da conversa, descomente o cÃ³digo abaixo:\n/*\ntry {\n  conversation = $('3. Buscar Conversa').first().json;\n  console.log('âœ… Dados da conversa recuperados');\n} catch (e) {\n  console.log('âš ï¸ NÃ³ \"3. Buscar Conversa\" nÃ£o foi executado (normal para perguntas sobre histÃ³rico):', e.message);\n  conversation = null;\n}\n*/\n\n// Montar informaÃ§Ãµes do paciente\nconst patientInfo = patientData ? `\n=== DADOS DO PACIENTE ===\nNome: ${patientData.name || 'NÃ£o informado'}\nIdade: ${patientData.age || 'NÃ£o informado'} anos\nPeso Atual: ${patientData.weight || patientData.currentWeight || 'NÃ£o informado'} kg\nAltura: ${patientData.height || 'NÃ£o informado'} cm\nGÃªnero: ${patientData.gender === 'male' ? 'Masculino' : patientData.gender === 'female' ? 'Feminino' : patientData.gender || 'NÃ£o informado'}\n\n=== METAS E OBJETIVOS ===\nObjetivo Principal: ${patientData.objective === 'lose_weight' ? 'Perder Peso' : \n                     patientData.objective === 'gain_muscle' ? 'Ganhar Massa Muscular' : \n                     patientData.objective === 'gain_weight' ? 'Ganhar Peso' : \n                     patientData.objective === 'maintain' ? 'Manter Peso' : \n                     patientData.objective === 'performance' ? 'Performance' : \n                     patientData.objective === 'health' ? 'SaÃºde Geral' : \n                     patientData.objective || 'NÃ£o informado'}\nPeso Inicial: ${patientData.initialWeight || 'NÃ£o informado'} kg\nPeso Alvo: ${patientData.targetWeight || 'NÃ£o informado'} kg\nMetas Semanais: ${Array.isArray(patientData.weeklyGoals) ? patientData.weeklyGoals.join(', ') : 'Nenhuma'}\n\n=== PERFIL DE SAÃšDE ===\nAlergias: ${Array.isArray(patientData.allergies) && patientData.allergies.length > 0 ? patientData.allergies.join(', ') : 'Nenhuma'}\nOutras Alergias: ${patientData.otherAllergies || 'Nenhuma'}\nCondiÃ§Ãµes de SaÃºde: ${Array.isArray(patientData.healthConditions) && patientData.healthConditions.length > 0 ? patientData.healthConditions.join(', ') : 'Nenhuma'}\nMedicamentos: ${patientData.medications || 'Nenhum'}\n\n=== PREFERÃŠNCIAS ALIMENTARES ===\nEstilo Alimentar: ${patientData.foodStyle === 'vegetarian' ? 'Vegetariano' : \n                   patientData.foodStyle === 'vegan' ? 'Vegano' : \n                   patientData.foodStyle === 'omnivore' ? 'OnÃ­voro' : \n                   patientData.foodStyle || 'NÃ£o informado'}\nAlimentos Favoritos: ${Array.isArray(patientData.favoriteFoods) && patientData.favoriteFoods.length > 0 ? patientData.favoriteFoods.join(', ') : 'Nenhum'}\nAlimentos que NÃ£o Gosta: ${Array.isArray(patientData.dislikedFoods) && patientData.dislikedFoods.length > 0 ? patientData.dislikedFoods.join(', ') : 'Nenhum'}\nRestriÃ§Ãµes Alimentares: ${Array.isArray(patientData.dietaryRestrictions) && patientData.dietaryRestrictions.length > 0 ? patientData.dietaryRestrictions.join(', ') : 'Nenhuma'}\n\n=== ESTILO DE VIDA ===\nNÃ­vel de Atividade: ${patientData.activityLevel === 'sedentary' ? 'SedentÃ¡rio' : \n                     patientData.activityLevel === 'light' ? 'Leve' : \n                     patientData.activityLevel === 'moderate' ? 'Moderado' : \n                     patientData.activityLevel === 'active' ? 'Ativo' : \n                     patientData.activityLevel === 'very_active' ? 'Muito Ativo' : \n                     patientData.activityLevel || 'NÃ£o informado'}\nQualidade do Sono: ${patientData.sleepQuality || 'NÃ£o informado'}\nNÃ­vel de Estresse: ${patientData.stressLevel || 'NÃ£o informado'}\nIngestÃ£o de Ãgua: ${patientData.waterIntake || 'NÃ£o informado'}\n` : 'Dados do paciente nÃ£o disponÃ­veis.';\n\n// Montar informaÃ§Ãµes da dieta prescrita\nconst dietInfo = dietPlanData ? `\n=== DIETA PRESCRITA ===\nNome: ${dietPlanData.name || 'Plano Alimentar'}\nDescriÃ§Ã£o: ${dietPlanData.description || 'Sem descriÃ§Ã£o'}\n\nMacros DiÃ¡rios Prescritos:\n- ProteÃ­nas: ${dietPlanData.macros?.protein || dietPlanData.dailyProtein || 0} g\n- Carboidratos: ${dietPlanData.macros?.carbs || dietPlanData.dailyCarbs || 0} g\n- Gorduras: ${dietPlanData.macros?.fats || dietPlanData.dailyFats || 0} g\n- Calorias: ${dietPlanData.macros?.calories || dietPlanData.dailyCalories || dietPlanData.calories || 0} kcal\n\nRefeiÃ§Ãµes Planejadas: ${Array.isArray(dietPlanData.meals) && dietPlanData.meals.length > 0 \n  ? dietPlanData.meals.map(m => `\\n  - ${m.title || m.name || 'RefeiÃ§Ã£o'} (${m.time || ''})`).join('')\n  : 'Nenhuma refeiÃ§Ã£o planejada'}\n` : `\n=== DIETA PRESCRITA ===\nNenhuma dieta prescrita encontrada. Use os dados do perfil do paciente para orientaÃ§Ãµes gerais.\n`;\n\n// Montar contexto de histÃ³rico alimentar (se disponÃ­vel)\nlet historicoContext = '';\nif (temHistorico && historicoFormatado) {\n  const macrosPrescritos = dietPlanData ? {\n    protein: dietPlanData.macros?.protein || dietPlanData.dailyProtein || 0,\n    carbs: dietPlanData.macros?.carbs || dietPlanData.dailyCarbs || 0,\n    fats: dietPlanData.macros?.fats || dietPlanData.dailyFats || 0,\n    calories: dietPlanData.macros?.calories || dietPlanData.dailyCalories || dietPlanData.calories || 0\n  } : null;\n\n  historicoContext = `\n\n=== HISTÃ“RICO ALIMENTAR DO PACIENTE ===\n\n${historicoFormatado}\n\n${summaryMacros ? `\n=== RESUMO DE MACROS CONSUMIDOS ===\n${summaryMacros.date ? `Data: ${summaryMacros.date}` : ''}\n- ProteÃ­nas: ${summaryMacros.protein || 0} g\n- Carboidratos: ${summaryMacros.carbs || 0} g\n- Gorduras: ${summaryMacros.fats || 0} g\n- Calorias: ${summaryMacros.calories || 0} kcal\n` : ''}\n\n${macrosPrescritos ? `\n=== COMPARAÃ‡ÃƒO COM DIETA PRESCRITA ===\nProteÃ­nas: ${summaryMacros?.protein || 0} g consumidas de ${macrosPrescritos.protein} g prescritas (${macrosPrescritos.protein > 0 ? Math.round(((summaryMacros?.protein || 0) / macrosPrescritos.protein) * 100) : 0}%)\nCarboidratos: ${summaryMacros?.carbs || 0} g consumidos de ${macrosPrescritos.carbs} g prescritos (${macrosPrescritos.carbs > 0 ? Math.round(((summaryMacros?.carbs || 0) / macrosPrescritos.carbs) * 100) : 0}%)\nGorduras: ${summaryMacros?.fats || 0} g consumidas de ${macrosPrescritos.fats} g prescritas (${macrosPrescritos.fats > 0 ? Math.round(((summaryMacros?.fats || 0) / macrosPrescritos.fats) * 100) : 0}%)\nCalorias: ${summaryMacros?.calories || 0} kcal consumidas de ${macrosPrescritos.calories} kcal prescritas (${macrosPrescritos.calories > 0 ? Math.round(((summaryMacros?.calories || 0) / macrosPrescritos.calories) * 100) : 0}%)\n` : ''}\n\n=== INSTRUÃ‡Ã•ES PARA RACIOCÃNIO DA IA ===\n\nQuando o paciente perguntar sobre seu histÃ³rico alimentar, vocÃª DEVE:\n\n1. **CALCULAR TOTAIS PRECISOS**: Some exatamente os valores de macros do histÃ³rico fornecido. Use os nÃºmeros EXATOS, nÃ£o invente valores.\n\n2. **COMPARAR COM DIETA PRESCRITA**: Compare os macros consumidos com os macros prescritos. Identifique:\n   - O que estÃ¡ faltando (ex: \"Faltam 30g de proteÃ­na para atingir a meta\")\n   - O que estÃ¡ em excesso (ex: \"VocÃª consumiu 200 kcal a mais que o prescrito\")\n   - O que estÃ¡ adequado\n\n3. **IDENTIFICAR PADRÃ•ES**: Analise o histÃ³rico para identificar:\n   - Alimentos mais frequentes\n   - HorÃ¡rios de refeiÃ§Ãµes\n   - DistribuiÃ§Ã£o de macros ao longo do dia\n   - TendÃªncias (ex: sempre come muito carboidrato no almoÃ§o)\n\n4. **RESPONDER PERGUNTAS ESPECÃFICAS COM CONTEXTO TEMPORAL**: Quando o paciente perguntar:\n   - \"O que comi no almoÃ§o?\" â†’ \n     * Se sÃ£o ${horaFormatada} e o almoÃ§o JÃ PASSOU â†’ Liste EXATAMENTE os alimentos do histÃ³rico do almoÃ§o de hoje\n     * Se sÃ£o ${horaFormatada} e o almoÃ§o AINDA NÃƒO ACONTECEU â†’ Diga: \"Ainda nÃ£o Ã© horÃ¡rio de almoÃ§o! SÃ£o ${horaFormatada}. VocÃª quer saber sobre ${refeicaoEsperada}?\"\n   - \"Quanto falta de proteÃ­na?\" â†’ Calcule: prescrito - consumido = falta (considere apenas refeiÃ§Ãµes que jÃ¡ aconteceram)\n   - \"Quanto comi hoje?\" â†’ Some todos os macros das refeiÃ§Ãµes que JÃ ACONTECERAM hoje (nÃ£o conte refeiÃ§Ãµes futuras)\n   - \"O que comi na semana passada?\" â†’ Liste os alimentos do perÃ­odo solicitado\n   - IMPORTANTE: Sempre considere o horÃ¡rio atual ao responder sobre refeiÃ§Ãµes especÃ­ficas\n\n5. **FORNECER INSIGHTS CONSTRUTIVOS**: Baseado nos dados reais:\n   - Sugira ajustes especÃ­ficos (ex: \"Adicione uma fonte de proteÃ­na no lanche da tarde\")\n   - Destaque pontos positivos (ex: \"VocÃª estÃ¡ consumindo boas quantidades de vegetais\")\n   - Alerte sobre padrÃµes preocupantes (ex: \"VocÃª estÃ¡ consumindo muito aÃ§Ãºcar nos lanches\")\n\n6. **NUNCA INVENTE DADOS**: Se nÃ£o houver informaÃ§Ã£o no histÃ³rico, diga claramente \"NÃ£o encontrei registros sobre isso no seu histÃ³rico\". NÃ£o invente refeiÃ§Ãµes ou valores.\n\nIMPORTANTE: Use APENAS os dados fornecidos no histÃ³rico acima. NÃ£o invente informaÃ§Ãµes que nÃ£o estejam presentes.\n`;\n}\n\n// Montar contexto completo\nconst context = `\nVocÃª Ã© o NutriBuddy, um assistente nutricional inteligente e empÃ¡tico que ajuda pacientes a seguirem suas dietas e alcanÃ§arem seus objetivos de saÃºde.\n\nâš ï¸ REGRA FUNDAMENTAL: Seja RESUMIDO e DIRETO. MÃ¡ximo 3-4 frases por resposta. VÃ¡ direto ao ponto!\n\n${contextoTemporal}\n\n${patientInfo}\n\n${dietInfo}\n\n${historicoContext}\n\n=== HISTÃ“RICO DE CONVERSA ===\n${conversationHistoryText}\n\n=== MENSAGEM ATUAL DO PACIENTE ===\n\"${messageContent}\"\n\n=== INSTRUÃ‡Ã•ES GERAIS ===\n\n1. **CONTEXTO TEMPORAL Ã‰ CRÃTICO**: \n   - SEMPRE considere o horÃ¡rio atual (${horaFormatada}) ao responder\n   - NUNCA pergunte ou assuma que refeiÃ§Ãµes futuras jÃ¡ aconteceram\n   - Se o paciente perguntar sobre uma refeiÃ§Ã£o que ainda nÃ£o aconteceu, explique educadamente que ainda nÃ£o Ã© aquele horÃ¡rio\n   - Exemplo: Se sÃ£o 9h da manhÃ£ e perguntam sobre almoÃ§o â†’ \"Ainda nÃ£o Ã© horÃ¡rio de almoÃ§o! SÃ£o 9h da manhÃ£. VocÃª quer saber sobre o cafÃ© da manhÃ£?\"\n\n2. **RESPOSTAS RESUMIDAS E DIRETAS**: \n   - Seja CONCISO e OBJETIVO\n   - MÃ¡ximo 3-4 frases por resposta\n   - VÃ¡ direto ao ponto\n   - Evite repetiÃ§Ãµes e explicaÃ§Ãµes longas\n   - Use 1-2 emojis apenas quando necessÃ¡rio\n   - Exemplo BOM: \"Ainda nÃ£o Ã© horÃ¡rio de almoÃ§o! SÃ£o 9h da manhÃ£. Quer saber sobre o cafÃ© da manhÃ£? â˜•\"\n   - Exemplo RUIM: \"Oi, Paulo! ðŸ˜Š Pelo que estou vendo aqui, ainda nÃ£o tenho registro do que vocÃª comeu no almoÃ§o hoje. Mas tudo bem! Isso acontece, e Ã© super normal esquecer de anotar de vez em quando. Se quiser, posso te ajudar a registrar agora mesmo...\"\n\n3. **TOM EMPÃTICO E MOTIVADOR**: Seja acolhedor, positivo e encorajador, mas de forma RESUMIDA.\n\n4. **PERSONALIZAÃ‡ÃƒO**: Use os dados do paciente (nome, objetivos, preferÃªncias) para personalizar suas respostas de forma CONCISA.\n\n5. **PRECISÃƒO NUTRICIONAL**: Quando falar sobre macros ou valores nutricionais, use os dados EXATOS do histÃ³rico e dieta prescrita. Seja DIRETO com os nÃºmeros.\n\n6. **ORIENTAÃ‡Ã•ES PRÃTICAS**: ForneÃ§a sugestÃµes concretas e acionÃ¡veis, mas de forma RESUMIDA (1-2 frases).\n\n7. **RESPEITO Ã€S RESTRIÃ‡Ã•ES**: Sempre considere alergias, restriÃ§Ãµes alimentares e preferÃªncias do paciente.\n\n8. **MOTIVAÃ‡ÃƒO**: ReconheÃ§a esforÃ§os e progressos de forma BREVE (1 frase).\n\n9. **CLAREZA**: Explique conceitos nutricionais de forma simples e DIRETA.\n\nâš ï¸ REGRA DE OURO: Se vocÃª conseguir dizer em 2 frases, NÃƒO use 5. Seja DIRETO e OBJETIVO.\n\nAnalise a mensagem do paciente e responda de forma RESUMIDA e apropriada, considerando TODO o contexto fornecido acima.\n`;\n\n// Montar payload para a IA\nconst aiPayload = {\n  model: 'gpt-4o',\n  messages: [\n    {\n      role: 'system',\n      content: context\n    },\n    {\n      role: 'user',\n      content: messageContent\n    }\n  ],\n  temperature: 0.7,\n  max_tokens: 500, // Reduzido para forÃ§ar respostas mais curtas\n  response_format: {\n    type: 'json_schema',\n    json_schema: {\n      name: 'nutribuddy_response',\n      strict: true,\n      schema: {\n        type: 'object',\n        properties: {\n          categoria: {\n            type: 'string',\n            enum: ['consulta_historico', 'registro_refeicao', 'duvida_nutricional', 'motivacao', 'outro']\n          },\n          resposta: {\n            type: 'string',\n            description: 'Resposta RESUMIDA e DIRETA para o paciente (mÃ¡ximo 3-4 frases, seja conciso)'\n          },\n          acao: {\n            type: 'string',\n            enum: ['nenhuma', 'registrar_refeicao', 'buscar_historico', 'esclarecer_duvida'],\n            description: 'AÃ§Ã£o que deve ser tomada apÃ³s a resposta'\n          },\n          alimentos: {\n            type: 'array',\n            items: {\n              type: 'object',\n              properties: {\n                nome: { type: 'string' },\n                quantidade: { type: 'string' },\n                macros: {\n                  type: 'object',\n                  properties: {\n                    protein: { type: 'number' },\n                    carbs: { type: 'number' },\n                    fats: { type: 'number' },\n                    calories: { type: 'number' }\n                  }\n                }\n              }\n            },\n            description: 'Lista de alimentos mencionados (se houver)'\n          }\n        },\n        required: ['categoria', 'resposta', 'acao']\n      }\n    }\n  }\n};\n\nreturn {\n  json: {\n    patientId,\n    prescriberId,\n    conversationId,\n    messageContent,\n    senderRole,\n    context,\n    aiPayload,\n    hasPatientData: !!patientData,\n    hasDietPlan: !!dietPlanData,\n    hasHistory: temHistorico\n  }\n};\n"
      },
      "id": "6de4729c-6ca7-4539-9f0e-9027799903b9",
      "name": "6. Construir Contexto IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        27168,
        -192
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "GPT-4.1-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.context }}"
            }
          ]
        },
        "options": {
          "maxTokens": 800,
          "temperature": 0.7
        }
      },
      "id": "aefdce0b-70b3-4d69-9231-2d90dba94177",
      "name": "7. AnÃ¡lise IA (OpenAI)",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.3,
      "position": [
        27616,
        -192
      ],
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse resposta da IA\nconst currentItem = $('6. Construir Contexto IA').first().json;\nconst aiResponse = $input.first().json.message?.content || $input.first().json.text || '{}';\n\nconsole.log('=== RESPOSTA IA ===');\nconsole.log(aiResponse);\n\nlet parsed;\ntry {\n  const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    parsed = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('JSON nÃ£o encontrado');\n  }\n} catch (error) {\n  console.error('Erro ao fazer parse:', error);\n  parsed = {\n    urgencia: 'baixa',\n    sentimento: 'neutro',\n    categoria: 'duvida_alimentacao',\n    deve_responder: true,\n    resposta: aiResponse\n  };\n}\n\nreturn {\n  json: {\n    ...currentItem,\n    urgencia: parsed.urgencia || 'baixa',\n    sentimento: parsed.sentimento || 'neutro',\n    categoria: parsed.categoria || 'duvida_alimentacao',\n    deve_responder: parsed.deve_responder !== false,\n    resposta: parsed.resposta || aiResponse\n  }\n};"
      },
      "id": "32ca693f-55ef-4fa0-83f5-e561cf5b2286",
      "name": "8. Parse AnÃ¡lise IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        27968,
        -192
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "99b4b2d4-2840-4905-8650-d17c0ef2409e",
              "leftValue": "={{ $json.deve_responder }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d3ebc941-d43a-43ed-97c3-87517f3675b7",
      "name": "9. Deve Responder?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        28192,
        -192
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "senderId",
              "value": "={{ $json.prescriberId }}"
            },
            {
              "name": "senderRole",
              "value": "prescriber"
            },
            {
              "name": "content",
              "value": "={{ $json.resposta }}"
            },
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "isAiGenerated",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "id": "d675ccc6-aaa6-483a-9cf1-8b3dde81dfaa",
      "name": "10. Enviar Auto-resposta",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        28416,
        -464
      ]
    },
    {
      "parameters": {},
      "id": "23390f23-fda2-4b29-ba41-24044311d4a8",
      "name": "NÃ£o Responder",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        28416,
        -96
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, processed: true, urgencia: $json.urgencia, categoria: $json.categoria, respondeu: $json.deve_responder } }}",
        "options": {}
      },
      "id": "00bbfcc6-354d-497e-8d05-4598bfe4f857",
      "name": "12. Responder: Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        32128,
        -656
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "85fc6bde-3b94-45e0-85ab-5db7c2e12be9",
              "leftValue": "={{ $json._photoPriority }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "25b7be60-a502-436f-b1ae-21928cab0076",
      "name": "3. TEM FOTO?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        23680,
        -656
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "c6eba851-90fa-480b-bccf-7f607dfc7c95",
      "name": "4a. Buscar Conversa (FOTO)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        23904,
        -800
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/patients/{{ $('1. Validar e Processar' ).first().json.patientId }}/diet\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "ea5918df-758c-42d5-ac91-9687af03ff69",
      "name": "5a. Buscar Dieta (FOTO)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        24352,
        -720
      ]
    },
    {
      "parameters": {
        "url": "={{ $('1. Validar e Processar').first().json.attachments?.[0]?.url || $('1. Validar e Processar').first().json.mediaUrl || $('1. Validar e Processar').first().json.imageUrl }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "d5d5a6e1-80f5-4763-8a9e-9be73dd53bec",
      "name": "6a-1. Baixar Imagem",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        26048,
        -720
      ]
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 6a-2. CONVERTER PARA BASE64 - V4 (FIX FILESYSTEM-V2)\n// =====================================================\n// CompatÃ­vel com N8N v1.0+ que usa filesystem para binÃ¡rios\n// =====================================================\n\nconst inputItem = $input.first();\n\nconsole.log('=== DEBUG 6a-2 V4 ===');\nconsole.log('Has binary?', !!inputItem.binary);\nconsole.log('Binary keys:', inputItem.binary ? Object.keys(inputItem.binary) : 'none');\n\n// MÃ©todo principal: Usar helper do N8N para binary\nif (inputItem.binary && Object.keys(inputItem.binary).length > 0) {\n  const imageKey = Object.keys(inputItem.binary)[0];\n  const binaryData = inputItem.binary[imageKey];\n  \n  console.log('Binary data type:', typeof binaryData.data);\n  console.log('Binary data preview:', String(binaryData.data).substring(0, 50));\n  \n  // Se data Ã© uma string vÃ¡lida de base64 (nÃ£o filesystem-v2)\n  if (binaryData.data && \n      typeof binaryData.data === 'string' && \n      binaryData.data.length > 100 && \n      !binaryData.data.includes('filesystem')) {\n    \n    console.log('âœ… MÃ©todo A: Base64 direto do binary');\n    return {\n      json: {\n        imageBase64: binaryData.data,\n        mimeType: binaryData.mimeType || 'image/jpeg',\n        fileName: binaryData.fileName || 'image.jpg'\n      }\n    };\n  }\n  \n  // Se estÃ¡ usando filesystem-v2, precisamos buscar de outro jeito\n  // O N8N moderno armazena no filesystem e o .data Ã© sÃ³ uma referÃªncia\n  console.log('âš ï¸ Detectado filesystem-v2, tentando fallback...');\n  \n  // Tentar acessar o buffer diretamente se disponÃ­vel\n  try {\n    // Em alguns casos, o binary pode estar no formato Buffer\n    if (Buffer.isBuffer(binaryData.data)) {\n      console.log('âœ… MÃ©todo B: Buffer.isBuffer');\n      return {\n        json: {\n          imageBase64: binaryData.data.toString('base64'),\n          mimeType: binaryData.mimeType || 'image/jpeg',\n          fileName: binaryData.fileName || 'image.jpg'\n        }\n      };\n    }\n  } catch (e) {\n    console.log('Buffer check failed:', e.message);\n  }\n}\n\n// Fallback: Verificar se existe imageUrl no input anterior\nconst prevData = inputItem.json;\n\n// Se temos uma URL da imagem, podemos retornar para o nÃ³ usar HTTP Request\nif (prevData && (prevData.mediaUrl || prevData.imageUrl)) {\n  const imageUrl = prevData.mediaUrl || prevData.imageUrl;\n  console.log('âš ï¸ Fallback: Retornando URL para download direto');\n  console.log('URL:', imageUrl.substring(0, 80) + '...');\n  \n  return {\n    json: {\n      imageBase64: null,\n      imageUrl: imageUrl,\n      mimeType: 'image/jpeg',\n      fileName: 'image.jpg',\n      needsDownload: true,\n      _warning: 'Base64 nÃ£o disponÃ­vel, usar URL para GPT Vision'\n    }\n  };\n}\n\n// Verificar se dados vieram do nÃ³ anterior\nif (prevData) {\n  // Tentar pegar base64 que pode ter vindo de outro lugar\n  if (prevData.imageBase64 && prevData.imageBase64.length > 100) {\n    console.log('âœ… MÃ©todo C: imageBase64 do JSON anterior');\n    return {\n      json: {\n        imageBase64: prevData.imageBase64,\n        mimeType: prevData.mimeType || 'image/jpeg',\n        fileName: prevData.fileName || 'image.jpg'\n      }\n    };\n  }\n}\n\n// Ãšltimo recurso: Tentar usar o $binary helper do N8N se disponÃ­vel\ntry {\n  const binaryKeys = Object.keys(inputItem.binary || {});\n  if (binaryKeys.length > 0) {\n    const binaryItem = inputItem.binary[binaryKeys[0]];\n    // Alguns mÃ©todos de acesso ao binÃ¡rio no N8N moderno\n    console.log('Tentando mÃ©todo alternativo N8N...');\n    console.log('binaryItem keys:', Object.keys(binaryItem));\n    \n    // Retornar o que temos para debug\n    return {\n      json: {\n        imageBase64: null,\n        mimeType: binaryItem.mimeType || 'image/jpeg',\n        fileName: binaryItem.fileName || 'image.jpg',\n        _error: 'N8N filesystem-v2 detected - base64 not directly accessible',\n        _debug: {\n          dataType: typeof binaryItem.data,\n          dataPreview: String(binaryItem.data).substring(0, 100),\n          keys: Object.keys(binaryItem)\n        }\n      }\n    };\n  }\n} catch (e) {\n  console.log('Error:', e.message);\n}\n\n// Falhou completamente\nconsole.log('âŒ Nenhum mÃ©todo funcionou');\nreturn {\n  json: {\n    imageBase64: null,\n    mimeType: null,\n    fileName: null,\n    error: 'NÃ£o foi possÃ­vel extrair imagem - filesystem-v2 incompatÃ­vel',\n    debug: {\n      hasBinary: !!inputItem.binary,\n      jsonType: typeof prevData,\n      jsonKeys: prevData ? Object.keys(prevData).slice(0, 10) : []\n    }\n  }\n};\n"
      },
      "id": "48f61304-a7ff-4ddc-a15e-865603cb60a2",
      "name": "6a-2. Converter para Base64",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        26272,
        -720
      ]
    },
    {
      "parameters": {
        "jsCode": "// =============================================================================\n// 8a. COMPARAR COM DIETA - VERSÃƒO CORRIGIDA\n// =============================================================================\n// PROBLEMA ANTERIOR: O cÃ³digo buscava dados do '7a. PARSE-PASSIO' diretamente,\n// ignorando as correÃ§Ãµes feitas pelo '7e-3. Aplicar Dados API'.\n//\n// CORREÃ‡ÃƒO: Agora usa $input.first().json que contÃ©m os dados jÃ¡ corrigidos\n// (seja do 7e-3 ou do 7d-IF quando nÃ£o tem embalagem).\n// =============================================================================\n\n// âœ… CORREÃ‡ÃƒO: Usar o INPUT (que vem do 7e-3 ou 7d-IF)\nconst parseData = $input.first().json;\n\n// Buscar dados da dieta e conversa\nconst dietResponse = $('5a. Buscar Dieta (FOTO)').first().json || {};\nconst conversation = $('4a. Buscar Conversa (FOTO)').first().json || {};\n\nconsole.log('=== COMPARANDO COM DIETA/MACROS ===');\nconsole.log('parseData fonte:', parseData.fonte_dados || 'passio');\n\n// Extrair anÃ¡lise da foto (JÃ CORRIGIDA pelo 7e-3 se passou por lÃ¡)\nconst analysisData = parseData.analise_foto || { alimentos: [], macros_totais: {} };\nconst identifiedFoods = analysisData.alimentos || [];\n\nconsole.log('identifiedFoods:', identifiedFoods.length);\nconsole.log('alimentos:', JSON.stringify(identifiedFoods, null, 2));\n\n// Extrair dados da dieta\nconst dietData = dietResponse.data || {};\nconst hasDiet = dietData.meals && Array.isArray(dietData.meals) && dietData.meals.length > 0;\nconst dietSource = hasDiet ? 'prescribed' : 'profile';\n\nconsole.log('hasDiet:', hasDiet);\nconsole.log('dietSource:', dietSource);\n\nlet comparisonResult = {\n  dietSource: dietSource,\n  totalFoods: identifiedFoods.length,\n  approvedFoods: [],\n  unapprovedFoods: [],\n  adherencePercentage: 0,\n  totalMacros: analysisData.macros_totais || {\n    proteinas: 0,\n    carboidratos: 0,\n    gorduras: 0,\n    calorias: 0\n  },\n  dailyMacros: {\n    protein: dietData.dailyProtein || 0,\n    carbs: dietData.dailyCarbs || 0,\n    fats: dietData.dailyFats || 0,\n    calories: dietData.dailyCalories || 0\n  }\n};\n\nconsole.log('totalMacros:', comparisonResult.totalMacros);\nconsole.log('dailyMacros:', comparisonResult.dailyMacros);\n\n// Se tem dieta prescrita com refeiÃ§Ãµes especÃ­ficas\nif (dietSource === 'prescribed' && dietData.meals && dietData.meals.length > 0) {\n  console.log('ðŸ“‹ Comparando com dieta prescrita (refeiÃ§Ãµes especÃ­ficas)');\n  \n  // Extrair todos os alimentos da dieta\n  const dietFoods = [];\n  dietData.meals.forEach(meal => {\n    if (meal.foods && Array.isArray(meal.foods)) {\n      meal.foods.forEach(food => {\n        const foodName = food.name || food.nome || '';\n        if (foodName) {\n          dietFoods.push(foodName.toLowerCase().trim());\n        }\n      });\n    }\n  });\n  \n  console.log('Alimentos na dieta:', dietFoods);\n  \n  // Comparar cada alimento identificado\n  identifiedFoods.forEach(food => {\n    const foodName = (food.nome || '').toLowerCase().trim();\n    const isApproved = dietFoods.some(dietFood => \n      foodName.includes(dietFood) || dietFood.includes(foodName)\n    );\n    \n    if (isApproved) {\n      comparisonResult.approvedFoods.push(food.nome);\n    } else {\n      comparisonResult.unapprovedFoods.push(food.nome);\n    }\n  });\n  \n  // Calcular aderÃªncia\n  if (comparisonResult.totalFoods > 0) {\n    comparisonResult.adherencePercentage = Math.round(\n      (comparisonResult.approvedFoods.length / comparisonResult.totalFoods) * 100\n    );\n  }\n  \n} else if (dietSource === 'profile') {\n  console.log('ðŸ‘¤ Usando macros do perfil (sem refeiÃ§Ãµes especÃ­ficas)');\n  \n  // Quando nÃ£o tem dieta especÃ­fica, nÃ£o podemos comparar alimentos\n  // Mas podemos comparar macros da refeiÃ§Ã£o com macros diÃ¡rios\n  comparisonResult.approvedFoods = identifiedFoods.map(f => f.nome);\n  comparisonResult.unapprovedFoods = [];\n  comparisonResult.adherencePercentage = 100; // NÃ£o hÃ¡ lista para comparar\n  \n  // Adicionar anÃ¡lise de macros\n  const mealProtein = comparisonResult.totalMacros.proteinas || 0;\n  const mealCarbs = comparisonResult.totalMacros.carboidratos || 0;\n  const mealFats = comparisonResult.totalMacros.gorduras || 0;\n  const mealCalories = comparisonResult.totalMacros.calorias || 0;\n  \n  const dailyProtein = comparisonResult.dailyMacros.protein || 0;\n  const dailyCarbs = comparisonResult.dailyMacros.carbs || 0;\n  const dailyFats = comparisonResult.dailyMacros.fats || 0;\n  const dailyCalories = comparisonResult.dailyMacros.calories || 0;\n  \n  // Calcular % do dia que essa refeiÃ§Ã£o representa\n  comparisonResult.macrosPercentage = {\n    protein: dailyProtein > 0 ? Math.round((mealProtein / dailyProtein) * 100) : 0,\n    carbs: dailyCarbs > 0 ? Math.round((mealCarbs / dailyCarbs) * 100) : 0,\n    fats: dailyFats > 0 ? Math.round((mealFats / dailyFats) * 100) : 0,\n    calories: dailyCalories > 0 ? Math.round((mealCalories / dailyCalories) * 100) : 0\n  };\n  \n  console.log('Macros da refeiÃ§Ã£o vs diÃ¡rios:', comparisonResult.macrosPercentage);\n}\n\nconsole.log('âœ… ComparaÃ§Ã£o concluÃ­da');\nconsole.log('AderÃªncia:', comparisonResult.adherencePercentage + '%');\nconsole.log('Aprovados:', comparisonResult.approvedFoods.length);\nconsole.log('NÃ£o aprovados:', comparisonResult.unapprovedFoods.length);\n\nreturn {\n  json: {\n    ...parseData,\n    comparison: comparisonResult,\n    analysisData: analysisData\n  }\n};"
      },
      "id": "bbbd949a-437b-4e3f-bca9-df0fb37ac864",
      "name": "8a. Comparar com Dieta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        29088,
        -720
      ]
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 9a. CONSTRUIR CONTEXTO RESPOSTA (V4 - COM REFLEXÃƒO)\n// =====================================================\n// NOVIDADE: Integra o contexto de reflexÃ£o inteligente\n// para garantir consistÃªncia e evitar contradiÃ§Ãµes\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst dietResponse = $('5a. Buscar Dieta (FOTO)').first().json || {};\n\n// =====================================================\n// ðŸ§  PEGAR DADOS DA REFLEXÃƒO INTELIGENTE\n// =====================================================\n\nlet dadosReflexao = {};\ntry {\n  dadosReflexao = $('ReflexÃ£o Inteligente').first().json || {};\n} catch (e) {\n  console.log('âš ï¸ ReflexÃ£o nÃ£o disponÃ­vel, usando dados diretos');\n  dadosReflexao = currentItem;\n}\n\n// Contexto de reflexÃ£o (se disponÃ­vel)\nconst contextoReflexao = dadosReflexao._contextoReflexao || '';\nconst valoresDefinitivos = dadosReflexao._valoresDefinitivos || {};\nconst alertas = dadosReflexao._alertas || [];\nconst reflexaoInfo = dadosReflexao._reflexao || {};\n\nconsole.log('ðŸ§  ReflexÃ£o:', reflexaoInfo.decisao?.acao || 'nÃ£o disponÃ­vel');\nconsole.log('ðŸ§  Usou histÃ³rico:', dadosReflexao._usouHistorico ? 'SIM' : 'NÃƒO');\n\n// =====================================================\n// PEGAR DADOS DA ANÃLISE\n// =====================================================\n\nconst analiseData = currentItem.analysisData || currentItem.analise_foto || {};\nconst alimentosAnalisados = analiseData.alimentos || [];\n\n// USAR VALORES DEFINITIVOS (da reflexÃ£o) ou calcular\nlet macrosFinal = valoresDefinitivos.calorias ? valoresDefinitivos : (analiseData.macros_totais || {});\n\n// Verificar recordatÃ³rio hÃ­brido\nlet recordatorio = {};\ntry {\n  recordatorio = $('1. Validar e Processar').first().json.recordatorio || {};\n} catch (e) {}\nconst textoDescritivo = recordatorio.textoDescritivo || '';\nconst ehHibrido = recordatorio.ehHibrido || false;\n\nconsole.log('ðŸ“Š Macros finais:', macrosFinal);\n\n// =====================================================\n// EXTRAIR DADOS DA DIETA\n// =====================================================\n\nconst dietPlan = dietResponse.data || {};\nconst hasDiet = dietPlan.meals && Array.isArray(dietPlan.meals) && dietPlan.meals.length > 0;\n\nconst dailyMacros = dietPlan.macros || {};\nconst dailyCalories = dailyMacros.calories || dietPlan.dailyCalories || 0;\nconst dailyProtein = dailyMacros.protein || dietPlan.dailyProtein || 0;\n\n// =====================================================\n// FORMATAR ALIMENTOS\n// =====================================================\n\nlet listaAlimentos = '';\nif (alimentosAnalisados.length > 0) {\n  listaAlimentos = alimentosAnalisados.map(food => {\n    const nome = food.nome || food.name || 'Alimento';\n    const peso = food.peso_gramas || food.weight || 0;\n    const macros = food.macros || {};\n    const p = Math.round(macros.proteinas || macros.protein || 0);\n    const c = Math.round(macros.carboidratos || macros.carbs || 0);\n    const g = Math.round(macros.gorduras || macros.fats || 0);\n    const cal = Math.round(macros.calorias || macros.calories || 0);\n    \n    let emoji = 'ðŸ½ï¸';\n    const nomeLower = nome.toLowerCase();\n    if (nomeLower.includes('ovo')) emoji = 'ðŸ¥š';\n    else if (nomeLower.includes('frango')) emoji = 'ðŸ—';\n    else if (nomeLower.includes('queijo')) emoji = 'ðŸ§€';\n    else if (nomeLower.includes('tapioca') || nomeLower.includes('crepioca')) emoji = 'ðŸ¥ž';\n    else if (nomeLower.includes('arroz')) emoji = 'ðŸš';\n    else if (nomeLower.includes('feijÃ£o')) emoji = 'ðŸ«˜';\n    else if (nomeLower.includes('carne')) emoji = 'ðŸ¥©';\n    else if (nomeLower.includes('salada')) emoji = 'ðŸ¥—';\n    else if (nomeLower.includes('banana')) emoji = 'ðŸŒ';\n    \n    return `${emoji} ${peso > 0 ? peso + 'g ' : ''}${nome} (${p}g P | ${c}g C | ${g}g G | ${cal} kcal)`;\n  }).join('\\n');\n}\n\n// =====================================================\n// TOTAIS (usando valores definitivos da reflexÃ£o)\n// =====================================================\n\nconst totalP = Math.round(macrosFinal.proteinas || macrosFinal.protein || 0);\nconst totalC = Math.round(macrosFinal.carboidratos || macrosFinal.carbs || 0);\nconst totalG = Math.round(macrosFinal.gorduras || macrosFinal.fats || 0);\nconst totalCal = Math.round(macrosFinal.calorias || macrosFinal.calories || 0);\n\n// =====================================================\n// DETERMINAR TIPO DE REFEIÃ‡ÃƒO\n// =====================================================\n\nconst brazilTime = new Date().toLocaleString(\"en-US\", { timeZone: \"America/Sao_Paulo\" });\nconst now = new Date(brazilTime);\nconst hour = now.getHours();\nlet mealType = \"refeiÃ§Ã£o\";\nif (hour >= 5 && hour < 11) mealType = 'cafÃ© da manhÃ£';\nelse if (hour >= 11 && hour < 15) mealType = 'almoÃ§o';\nelse if (hour >= 15 && hour < 18) mealType = 'lanche';\nelse if (hour >= 18 && hour < 22) mealType = 'jantar';\nelse mealType = 'ceia';\n\n// =====================================================\n// CONSTRUIR PROMPT COM REFLEXÃƒO\n// =====================================================\n\nconst context = `\nVocÃª Ã© o NutriBuddy, assistente de nutriÃ§Ã£o inteligente.\n\n${contextoReflexao || ''}\n\n${alertas.length > 0 ? `\nâš ï¸ ALERTAS DA REFLEXÃƒO:\n${alertas.map(a => `â€¢ ${a.tipo}: ${a.mensagem || JSON.stringify(a.dados)}`).join('\\n')}\n` : ''}\n\n=== DADOS PARA A RESPOSTA (USE ESTES EXATAMENTE!) ===\n\nðŸ“Š ALIMENTOS:\n${listaAlimentos || 'Nenhum alimento identificado'}\n\nðŸ“Š TOTAIS (OBRIGATÃ“RIO USAR ESTES VALORES):\n- Calorias: ${totalCal} kcal\n- ProteÃ­na: ${totalP}g\n- Carboidratos: ${totalC}g\n- Gorduras: ${totalG}g\n\n${dailyCalories > 0 ? `\nðŸ“‹ METAS DIÃRIAS:\n- Calorias: ${dailyCalories} kcal\n- ProteÃ­nas: ${dailyProtein}g\n\nðŸ“ˆ ESTA REFEIÃ‡ÃƒO REPRESENTA:\n- ${Math.round((totalCal / dailyCalories) * 100)}% das calorias diÃ¡rias\n` : ''}\n\n${ehHibrido && textoDescritivo ? `\nðŸ“ DESCRIÃ‡ÃƒO DO PACIENTE: \"${textoDescritivo}\"\n` : ''}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸŽ¯ FORMATO DA RESPOSTA:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n---PARTE1---\nâœ… RefeiÃ§Ã£o registrada no diÃ¡rio!\n\n${listaAlimentos || '[lista de alimentos]'}\n\nðŸ“Š Total: ${totalP}g P | ${totalC}g C | ${totalG}g G | ${totalCal} kcal\n---FIM1---\n\n---PARTE2---\n${dailyCalories > 0 ? \n  `ðŸ“‹ Esta ${mealType} representa ${Math.round((totalCal / dailyCalories) * 100)}% das suas calorias diÃ¡rias.` : \n  `ðŸ’¡ Para acompanhamento personalizado, regularize sua assinatura.`}\n---FIM2---\n\n---PARTE3---\n[Feedback motivacional curto - mÃ¡ximo 1 frase]\n\nAlgo errado? Me avise que eu corrijo!\n---FIM3---\n\nâš ï¸ REGRAS CRÃTICAS:\n1. USE EXATAMENTE: ${totalCal} kcal, ${totalP}g P, ${totalC}g C, ${totalG}g G\n2. NÃƒO calcule outros valores - confie nos valores fornecidos\n3. NÃƒO peÃ§a confirmaÃ§Ã£o se o paciente jÃ¡ deu as informaÃ§Ãµes\n4. Seja DIRETO e CONCISO (mÃ¡ximo 3-4 frases no total)\n5. Se a reflexÃ£o indicou usar histÃ³rico, MANTENHA consistÃªncia\n`;\n\nreturn {\n  json: {\n    ...currentItem,\n    context: context,\n    _macrosUsados: { proteinas: totalP, carboidratos: totalC, gorduras: totalG, calorias: totalCal },\n    _usouReflexao: !!contextoReflexao,\n    _decisaoReflexao: reflexaoInfo.decisao?.acao\n  }\n};\n"
      },
      "id": "3b70c492-7d1a-4968-943c-85ecd100001b",
      "name": "9a. Construir Contexto Resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        30432,
        -720
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.context }}"
            }
          ]
        },
        "options": {
          "maxTokens": 500,
          "temperature": 0.7
        }
      },
      "id": "d0b600d4-cb2c-4c8d-8df9-47eff2ba1849",
      "name": "10a. IA Gera Resposta",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.3,
      "position": [
        30656,
        -720
      ],
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse resposta final da IA\nconst currentItem = $('9a. Construir Contexto Resposta').first().json;\nconst aiResponse = $input.first().json.message?.content || $input.first().json.text || '{}';\n\nconsole.log('=== RESPOSTA FINAL IA ===');\nconsole.log(aiResponse);\n\nlet parsed;\ntry {\n  // Remover markdown\n  let jsonText = aiResponse.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  \n  const jsonMatch = jsonText.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    parsed = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('JSON nÃ£o encontrado');\n  }\n} catch (error) {\n  console.error('Erro ao fazer parse da resposta:', error);\n  parsed = {\n    urgencia: 'baixa',\n    sentimento: 'positivo',\n    categoria: 'analise_refeicao',\n    deve_responder: true,\n    resposta: aiResponse\n  };\n}\n\nreturn {\n  json: {\n    ...currentItem,\n    urgencia: parsed.urgencia || 'baixa',\n    sentimento: parsed.sentimento || 'positivo',\n    categoria: parsed.categoria || 'analise_refeicao',\n    deve_responder: parsed.deve_responder !== false,\n    resposta: parsed.resposta || aiResponse\n  }\n};\n"
      },
      "id": "1a44b9bd-0894-461c-a0ae-a605a369c966",
      "name": "11a. Parse Resposta Final",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        31008,
        -720
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"senderId\": \"{{ $json.senderId }}\",\n  \"senderRole\": \"{{ $json.senderRole }}\",\n  \"content\": {{ JSON.stringify($json.content) }},\n  \"type\": \"{{ $json.type || 'text' }}\",\n  \"isAiGenerated\": true\n}",
        "options": {}
      },
      "id": "d534b8d6-159d-4713-b96b-eef5f89e46f2",
      "name": "12a. Enviar Resposta (FOTO)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        31904,
        -720
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/patients/{{ $json.patientId }}/profile-macros",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "48268b9a-61a6-4fae-b3f9-418ca1969e90",
      "name": "5b. Buscar Macros Perfil (FALLBACK)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        25376,
        -624
      ]
    },
    {
      "parameters": {
        "jsCode": "// Verificar se tem dieta prescrita ou usar macros do perfil\nconst dietResponse = $input.first().json;\n\nconsole.log('=== VERIFICANDO DIETA ===');\nconsole.log('Diet response:', JSON.stringify(dietResponse, null, 2));\n\n// Verificar se tem dieta ativa\nconst hasDiet = dietResponse.data && \n                dietResponse.data.meals && \n                Array.isArray(dietResponse.data.meals) && \n                dietResponse.data.meals.length > 0;\n\nconsole.log('Has diet?', hasDiet);\n\nreturn {\n  json: {\n    hasDiet: hasDiet,\n    dietData: dietResponse.data || {}\n  }\n};\n"
      },
      "id": "e94d1bcc-4507-409c-964e-389c5743e740",
      "name": "5c. Tem Dieta Prescrita?",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        24864,
        -720
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasDiet }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "9895f9da-6ee2-4411-b0b6-cb03a987e3ce",
      "name": "5d. IF: Tem Dieta?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        25152,
        -720
      ]
    },
    {
      "parameters": {
        "jsCode": "// Usar dieta prescrita\nconst currentItem = $('1. Validar e Processar').first().json;\nconst dietData = $input.first().json.dietData;\n\nconsole.log('=== USANDO DIETA PRESCRITA ===');\n\nreturn {\n  json: {\n    ...currentItem,\n    dietSource: 'prescribed',\n    dietPlan: {\n      name: dietData.name || 'Dieta Prescrita',\n      description: dietData.description || '',\n      meals: dietData.meals || [],\n      dailyProtein: dietData.macros?.protein || 0,\n      dailyCarbs: dietData.macros?.carbs || 0,\n      dailyFats: dietData.macros?.fats || 0,\n      dailyCalories: dietData.macros?.calories || 0\n    }\n  }\n};\n"
      },
      "id": "20f8257d-b2bd-4d90-bc1a-159f19389cd6",
      "name": "5e. Usar Dieta Prescrita",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        25600,
        -816
      ]
    },
    {
      "parameters": {
        "jsCode": "// Usar macros do perfil (fallback)\nconst currentItem = $('1. Validar e Processar').first().json;\nconst profileResponse = $('5b. Buscar Macros Perfil (FALLBACK)').first().json;\n\nconsole.log('=== USANDO MACROS DO PERFIL (FALLBACK) ===');\nconsole.log('Profile response:', JSON.stringify(profileResponse, null, 2));\n\nconst profileData = profileResponse.data || {};\n\nreturn {\n  json: {\n    ...currentItem,\n    dietSource: 'profile',\n    dietPlan: {\n      name: profileData.name || 'Macros do Perfil',\n      description: profileData.description || 'Macronutrientes baseados no perfil do paciente',\n      meals: [], // Sem refeiÃ§Ãµes especÃ­ficas\n      dailyProtein: profileData.macros?.protein || 0,\n      dailyCarbs: profileData.macros?.carbs || 0,\n      dailyFats: profileData.macros?.fats || 0,\n      dailyCalories: profileData.macros?.calories || 0,\n      patientInfo: profileData.patientInfo || {}\n    }\n  }\n};\n"
      },
      "id": "fff667c3-0dbe-499a-9509-50715f206a24",
      "name": "5f. Usar Macros do Perfil",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        25600,
        -624
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}/context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "df836790-7cf1-454e-95ed-6f0d46afafc8",
      "name": "FASE2: 2. Buscar Contexto Ativo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        24352,
        1008
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasContext }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "c83a803c-e956-4f7e-96dd-d13db713013b",
      "name": "FASE2: 3. Tem Contexto Ativo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        24576,
        1008
      ]
    },
    {
      "parameters": {
        "jsCode": "// Processar adiÃ§Ã£o de novo alimento\nconst currentItem = $input.first().json;\nconst context = currentItem.context;\nconst userMessage = currentItem.intention.userMessage;\n\nconsole.log('Processando adiÃ§Ã£o:', userMessage);\n\n// Extrair alimento e peso da mensagem\nconst numbers = userMessage.match(/\\d+/g);\nconst weight = numbers && numbers.length > 0 ? parseInt(numbers[0]) : 100;\n\n// Tentar identificar o alimento\nlet foodName = 'Alimento adicional';\nconst commonFoods = {\n  'arroz': { protein: 0.026, carbs: 0.28, fats: 0.003, calories: 1.3 },\n  'feijÃ£o': { protein: 0.09, carbs: 0.23, fats: 0.005, calories: 1.27 },\n  'frango': { protein: 0.31, carbs: 0, fats: 0.036, calories: 1.65 },\n  'carne': { protein: 0.26, carbs: 0, fats: 0.15, calories: 2.5 },\n  'peixe': { protein: 0.22, carbs: 0, fats: 0.05, calories: 1.2 },\n  'salada': { protein: 0.01, carbs: 0.03, fats: 0.002, calories: 0.2 },\n  'batata': { protein: 0.02, carbs: 0.17, fats: 0.001, calories: 0.77 },\n  'macarrÃ£o': { protein: 0.05, carbs: 0.25, fats: 0.009, calories: 1.31 }\n};\n\nlet macrosPer100g = { protein: 0.05, carbs: 0.25, fats: 0.02, calories: 1.5 };\n\nfor (const [food, macros] of Object.entries(commonFoods)) {\n  if (userMessage.includes(food)) {\n    foodName = food.charAt(0).toUpperCase() + food.slice(1);\n    macrosPer100g = macros;\n    break;\n  }\n}\n\n// Calcular macros do novo alimento\nconst newFood = {\n  name: foodName,\n  weight: weight,\n  macros: {\n    protein: Math.round(weight * macrosPer100g.protein * 10) / 10,\n    carbs: Math.round(weight * macrosPer100g.carbs * 10) / 10,\n    fats: Math.round(weight * macrosPer100g.fats * 10) / 10,\n    calories: Math.round(weight * macrosPer100g.calories)\n  }\n};\n\n// Adicionar ao contexto\nconst updatedFoods = [...context.data.foods, newFood];\n\n// Recalcular totais\nconst totalMacros = updatedFoods.reduce((acc, food) => ({\n  protein: acc.protein + food.macros.protein,\n  carbs: acc.carbs + food.macros.carbs,\n  fats: acc.fats + food.macros.fats,\n  calories: acc.calories + food.macros.calories\n}), { protein: 0, carbs: 0, fats: 0, calories: 0 });\n\nreturn {\n  json: {\n    conversationId: currentItem.conversationId,\n    action: 'update',\n    contextUpdate: {\n      data: {\n        ...context.data,\n        foods: updatedFoods,\n        totalMacros: {\n          protein: Math.round(totalMacros.protein * 10) / 10,\n          carbs: Math.round(totalMacros.carbs * 10) / 10,\n          fats: Math.round(totalMacros.fats * 10) / 10,\n          calories: Math.round(totalMacros.calories)\n        }\n      }\n    },\n    responseMessage: `Ã“timo! Adicionei ${foodName} (${weight}g) Ã  sua refeiÃ§Ã£o. \n\nðŸ“Š Novo total:\n- ProteÃ­na: ${Math.round(totalMacros.protein)}g\n- Carboidratos: ${Math.round(totalMacros.carbs)}g\n- Gorduras: ${Math.round(totalMacros.fats)}g\n- Calorias: ${Math.round(totalMacros.calories)}\n\nTem mais alguma coisa? ðŸ¤”`\n  }\n};"
      },
      "id": "e79629db-b8be-42be-8b39-fedea94fb4dc",
      "name": "FASE2: 6b. AÃ§Ã£o: AdiÃ§Ã£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        26944,
        96
      ]
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// FASE2: 6c. AÃ‡ÃƒO: CONFIRMAÃ‡ÃƒO (V2 - COM SALVAMENTO)\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst context = currentItem.context || {};\nconst contextData = context.data || {};\n\nconsole.log('âœ… Confirmando registro:', contextData);\n\n// =====================================================\n// ðŸ”¥ EXTRAIR FEEDBACKS PENDENTES PARA SALVAR\n// =====================================================\nconst pendingFeedbacks = contextData.pendingFeedbacks || [];\nconsole.log(`ðŸ“Š Feedbacks pendentes: ${pendingFeedbacks.length}`);\n\n// Preparar sugestÃµes para enviar ao Calibration Studio\nconst suggestionsToSave = pendingFeedbacks.map(f => ({\n  patientId: currentItem.patientId,\n  foodName: f.foodName,\n  foodType: f.foodType,\n  aiEstimate: f.aiEstimate,\n  userCorrection: f.userCorrection,\n  conversationId: currentItem.conversationId\n}));\n\n// Montar mensagem de resposta\nlet resposta = 'Perfeito! Registrando sua refeiÃ§Ã£o... âœ…';\n\nif (pendingFeedbacks.length > 0) {\n  resposta = `âœ… RefeiÃ§Ã£o registrada com ${pendingFeedbacks.length} ajuste(s) de peso!\\n\\nSeu feedback foi enviado para anÃ¡lise do nutricionista. ðŸ’ª`;\n}\n\n// =====================================================\n// RETORNO\n// =====================================================\nreturn {\n  json: {\n    conversationId: currentItem.conversationId,\n    patientId: currentItem.patientId,\n    prescriberId: currentItem.prescriberId,\n    action: 'confirm_and_save',\n    \n    // Dados da refeiÃ§Ã£o\n    mealData: {\n      patientId: currentItem.patientId,\n      conversationId: currentItem.conversationId,\n      ...contextData\n    },\n    \n    // ðŸ”¥ SUGESTÃ•ES PARA O CALIBRATION STUDIO\n    suggestionsToSave: suggestionsToSave,\n    hasSuggestions: suggestionsToSave.length > 0,\n    suggestionCount: suggestionsToSave.length,\n    \n    // Resposta ao paciente\n    responseMessage: resposta\n  }\n};"
      },
      "id": "4e1776c6-de45-4083-bff1-9b96ba47fe9e",
      "name": "FASE2: 6c. AÃ§Ã£o: ConfirmaÃ§Ã£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        25600,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "// Cancelar registro\nconst currentItem = $input.first().json;\n\nconsole.log('Cancelando registro');\n\nreturn {\n  json: {\n    conversationId: currentItem.conversationId,\n    action: 'cancel',\n    responseMessage: 'Tudo bem! Cancelei o registro. Se quiser registrar depois, Ã© sÃ³ me avisar! ðŸ˜Š'\n  }\n};"
      },
      "id": "f076b0de-753d-4c8e-aa63-d961eb3cb4a0",
      "name": "FASE2: 6d. AÃ§Ã£o: Cancelamento",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        26496,
        816
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://web-production-c9eaf.up.railway.app/api/meals/confirm",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-webhook-secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($('FASE2: 6c. AÃ§Ã£o: ConfirmaÃ§Ã£o').first().json.mealData) }}",
        "options": {}
      },
      "id": "efabf46c-9a92-4024-8dcf-ef5585fd1870",
      "name": "FASE2: 8. Registrar RefeiÃ§Ã£o",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        26496,
        320
      ]
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $('1. Validar e Processar').first().json.conversationId }}/context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "40a30b07-7f55-466c-9e98-46907516df16",
      "name": "FASE2: 9. Deletar Contexto",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        26720,
        512
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $('1. Validar e Processar').first().json.conversationId }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  senderId: 'system',\n  senderRole: 'prescriber',\n  content: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.responseMessage || 'âœ… RefeiÃ§Ã£o registrada com sucesso! JÃ¡ atualizei seu diÃ¡rio.',\n  type: 'text',\n  isAiGenerated: true\n}) }}",
        "options": {}
      },
      "id": "492881c7-2b9e-4866-93d5-30fef8d14100",
      "name": "FASE2: 10. Enviar Resposta",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        27968,
        368
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, action: $json.action || 'response_sent' } }}",
        "options": {}
      },
      "id": "9f00f012-9807-4732-9362-7fbfe9967d53",
      "name": "FASE2: 11. Responder Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        28192,
        368
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "id": "audio-check-1",
              "leftValue": "={{ $json.type }}",
              "rightValue": "audio",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "ff12a8f1-279f-444c-8f1a-a0b22d0b6e58",
              "leftValue": "={{ $json.type }}",
              "rightValue": "=ptt",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "94a4864a-c79e-4627-be2f-ccdbb357cb7a",
              "leftValue": "={{ $json.hasAudio }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {
          "looseTypeValidation": true
        }
      },
      "id": "5ddd0187-256f-4ea3-896e-b390b6841cba",
      "name": "2a. TEM ÃUDIO?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        23680,
        240
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.mediaUrl && $json.mediaUrl.startsWith('http') ? $json.mediaUrl : ($json.attachments && $json.attachments[0] && $json.attachments[0].url && $json.attachments[0].url.startsWith('http') ? $json.attachments[0].url : 'http://placeholder-error-url') }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "d5e5eb14-bf07-4803-a57a-7c1e9a13b774",
      "name": "AUDIO: 1. Baixar Arquivo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        23904,
        768
      ],
      "binaryPropertyName": "data",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Ã¡udio para Whisper\nconst currentItem = $('1. Validar e Processar').first().json;\n// Binary data vem do nÃ³ HTTP request\nconst binaryData = $input.first().binary;\n\nconsole.log('=== PREPARANDO ÃUDIO ===');\n\n// Extrair URL de forma segura\nconst audioUrl = currentItem.mediaUrl || (currentItem.attachments && currentItem.attachments[0] ? currentItem.attachments[0].url : 'URL_NAO_ENCONTRADA');\nconsole.log('URL do Ã¡udio:', audioUrl);\n\n// Verificar se temos dados binÃ¡rios\nif (!binaryData || !binaryData.data) {\n  console.error('âŒ ERRO: Nenhum dado binÃ¡rio recebido do download');\n  // Retornar erro controlado em vez de lanÃ§ar exceÃ§Ã£o\n  return {\n    json: {\n      ...currentItem,\n      error: 'Falha no download do Ã¡udio',\n      audioUrl: audioUrl\n    }\n  };\n}\n\n// ðŸ”¥ TRUQUE CRÃTICO: A OpenAI API exige que o arquivo tenha extensÃ£o vÃ¡lida no nome\nconst originalFileName = binaryData.data.fileName || 'audio_whatsapp';\nconst newFileName = 'audio_' + Date.now() + '.ogg';\n\nconsole.log('Renomeando de', originalFileName, 'para', newFileName);\n\nreturn {\n  json: {\n    ...currentItem,\n    audioUrl: audioUrl\n  },\n  binary: {\n    data: {\n      ...binaryData.data,\n      fileName: newFileName,\n      fileExtension: 'ogg',\n      mimeType: 'audio/ogg'\n    }\n  }\n};"
      },
      "id": "28d09d64-2916-4171-a343-814be04a2a13",
      "name": "AUDIO: 2. Preparar para Whisper",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        24128,
        768
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse transcriÃ§Ã£o do Whisper\n// Garantir que pegamos o conversationId de qualquer fonte disponÃ­vel\nlet currentItem = {};\ntry {\n  currentItem = $('1. Validar e Processar').first().json || {};\n} catch (e) {\n  // Se nÃ£o conseguir pegar do nÃ³ inicial, tenta do input\n  currentItem = $input.first().json || {};\n}\n\nconst whisperOutput = $input.first().json;\n\nconsole.log('=== TRANSCRIÃ‡ÃƒO RECEBIDA ===');\nconsole.log('Current item conversationId:', currentItem.conversationId);\nconsole.log('Whisper output:', whisperOutput);\n\nlet transcricao = '';\nlet erroTranscricao = false;\n\n// Verificar se houve erro no Whisper\nif (whisperOutput.error) {\n  console.error('âŒ Erro no Whisper:', whisperOutput.error);\n  transcricao = '[ERRO NA TRANSCRIÃ‡ÃƒO: NÃ£o foi possÃ­vel converter o Ã¡udio em texto]';\n  erroTranscricao = true;\n} else {\n  // A transcriÃ§Ã£o vem na propriedade text\n  transcricao = whisperOutput.text ? whisperOutput.text.trim() : '';\n}\n\nif (!transcricao) {\n  transcricao = '[Ãudio vazio ou inaudÃ­vel]';\n}\n\nconsole.log('Texto final:', transcricao);\n\n// Garantir que conversationId e patientId estÃ£o presentes\nif (!currentItem.conversationId) {\n  console.error('âŒ ERRO CRÃTICO: conversationId nÃ£o encontrado!');\n  console.error('Current item:', JSON.stringify(currentItem, null, 2));\n}\n\n// Atualizar content com a transcriÃ§Ã£o\nreturn {\n  json: {\n    ...currentItem,\n    content: transcricao,\n    originalContent: currentItem.content || '',\n    type: 'text',\n    isTranscribed: true,\n    transcriptionError: erroTranscricao,\n    // Garantir que conversationId e patientId estÃ£o presentes\n    conversationId: currentItem.conversationId || '',\n    patientId: currentItem.patientId || currentItem.senderId || ''\n  }\n};\n"
      },
      "id": "180933b5-5223-4b88-a02d-18ad0fe3fbe4",
      "name": "AUDIO: 4. Parse TranscriÃ§Ã£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        24576,
        768
      ]
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "pt"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        24352,
        768
      ],
      "id": "f49c3c10-a801-4206-aa1a-9afe513a8329",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// NÃ“ 11b. Dividir em 3 Mensagens - VERSÃƒO INTELIGENTE\n// =====================================================\n// Envia comparaÃ§Ã£o automÃ¡tica sÃ³ entre 20h e 00h\n// Ou quando paciente solicitar\n// =====================================================\n\nconst dados = $input.first().json;\nconst dadosIA = $('11a. Parse Resposta Final').first().json;\nconst respostaCompleta = dadosIA.resposta || '';\n\nconst senderId = dados.prescriberId || dadosIA.prescriberId || '6yooHer7ZgYOcYe0JHkXHLnWBq83';\nconst conversationId = dados.conversationId || dadosIA.conversationId;\n\n// =====================================================\n// VERIFICAR HORÃRIO PARA DECIDIR SE ENVIA COMPARAÃ‡ÃƒO\n// =====================================================\n\nconst brazilTime = new Date().toLocaleString(\"en-US\", {\n  timeZone: \"America/Sao_Paulo\",\n});\nconst agora = new Date(brazilTime);\nconst horaAtual = agora.getHours();\n\n// Envia comparaÃ§Ã£o automÃ¡tica entre 20h e 23h59\nconst enviarComparacaoAutomatica = horaAtual >= 20 || horaAtual < 0;\n\nconsole.log(`â° Hora atual: ${horaAtual}h`);\nconsole.log(`ðŸ“Š Enviar comparaÃ§Ã£o automÃ¡tica: ${enviarComparacaoAutomatica}`);\n\n// =====================================================\n// VALIDAÃ‡ÃƒO\n// =====================================================\n\nif (!respostaCompleta) {\n  console.error('ERRO: Resposta da IA nÃ£o encontrada!');\n  return [{\n    json: {\n      senderId: senderId,\n      senderRole: 'prescriber',\n      content: 'âŒ Erro ao processar anÃ¡lise. Tente novamente.',\n      type: 'text',\n      conversationId: conversationId\n    }\n  }];\n}\n\nconsole.log('=== RESPOSTA COMPLETA DA IA ===');\nconsole.log(respostaCompleta);\n\n// =====================================================\n// EXTRAIR PARTES E LIMPAR MARCADORES\n// =====================================================\n\nlet parte1 = '';\nlet parte2 = '';\nlet parte3 = '';\n\nconst regexParte1 = /---PARTE1---([\\s\\S]*?)---FIM1---/;\nconst regexParte2 = /---PARTE2---([\\s\\S]*?)---FIM2---/;\nconst regexParte3 = /---PARTE3---([\\s\\S]*?)---FIM3---/;\n\nconst matchParte1 = respostaCompleta.match(regexParte1);\nconst matchParte2 = respostaCompleta.match(regexParte2);\nconst matchParte3 = respostaCompleta.match(regexParte3);\n\nif (matchParte1) parte1 = matchParte1[1].trim();\nif (matchParte2) parte2 = matchParte2[1].trim();\nif (matchParte3) parte3 = matchParte3[1].trim();\n\n// Fallback se nÃ£o encontrou marcadores\nif (!matchParte1 && !matchParte2 && !matchParte3) {\n  let respostaLimpa = respostaCompleta\n    .replace(/---PARTE\\d---/g, '')\n    .replace(/---FIM\\d---/g, '')\n    .trim();\n  parte1 = respostaLimpa;\n}\n\n// =====================================================\n// LIMPAR MARCADORES RESIDUAIS\n// =====================================================\n\nconst limparMarcadores = (texto) => {\n  if (!texto) return '';\n  return texto\n    .replace(/---PARTE\\d---/g, '')\n    .replace(/---FIM\\d---/g, '')\n    .replace(/\\n{3,}/g, '\\n\\n')\n    .trim();\n};\n\nparte1 = limparMarcadores(parte1);\nparte2 = limparMarcadores(parte2);\nparte3 = limparMarcadores(parte3);\n\n// =====================================================\n// GARANTIR CONFIRMAÃ‡ÃƒO NO INÃCIO\n// =====================================================\n\nif (parte1 && !parte1.startsWith('âœ…')) {\n  parte1 = 'âœ… RefeiÃ§Ã£o registrada no diÃ¡rio!\\n\\n' + parte1;\n}\n\n// =====================================================\n// MENSAGEM DE FEEDBACK\n// =====================================================\n\nconst feedbackPadrao = 'ðŸ’¬ Algo errado? Me diga que eu aprendo!';\n\nif (!parte3) {\n  parte3 = feedbackPadrao;\n} else if (!parte3.includes('errado') && !parte3.includes('corrij') && !parte3.includes('aprendo')) {\n  parte3 = parte3 + '\\n\\n' + feedbackPadrao;\n}\n\n// =====================================================\n// CONSTRUIR MENSAGENS\n// =====================================================\n\nconst mensagens = [];\n\n// MENSAGEM 1: Registro + O que vocÃª comeu (SEMPRE)\nif (parte1) {\n  mensagens.push({\n    json: {\n      senderId: senderId,\n      senderRole: 'prescriber',\n      content: parte1,\n      type: 'text',\n      order: 1,\n      totalMessages: enviarComparacaoAutomatica ? 3 : 2,\n      conversationId: conversationId\n    }\n  });\n}\n\n// MENSAGEM 2: ComparaÃ§Ã£o com dieta (SÃ“ ENTRE 20h E 00h)\nif (parte2 && parte2.length > 10 && enviarComparacaoAutomatica) {\n  mensagens.push({\n    json: {\n      senderId: senderId,\n      senderRole: 'prescriber',\n      content: parte2,\n      type: 'text',\n      order: 2,\n      totalMessages: 3,\n      conversationId: conversationId\n    }\n  });\n  console.log('ðŸ“Š ComparaÃ§Ã£o enviada (horÃ¡rio noturno)');\n} else if (parte2 && !enviarComparacaoAutomatica) {\n  console.log('ðŸ“Š ComparaÃ§Ã£o NÃƒO enviada (fora do horÃ¡rio 20h-00h)');\n}\n\n// MENSAGEM 3: Feedback final (SEMPRE)\nif (parte3) {\n  mensagens.push({\n    json: {\n      senderId: senderId,\n      senderRole: 'prescriber',\n      content: parte3,\n      type: 'text',\n      order: mensagens.length + 1,\n      totalMessages: mensagens.length + 1,\n      conversationId: conversationId\n    }\n  });\n}\n\nconsole.log(`âœ… Retornando ${mensagens.length} mensagens`);\nreturn mensagens;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        31680,
        -720
      ],
      "id": "92a93bab-8045-4207-a38a-66ef3db93411",
      "name": "11b. Dividir em 3 Mensagens"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 5h. Detectar Pergunta sobre HistÃ³rico/Dieta\n// =====================================================\n// Detecta perguntas sobre histÃ³rico E sobre dieta prescrita\n// =====================================================\n\nconst mensagem = $input.first().json.content || '';\nconst mensagemLower = mensagem.toLowerCase()\n  .normalize('NFD')\n  .replace(/[\\u0300-\\u036f]/g, ''); // Remove acentos\n\n// Palavras-chave de HISTÃ“RICO\nconst palavrasHistorico = [\n  'o que eu comi',\n  'o que comi',\n  'ja comi',\n  'ja registrei',\n  'registrei',\n  'quanto de proteina',\n  'quantas calorias',\n  'quanto de carboidrato',\n  'quanto de gordura',\n  'ontem',\n  'semana passada',\n  'nos ultimos dias',\n  'historico',\n  'diario',\n  'refeicoes anteriores',\n  'ja consumi',\n  'total do dia',\n  'total de hoje'\n];\n\n// Palavras-chave de COMPARAÃ‡ÃƒO COM DIETA\nconst palavrasDieta = [\n  'comparacao',\n  'comparar',\n  'comparando',\n  'dieta prescrita',\n  'minha dieta',\n  'em relacao a dieta',\n  'meta',\n  'minha meta',\n  'como estou',\n  'como to',\n  'como ta',\n  'falta comer',\n  'falta quanto',\n  'quanto falta',\n  'restante',\n  'sobrou',\n  'passei',\n  'excedi',\n  'estourei',\n  'ultrapassei',\n  'balanco',\n  'resumo do dia',\n  'fechamento',\n  'como foi meu dia',\n  'comi bem',\n  'comi mal',\n  'ta bom',\n  'ta ruim'\n];\n\n// Palavras que indicam \"hoje\"\nconst palavrasHoje = [\n  'hoje',\n  'agora',\n  'ate agora',\n  'ate aqui',\n  'no momento'\n];\n\nconst isPerguntaHistorico = palavrasHistorico.some(p => mensagemLower.includes(p));\nconst isPerguntaDieta = palavrasDieta.some(p => mensagemLower.includes(p));\nconst mencionaHoje = palavrasHoje.some(p => mensagemLower.includes(p));\n\n// Se pergunta sobre dieta/comparaÃ§Ã£o + hoje = buscar histÃ³rico de hoje\nconst deveCompararComDieta = isPerguntaDieta || (isPerguntaHistorico && mencionaHoje);\n\nconsole.log('ðŸ“ Mensagem:', mensagem);\nconsole.log('ðŸ“Š Ã‰ pergunta sobre histÃ³rico:', isPerguntaHistorico);\nconsole.log('ðŸŽ¯ Ã‰ pergunta sobre dieta:', isPerguntaDieta);\nconsole.log('ðŸ“… Menciona hoje:', mencionaHoje);\nconsole.log('âš–ï¸ Deve comparar com dieta:', deveCompararComDieta);\n\nreturn [{\n  json: {\n    ...$input.first().json,\n    isPerguntaHistorico: isPerguntaHistorico || isPerguntaDieta,\n    isPerguntaDieta: isPerguntaDieta,\n    deveCompararComDieta: deveCompararComDieta,\n    mensagemOriginal: mensagem\n  }\n}];"
      },
      "id": "5df71c7d-1a9b-47c5-bc03-3058ea003640",
      "name": "5h. Detectar Pergunta sobre HistÃ³rico",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        26048,
        -192
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "771a921c-4b71-40da-b8d2-89e0ec6535ec",
              "leftValue": "={{ $json.isPerguntaHistorico }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "b244da28-3063-4def-9340-861dde373b0e",
      "name": "5h-IF. Ã‰ Pergunta sobre HistÃ³rico?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        26272,
        -192
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extrair perÃ­odo da pergunta\nconst mensagem = $input.first().json.mensagemOriginal.toLowerCase();\nconst hoje = new Date();\n\nfunction formatDate(date) {\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  return `${year}-${month}-${day}`;\n}\n\nfunction subtractDays(date, days) {\n  const result = new Date(date);\n  result.setDate(result.getDate() - days);\n  return result;\n}\n\nlet startDate, endDate, periodo;\n\nif (mensagem.includes('hoje')) {\n  startDate = formatDate(hoje);\n  endDate = formatDate(hoje);\n  periodo = 'hoje';\n  \n} else if (mensagem.includes('ontem')) {\n  const ontem = subtractDays(hoje, 1);\n  startDate = formatDate(ontem);\n  endDate = formatDate(ontem);\n  periodo = 'ontem';\n  \n} else if (mensagem.includes('essa semana') || mensagem.includes('esta semana')) {\n  const inicioSemana = subtractDays(hoje, hoje.getDay());\n  startDate = formatDate(inicioSemana);\n  endDate = formatDate(hoje);\n  periodo = 'essa semana';\n  \n} else if (mensagem.includes('semana passada')) {\n  const fimSemanaPassada = subtractDays(hoje, hoje.getDay());\n  const inicioSemanaPassada = subtractDays(fimSemanaPassada, 7);\n  startDate = formatDate(inicioSemanaPassada);\n  endDate = formatDate(fimSemanaPassada);\n  periodo = 'semana passada';\n  \n} else if (mensagem.includes('Ãºltimos 7 dias') || mensagem.includes('ultima semana')) {\n  startDate = formatDate(subtractDays(hoje, 7));\n  endDate = formatDate(hoje);\n  periodo = 'Ãºltimos 7 dias';\n  \n} else if (mensagem.includes('Ãºltimos 3 dias')) {\n  startDate = formatDate(subtractDays(hoje, 3));\n  endDate = formatDate(hoje);\n  periodo = 'Ãºltimos 3 dias';\n  \n} else {\n  // PadrÃ£o: hoje\n  startDate = formatDate(hoje);\n  endDate = formatDate(hoje);\n  periodo = 'hoje';\n}\n\nreturn [{\n  json: {\n    ...$input.first().json,\n    startDate: startDate,\n    endDate: endDate,\n    periodo: periodo,\n    isSingleDay: startDate === endDate\n  }\n}];"
      },
      "id": "333ec570-0567-4a92-a131-7cd5529d6d68",
      "name": "5i. Extrair PerÃ­odo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        26496,
        -432
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/patients/{{ $('1. Validar e Processar').first().json.patientId }}/food-diary?startDate={{ $json.startDate }}&endDate={{ $json.endDate }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "6376b186-f2fe-42d6-8426-4fc6afcbfcbb",
      "name": "5j. Buscar HistÃ³rico DiÃ¡rio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        26720,
        -432
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Construir contexto com histÃ³rico do diÃ¡rio\nconst dados = $input.first().json;\nconst historicoResponse = $('5j. Buscar HistÃ³rico DiÃ¡rio').first().json;\n\nconst periodo = dados.periodo || 'hoje';\nconst logs = historicoResponse.logs || [];\nconst summary = historicoResponse.summary || {};\n\n// Formatar logs do diÃ¡rio\nlet historicoFormatado = '';\n\nif (logs.length === 0) {\n  historicoFormatado = `\\nðŸ“­ HISTÃ“RICO DO DIÃRIO (${periodo}):\\nNenhuma refeiÃ§Ã£o registrada neste perÃ­odo.\\n`;\n} else {\n  const logsFormatados = logs.map(log => {\n    const tipo = log.type || 'refeiÃ§Ã£o';\n    const data = log.date || '';\n    const hora = log.timestamp ? new Date(log.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';\n    const descricao = log.description || '';\n    const alimentos = (log.foods || []).join(', ');\n    const macros = log.macros || {};\n    \n    return `\nðŸ½ï¸ ${tipo.toUpperCase()} - ${data} ${hora}\n   Alimentos: ${alimentos || descricao}\n   ðŸ“Š ${Math.round(macros.calories || 0)}kcal | P:${Math.round(macros.protein || 0)}g | C:${Math.round(macros.carbs || 0)}g | G:${Math.round(macros.fats || 0)}g\n   ${log.userComment ? `ðŸ’¬ \"${log.userComment}\"` : ''}`;\n  }).join('\\n');\n\n  historicoFormatado = `\nðŸ“š HISTÃ“RICO DO DIÃRIO ALIMENTAR (${periodo}):\n\n${logsFormatados}\n\nðŸ“Š RESUMO TOTAL DO PERÃODO:\n- Calorias: ${Math.round(summary.totalCalories || 0)} kcal\n- ProteÃ­nas: ${Math.round(summary.totalProtein || 0)}g\n- Carboidratos: ${Math.round(summary.totalCarbs || 0)}g\n- Gorduras: ${Math.round(summary.totalFats || 0)}g\n- Total de refeiÃ§Ãµes: ${logs.length}\n`;\n}\n\nreturn [{\n  json: {\n    ...dados,\n    historicoFormatado: historicoFormatado,\n    temHistorico: logs.length > 0,\n    totalRefeicoes: logs.length,\n    summaryMacros: summary\n  }\n}];"
      },
      "id": "4044bca4-e43d-4e28-ae8f-de1b44803510",
      "name": "5k. Construir Contexto com HistÃ³rico",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        26944,
        -432
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}/context\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        24352,
        -528
      ],
      "id": "f103d06d-c28d-4508-9795-2d2d85f6b461",
      "name": "3a. Tem Contexto FASE2?",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "11083c60-ee7f-4a84-8248-6115f479d7af",
              "leftValue": "={{ $json.hasContext }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        24576,
        -528
      ],
      "id": "133d655a-e065-4a72-a50c-b55310ffb7dc",
      "name": "3b. IF: Tem Dados?"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6284723a-47e4-4d2c-a474-a2b8f0acf81f",
                    "leftValue": "={{ $json.intention.type }}",
                    "rightValue": "addition",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intention.type }}",
                    "rightValue": "confirmation",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c0e8dc2c-5324-4c32-95a4-3b8b9ec1d93f"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d58b4d7f-2655-487f-b384-8ac42c5e0ae9",
                    "leftValue": "={{ $json.intention.type }}",
                    "rightValue": "correction",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9c1a1a27-a333-4493-ae7c-c1e3e7cb046f",
                    "leftValue": "={{ $json.intention.type }}",
                    "rightValue": "cancellation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "340633a4-507c-4736-b77a-fc8a09cf2815",
                    "leftValue": "={{ $json.intention.type }}",
                    "rightValue": "history_query",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        25376,
        256
      ],
      "id": "7f6de9ac-e62a-4bdc-bbcc-b6199f705930",
      "name": "Roteador de IntenÃ§Ã£o"
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/patient/{{ $('1. Validar e Processar').first().json.patientId }}/full-context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-webhook-secret",
              "value": "=nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        26944,
        -96
      ],
      "id": "8ad22e8c-9f5d-40eb-8b76-91271e6eeb81",
      "name": "5z. Buscar Contexto Completo do Paciente"
    },
    {
      "parameters": {
        "jsCode": "// 7d. DETECTAR EMBALAGEM E PREPARAR BUSCA\nconst item = $input.first().json;\nconst alimentos = item.analise_foto?.alimentos || [];\nconst imageUrl = item.imageUrl || item.attachments?.[0]?.url || $('1. Validar e Processar').first().json.attachments?.[0]?.url || '';\n\n// Palavras que indicam produto embalado\nconst embalagem = [\n  'yogurt', 'iogurte', 'activia', 'danone', 'nestle', 'nestlÃ©',\n  'leite', 'suco', 'juice', 'milk', 'yakult', 'danoninho',\n  'vigor', 'batavo', 'itambÃ©', 'piracanjuba', 'elegÃª',\n  'barra', 'bar', 'cereal', 'granola', 'nescau', 'toddy',\n  'biscoito', 'cookie', 'bolacha', 'cream cheese', 'requeijÃ£o',\n  'refrigerante', 'soda', 'coca', 'pepsi', 'guaranÃ¡'\n];\n\n// Verificar se algum alimento Ã© produto embalado\nconst produtosEmbalados = alimentos.filter(a => {\n  const nome = ((a.nome || '') + (a.nome_original || '')).toLowerCase();\n  return embalagem.some(p => nome.includes(p));\n});\n\nconst temEmbalagem = produtosEmbalados.length > 0;\n\nconsole.log('ðŸ“¦ Produtos embalados:', produtosEmbalados.length);\n\nif (!temEmbalagem) {\n  console.log('âœ… Sem produtos embalados. Passando direto.');\n  return { \n    json: { \n      ...item, \n      tem_embalagem: false,\n      pular_busca: true\n    } \n  };\n}\n\n// Preparar prompt para Vision ler a embalagem\nconst nomesEmbalados = produtosEmbalados.map(a => a.nome || a.nome_original).join(', ');\n\nconst prompt = `Analise esta foto e LEIA O TEXTO NA EMBALAGEM do produto.\n\nðŸŽ¯ OBJETIVO: Identificar o produto EXATO lendo a embalagem.\n\nO QUE PROCURAR:\n1. MARCA (ex: Activia, Danone, NestlÃ©)\n2. LINHA/VERSÃƒO (ex: Triplo Zero, Light, Integral)\n3. SABOR (ex: Ameixa, Morango, Natural)\n4. PESO/VOLUME (ex: 170g, 200ml)\n5. CÃ“DIGO DE BARRAS (se visÃ­vel)\n\nðŸ“¦ PRODUTO DETECTADO: ${nomesEmbalados}\n\nRESPONDA EM JSON:\n{\n  \"produtos\": [\n    {\n      \"nome_completo\": \"Nome exato lido\",\n      \"marca\": \"Marca\",\n      \"linha\": \"Linha/versÃ£o\",\n      \"sabor\": \"Sabor\",\n      \"peso\": \"170g\",\n      \"codigo_barras\": \"7891234567890 ou null\"\n    }\n  ]\n}\n\nAPENAS JSON.`;\n\nreturn {\n  json: {\n    ...item,\n    tem_embalagem: true,\n    pular_busca: false,\n    prompt_embalagem: prompt,\n    imageUrl: imageUrl,\n    produtos_embalados: produtosEmbalados\n  }\n};"
      },
      "id": "7f6eba5b-0de3-43a2-83b0-440d45d825be",
      "name": "7d. Detectar Embalagem",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        27680,
        -720
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"text\",\n          \"text\": {{ JSON.stringify($json.prompt_embalagem) }}\n        },\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": {{ JSON.stringify($json.imageUrl) }}\n          }\n        }\n      ]\n    }\n  ],\n  \"max_tokens\": 500\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "d0b83154-2221-4c8a-9555-e10578950baf",
      "name": "7d. Vision - Ler Embalagem",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        28192,
        -800
      ],
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================================================\n// 7e-3. APLICAR DADOS DA API - VERSÃƒO FINAL COMPLETA\n// =============================================================================\n// INSTRUÃ‡Ã•ES: Copie TODO este arquivo e cole no nÃ³ \"7e-3. Aplicar Dados API\"\n// NÃƒO delete nenhuma linha! O arquivo estÃ¡ completo e funcional.\n// =============================================================================\n\nconst item = $input.first().json;\nconst apiResponse = item;\nconst produtos = apiResponse.products || [];\n\n// âœ… CORREÃ‡ÃƒO: Buscar dados originais do inÃ­cio do fluxo\nlet dadosOriginais = {};\nlet produtosLidos = [];\n\ntry {\n  // Tentar buscar do nÃ³ 7d (tem os dados originais do 7a. PARSE-PASSIO)\n  dadosOriginais = $('7d. Detectar Embalagem').first().json;\n  console.log('âœ… Dados originais recuperados do 7d');\n} catch (e) {\n  console.log('âš ï¸ NÃ£o encontrou 7d, usando input');\n  dadosOriginais = item;\n}\n\ntry {\n  // Buscar produtos lidos do Vision\n  const dadosVision = $('7e-1. Preparar Busca API').first().json;\n  produtosLidos = dadosVision.produtos_lidos || [];\n  console.log('âœ… Produtos lidos recuperados:', produtosLidos.length);\n} catch (e) {\n  console.log('âš ï¸ NÃ£o encontrou produtos lidos');\n  produtosLidos = item.produtos_lidos || [];\n}\n\nlet alimentos = dadosOriginais.analise_foto?.alimentos || [];\nconsole.log('ðŸ½ï¸ Alimentos originais:', alimentos.length);\n\nconsole.log('=== APLICANDO DADOS DA API ===');\nconsole.log('Produtos encontrados na API:', produtos.length);\n\n// =============================================================================\n// BANCO LOCAL com dados CORRETOS de produtos brasileiros\n// =============================================================================\nconst bancoLocal = {\n  'activia triplo zero ameixa': { \n    nome: 'Activia Triplo Zero Ameixa', \n    peso: 170, \n    macros: { proteinas: 5.9, carboidratos: 7.5, gorduras: 0, calorias: 54 },\n    observacoes: 'Zero lactose, zero aÃ§Ãºcar, zero gordura'\n  },\n  'activia triplo zero morango': { \n    nome: 'Activia Triplo Zero Morango', \n    peso: 170, \n    macros: { proteinas: 5.9, carboidratos: 7.5, gorduras: 0, calorias: 54 },\n    observacoes: 'Zero lactose, zero aÃ§Ãºcar, zero gordura'\n  },\n  'activia triplo zero natural': { \n    nome: 'Activia Triplo Zero Natural', \n    peso: 170, \n    macros: { proteinas: 6.8, carboidratos: 5.1, gorduras: 0, calorias: 48 },\n    observacoes: 'Zero lactose, zero aÃ§Ãºcar, zero gordura'\n  },\n  'activia natural': {\n    nome: 'Activia Natural',\n    peso: 170,\n    macros: { proteinas: 6, carboidratos: 10.2, gorduras: 2, calorias: 82 }\n  },\n  'activia morango': {\n    nome: 'Activia Morango',\n    peso: 170,\n    macros: { proteinas: 5.3, carboidratos: 13.6, gorduras: 1.7, calorias: 90 }\n  },\n  'yakult': { \n    nome: 'Yakult', \n    peso: 80, \n    macros: { proteinas: 1.1, carboidratos: 11.5, gorduras: 0, calorias: 51 }\n  },\n  'danone grego natural': { \n    nome: 'Danone Grego Natural', \n    peso: 100, \n    macros: { proteinas: 5.5, carboidratos: 5.8, gorduras: 6.5, calorias: 103 }\n  },\n  'danone grego': { \n    nome: 'Danone Grego', \n    peso: 100, \n    macros: { proteinas: 5.5, carboidratos: 5.8, gorduras: 6.5, calorias: 103 }\n  }\n};\n\n// =============================================================================\n// âœ… PRIORIDADE 1: BANCO LOCAL (dados mais confiÃ¡veis que a API)\n// =============================================================================\nlet usouBancoLocal = false;\n\nconsole.log('ðŸ” Iniciando busca no banco local...');\nconsole.log('ðŸ“‹ Produtos lidos pelo Vision:', JSON.stringify(produtosLidos, null, 2));\n\nprodutosLidos.forEach(pl => {\n  const termoBusca = `${pl.marca || ''} ${pl.linha || ''} ${pl.sabor || ''}`.toLowerCase().trim();\n  console.log('ðŸ” Buscando no banco local:', termoBusca);\n  \n  // Buscar no banco local com match flexÃ­vel\n  const produtoLocal = Object.entries(bancoLocal).find(([chave]) => {\n    const palavrasChave = chave.split(' ');\n    const palavrasTermo = termoBusca.split(' ');\n    \n    // Conta quantas palavras coincidem\n    const coincidencias = palavrasChave.filter(p => \n      palavrasTermo.some(t => t.includes(p) || p.includes(t))\n    );\n    \n    // Se pelo menos 2 palavras coincidirem, considera match\n    return coincidencias.length >= 2;\n  });\n  \n  if (produtoLocal) {\n    const [chave, dados] = produtoLocal;\n    console.log('âœ… ENCONTRADO NO BANCO LOCAL:', chave);\n    console.log('ðŸ“Š Dados do banco:', JSON.stringify(dados, null, 2));\n    \n    // Atualizar os alimentos com dados do banco local\n    alimentos = alimentos.map(al => {\n      const nomeAl = ((al.nome || '') + (al.nome_original || '')).toLowerCase();\n      const ehRelacionado = ['yogurt', 'iogurte', 'activia', 'danone', 'yakult'].some(p => \n        nomeAl.includes(p)\n      );\n      \n      if (ehRelacionado) {\n        console.log(`ðŸ”„ Atualizando \"${al.nome}\" com dados do banco local`);\n        return {\n          ...al,\n          nome: dados.nome,\n          peso_gramas: dados.peso,\n          macros: dados.macros,\n          confianca: 'alta',\n          fonte: 'banco_local',\n          observacoes: dados.observacoes || ''\n        };\n      }\n      return al;\n    });\n    \n    usouBancoLocal = true;\n  } else {\n    console.log('âŒ NÃ£o encontrado no banco local para:', termoBusca);\n  }\n});\n\n// Se usou banco local, pular a API\nif (usouBancoLocal) {\n  console.log('âœ… USANDO BANCO LOCAL. Pulando API Open Food Facts.');\n}\n\n// =============================================================================\n// âœ… PRIORIDADE 2: API Open Food Facts (apenas se banco local nÃ£o encontrou)\n// =============================================================================\nelse if (produtos.length > 0) {\n  const produtoAPI = produtos[0]; // Pegar o primeiro resultado\n  const nutriments = produtoAPI.nutriments || {};\n  \n  console.log('ðŸ“¡ Produto encontrado na API:', produtoAPI.product_name);\n  console.log('ðŸ“¦ Nutriments raw:', JSON.stringify(nutriments, null, 2));\n  \n  // Extrair macros SEMPRE por 100g (padronizado)\n  const macrosPor100g = {\n    proteinas: parseFloat(nutriments.proteins_100g || nutriments.proteins || 0),\n    carboidratos: parseFloat(nutriments.carbohydrates_100g || nutriments.carbohydrates || 0),\n    gorduras: parseFloat(nutriments.fat_100g || nutriments.fat || 0),\n    calorias: parseFloat(nutriments['energy-kcal_100g'] || nutriments['energy-kcal'] || 0)\n  };\n  \n  console.log('ðŸ“Š Macros por 100g (da API):', macrosPor100g);\n  \n  // Extrair peso do produto (em gramas)\n  let pesoReal = 100; // padrÃ£o\n  \n  if (produtoAPI.quantity) {\n    // Tentar extrair nÃºmero do quantity (ex: \"170g\" â†’ 170)\n    const match = String(produtoAPI.quantity).match(/(\\d+(\\.\\d+)?)/);\n    if (match) {\n      pesoReal = parseFloat(match[1]);\n    }\n  } else if (produtoAPI.serving_size) {\n    const match = String(produtoAPI.serving_size).match(/(\\d+(\\.\\d+)?)/);\n    if (match) {\n      pesoReal = parseFloat(match[1]);\n    }\n  }\n  \n  console.log(`âš–ï¸ Peso real do produto: ${pesoReal}g`);\n  \n  // âœ… CÃLCULO CORRETO: (valor_por_100g * peso_real) / 100\n  const macrosReais = {\n    proteinas: Math.round((macrosPor100g.proteinas * pesoReal / 100) * 10) / 10,\n    carboidratos: Math.round((macrosPor100g.carboidratos * pesoReal / 100) * 10) / 10,\n    gorduras: Math.round((macrosPor100g.gorduras * pesoReal / 100) * 10) / 10,\n    calorias: Math.round(macrosPor100g.calorias * pesoReal / 100)\n  };\n  \n  console.log(`ðŸ“Š Macros calculados para ${pesoReal}g:`, macrosReais);\n  \n  // Atualizar alimentos (apenas os embalados)\n  alimentos = alimentos.map(al => {\n    const nomeAl = ((al.nome || '') + (al.nome_original || '')).toLowerCase();\n    const ehEmbalado = ['yogurt', 'iogurte', 'activia', 'danone', 'yakult', 'leite', 'milk'].some(p => \n      nomeAl.includes(p)\n    );\n    \n    if (ehEmbalado) {\n      console.log(`ðŸ”„ Atualizando \"${al.nome}\" com dados da API`);\n      return {\n        ...al,\n        nome: produtoAPI.product_name || produtoAPI.product_name_pt || al.nome,\n        peso_gramas: pesoReal,\n        macros: macrosReais,\n        confianca: 'alta',\n        fonte: 'open_food_facts',\n        codigo_barras: produtoAPI.code || null,\n        imagem: produtoAPI.image_url || null\n      };\n    }\n    return al;\n  });\n} \n\n// =============================================================================\n// âœ… PRIORIDADE 3: Manter dados originais do Passio (se nÃ£o encontrou em lugar nenhum)\n// =============================================================================\nelse {\n  console.log('âš ï¸ Produto nÃ£o encontrado na API nem no banco local.');\n  console.log('â„¹ï¸ Mantendo dados originais do Passio.');\n}\n\n// =============================================================================\n// RECALCULAR MACROS TOTAIS\n// =============================================================================\nconst macros_totais = alimentos.reduce((t, al) => ({\n  proteinas: Math.round((t.proteinas + (al.macros?.proteinas || 0)) * 10) / 10,\n  carboidratos: Math.round((t.carboidratos + (al.macros?.carboidratos || 0)) * 10) / 10,\n  gorduras: Math.round((t.gorduras + (al.macros?.gorduras || 0)) * 10) / 10,\n  calorias: Math.round(t.calorias + (al.macros?.calorias || 0))\n}), { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 });\n\nconsole.log('ðŸ“Š Macros totais finais:', macros_totais);\nconsole.log('ðŸ½ï¸ Alimentos finais:', JSON.stringify(alimentos, null, 2));\n\n// =============================================================================\n// RETORNAR RESULTADO\n// =============================================================================\nreturn {\n  json: {\n    ...dadosOriginais,\n    analise_foto: {\n      alimentos: alimentos,\n      macros_totais: macros_totais,\n      observacoes: usouBancoLocal \n        ? `âœ… Dados nutricionais do banco local (produtos brasileiros)` \n        : produtos.length > 0 \n          ? `âœ… Dados nutricionais obtidos do Open Food Facts`\n          : `âœ… Dados nutricionais do Passio`\n    },\n    fonte_dados: usouBancoLocal ? 'banco_local' : produtos.length > 0 ? 'open_food_facts' : 'passio'\n  }\n};\n"
      },
      "id": "ecb03364-1527-4bd2-b7f9-3a22d12bbde6",
      "name": "7e-3. Aplicar Dados API",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        28864,
        -800
      ]
    },
    {
      "parameters": {
        "url": "=https://world.openfoodfacts.org/cgi/search.pl?search_terms={{ encodeURIComponent($json.termo_busca) }}&search_simple=1&action=process&json=1&page_size=3&countries_tags_en=brazil",
        "options": {
          "timeout": 30000
        }
      },
      "id": "eb54a671-e21b-476f-9b1d-a926cb3ccd1b",
      "name": "7e-2. Buscar Open Food Facts",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        28640,
        -800
      ],
      "onError": "continueRegularOutput",
      "notes": "API gratuita com produtos brasileiros!\n\nExemplo: activia triplo zero â†’ retorna dados nutricionais reais"
    },
    {
      "parameters": {
        "jsCode": "// 7e-1. PREPARAR BUSCA NA API\nconst item = $input.first().json;\nconst visionResponse = item.choices?.[0]?.message?.content || '';\n\nconsole.log('=== PREPARANDO BUSCA API ===');\n\n// âœ… Buscar dados originais do 7d\nlet dadosOriginais = {};\ntry {\n  dadosOriginais = $('7d. Detectar Embalagem').first().json;\n  console.log('âœ… Dados originais recuperados (alimentos:', dadosOriginais.analise_foto?.alimentos?.length || 0, ')');\n} catch (e) {\n  console.log('âš ï¸ Erro ao buscar dados originais:', e.message);\n  dadosOriginais = item;\n}\n\n// Parse resposta Vision\nlet produtosLidos = [];\nif (visionResponse) {\n  try {\n    let json = visionResponse;\n    if (json.includes('```json')) json = json.split('```json')[1].split('```')[0];\n    else if (json.includes('```')) json = json.split('```')[1].split('```')[0];\n    const parsed = JSON.parse(json.trim());\n    produtosLidos = parsed.produtos || [];\n    console.log('âœ… Produtos lidos:', JSON.stringify(produtosLidos, null, 2));\n  } catch (e) {\n    console.error('âŒ Erro parse Vision:', e.message);\n  }\n}\n\n// Construir termos de busca\nconst buscas = produtosLidos.map(p => {\n  // Se tem cÃ³digo de barras, usar ele\n  if (p.codigo_barras && p.codigo_barras !== 'null') {\n    return {\n      tipo: 'barcode',\n      termo: p.codigo_barras,\n      produto: p\n    };\n  }\n  // SenÃ£o, buscar por nome\n  const termo = `${p.marca || ''} ${p.linha || ''} ${p.sabor || ''}`.trim();\n  return {\n    tipo: 'search',\n    termo: termo,\n    produto: p\n  };\n});\n\nreturn {\n  json: {\n    ...dadosOriginais,\n    visionResponse: item,\n    produtos_lidos: produtosLidos,\n    buscas: buscas,\n    termo_busca: buscas[0]?.termo || 'activia'\n  }\n};"
      },
      "id": "e1168be7-91be-4d38-ba2e-2cb65d9e287f",
      "name": "7e-1. Preparar Busca API",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        28416,
        -800
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.pular_busca }}",
              "value2": true
            }
          ]
        }
      },
      "id": "fcc801d5-f25c-427a-b5c2-18bfbe0617da",
      "name": "7d-IF. Pular?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        27968,
        -720
      ]
    },
    {
      "parameters": {
        "url": "https://web-production-c9eaf.up.railway.app/api/learnings/global",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": " nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        26944,
        -720
      ],
      "id": "ef11bca2-b4bd-4962-810d-632387e67256",
      "name": "7a-2. Buscar CorreÃ§Ãµes Firebase",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://web-production-c9eaf.up.railway.app/api/n8n/food-weight/feedback",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.feedbackData) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        25824,
        320
      ],
      "id": "b8244873-3e44-4bbd-a85a-473d0aa4626d",
      "name": "HTTP Request",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "https://web-production-c9eaf.up.railway.app/api/n8n/food-weight/all-corrections",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret\t",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        25824,
        -720
      ],
      "id": "f875bbff-f216-441a-8054-2a686aee3903",
      "name": "5g. Buscar CorreÃ§Ãµes Aprendidas",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://web-production-c9eaf.up.railway.app/api/n8n/food-weight/feedback",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret\t",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type\t",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.feedbackData) }}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        26944,
        800
      ],
      "id": "e2e08e0f-a095-4312-81c8-5ecac0b6d41c",
      "name": "FASE2: 6a-2. Enviar Feedback Aprendizado",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// FASE2: 7. ATUALIZAR CONTEXTO (versÃ£o robusta)\nconst correcaoData = $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').first().json;\n\nconsole.log('=== ATUALIZANDO CONTEXTO ===');\nconsole.log('ConversationId:', correcaoData.conversationId);\n\n// Verificar se tem dados para atualizar\nif (!correcaoData.contextUpdate || !correcaoData.contextUpdate.data) {\n  console.log('âš ï¸ Sem dados de contexto para atualizar, pulando...');\n  return {\n    json: {\n      ...correcaoData,\n      contextUpdated: false,\n      reason: 'no_context_data'\n    }\n  };\n}\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'PATCH',\n    url: `https://web-production-c9eaf.up.railway.app/api/n8n/conversations/${correcaoData.conversationId}/context`,\n    headers: {\n      'X-Webhook-Secret': 'nutribuddy-secret-2024',\n      'Content-Type': 'application/json'\n    },\n    body: {\n      updates: correcaoData.contextUpdate.data\n    }\n  });\n  \n  console.log('âœ… Contexto atualizado:', response);\n  \n  return {\n    json: {\n      ...correcaoData,\n      contextUpdated: true,\n      updateResponse: response\n    }\n  };\n} catch (error) {\n  console.log('âŒ Erro ao atualizar contexto:', error.message);\n  \n  return {\n    json: {\n      ...correcaoData,\n      contextUpdated: false,\n      error: error.message\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        27392,
        96
      ],
      "id": "9a7a9f46-30ef-4fdc-9510-c55ef65dfe40",
      "name": "FASE2: 7. Atualizar Contexto1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://web-production-c9eaf.up.railway.app/api/n8n/food-calibration/suggestions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  patientId: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.patientId,\n  foodName: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.originalFood || 'Alimento',\n  foodType: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.feedbackData?.foodType || 'outros',\n  aiEstimate: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.originalWeight || 100,\n  userCorrection: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.newWeight || 100,\n  conversationId: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.conversationId\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        26496,
        608
      ],
      "id": "89e47c9c-c490-49ce-b851-a7511656744c",
      "name": "FASE2: 6a-3. Enviar para SugestÃµes",
      "onError": "continueRegularOutput",
      "notes": "Envia a correÃ§Ã£o de peso para a aba de SugestÃµes no Calibration Studio.\nO nutricionista pode aprovar ou rejeitar antes de entrar no aprendizado oficial.\n\nURL: /api/n8n/food-calibration/suggestions\nBody: { patientId, foodName, foodType, aiEstimate, userCorrection, conversationId }"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasSuggestions }}",
              "value2": true
            }
          ]
        }
      },
      "id": "c3502878-bf1b-4dca-8ea9-b19cc3dbfac6",
      "name": "Tem SugestÃµes?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        26048,
        320
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'https://web-production-c9eaf.up.railway.app' }}/api/n8n/food-calibration/suggestions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "={{ $env.N8N_WEBHOOK_SECRET || 'nutribuddy-secret-2024' }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"patientId\": \"{{ $json.patientId }}\",\n  \"foodName\": \"{{ $json.suggestionsToSave[0].foodName }}\",\n  \"foodType\": \"{{ $json.suggestionsToSave[0].foodType }}\",\n  \"aiEstimate\": {{ $json.suggestionsToSave[0].aiEstimate || 100 }},\n  \"userCorrection\": {{ $json.suggestionsToSave[0].userCorrection || 100 }},\n  \"conversationId\": \"{{ $json.conversationId }}\"\n}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "2ed8b3a4-e834-496d-90cb-7b4396b83847",
      "name": "Salvar SugestÃ£o no Studio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        26272,
        240
      ],
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Envia correÃ§Ã£o do paciente para a aba SugestÃµes do Calibration Studio.\n\nO nutricionista pode aprovar ou rejeitar."
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 6a-0. PREPARAR PROMPT VISION (V4 - MULTI-ITEM FIX)\n// =====================================================\n// Prompt profissional para anÃ¡lise de refeiÃ§Ãµes brasileiras\n// CORREÃ‡ÃƒO: ForÃ§a detecÃ§Ã£o de MÃšLTIPLOS ITENS separados\n// Inclui: densidade, perspectiva, recipientes, macros precisos\n// =====================================================\n\nconst dietResponse = $('5a. Buscar Dieta (FOTO)').first().json || {};\nconst dietData = dietResponse.data || {};\nconst brazilTime = new Date().toLocaleString(\"en-US\", {\n  timeZone: \"America/Sao_Paulo\",\n});\nconst now = new Date(brazilTime);\nconst currentHour = now.getHours();\n\n// --- BUSCAR CONFUSÃ•ES APRENDIDAS ---\nlet learnedHints = '';\ntry {\n  const confusionsResponse = await this.helpers.httpRequest({\n    method: 'GET',\n    url: 'https://web-production-c9eaf.up.railway.app/api/n8n/food-type-confusions/active',\n    headers: { 'X-Webhook-Secret': 'nutribuddy-secret-2024' }\n  });\n  \n  if (confusionsResponse && confusionsResponse.confusions && confusionsResponse.confusions.length > 0) {\n     learnedHints = `\\n\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ§  APRENDIZADO RECENTE (ATENÃ‡ÃƒO!)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` + \n     confusionsResponse.promptText +\n     `\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;\n  }\n} catch (e) {\n  console.log('âš ï¸ Erro ao buscar aprendizados de confusÃ£o');\n}\n\n// Identificar refeiÃ§Ã£o pelo horÃ¡rio\nlet mealType = 'RefeiÃ§Ã£o';\nlet prescribedMeal = null;\n\nif (dietData.meals && Array.isArray(dietData.meals)) {\n  if (currentHour >= 5 && currentHour < 9) {\n    mealType = 'CafÃ© da ManhÃ£';\n    prescribedMeal = dietData.meals.find(m => m.name && (m.name.toLowerCase().includes('cafÃ©') || m.name.toLowerCase().includes('desjejum')));\n  } else if (currentHour >= 9 && currentHour < 11) {\n    mealType = 'Lanche da ManhÃ£';\n    prescribedMeal = dietData.meals.find(m => m.name && m.name.toLowerCase().includes('colaÃ§Ã£o'));\n  } else if (currentHour >= 11 && currentHour < 15) {\n    mealType = 'AlmoÃ§o';\n    prescribedMeal = dietData.meals.find(m => m.name && m.name.toLowerCase().includes('almoÃ§o'));\n  } else if (currentHour >= 15 && currentHour < 19) {\n    mealType = 'Lanche da Tarde';\n    prescribedMeal = dietData.meals.find(m => m.name && m.name.toLowerCase().includes('lanche'));\n  } else {\n    mealType = 'Jantar';\n    prescribedMeal = dietData.meals.find(m => m.name && (m.name.toLowerCase().includes('jantar') || m.name.toLowerCase().includes('ceia')));\n  }\n}\n\n// Ã‚ncora da dieta prescrita\nlet dietAnchor = '';\nif (prescribedMeal && prescribedMeal.foods && prescribedMeal.foods.length > 0) {\n  const foodsList = prescribedMeal.foods.map(f => {\n    const amount = f.amount || f.quantidade || '?';\n    const unit = f.unit || f.unidade || 'g';\n    const name = f.name || f.nome || 'Alimento';\n    return `  â€¢ ${amount}${unit} ${name}`;\n  }).join('\\n');\n  \n  dietAnchor = `\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘ ðŸŽ¯ DIETA PRESCRITA: ${mealType.toUpperCase()}\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n${foodsList}\n\nâš¡ Se o alimento parecer SIMILAR ao prescrito, use o peso da\n   prescriÃ§Ã£o como base (ajuste Â±20% conforme visual).\n`;\n}\n\n// =============================================================\n// PROMPT V4 - COM CORREÃ‡ÃƒO DE MULTI-ITEM\n// =============================================================\n\nconst promptVision = `VocÃª Ã© um NUTRICIONISTA BRASILEIRO especialista em anÃ¡lise visual de refeiÃ§Ãµes.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸŽ¯ MISSÃƒO: Identificar TODOS os alimentos e estimar pesos com precisÃ£o\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${learnedHints}\n\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ ðŸ“‹ FORMATO DE RESPOSTA (APENAS JSON VÃLIDO, SEM MARKDOWN)  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n{\n  \"alimentos\": [\n    {\n      \"nome\": \"Nome do alimento em portuguÃªs\",\n      \"peso_gramas\": 150,\n      \"confianca\": \"alta|media|baixa\",\n      \"macros\": {\n        \"proteinas\": 30.0,\n        \"carboidratos\": 0.0,\n        \"gorduras\": 5.0,\n        \"calorias\": 165\n      }\n    }\n  ],\n  \"macros_totais\": {\n    \"proteinas\": 30.0,\n    \"carboidratos\": 45.0,\n    \"gorduras\": 12.0,\n    \"calorias\": 408\n  },\n  \"observacoes\": \"Resumo de 1 linha (NÃƒO substitui a lista de alimentos)\"\n}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ”Ž REGRAS DE DETECÃ‡ÃƒO MULTI-ITEM (OBRIGATÃ“RIO)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. IDENTIFIQUE CADA ALIMENTO SEPARADAMENTE:\n   âŒ ERRADO: \"Prato com risoto e frutos do mar\"\n   âœ… CERTO: Lista separada:\n      â€¢ Risoto cremoso: 300g\n      â€¢ CamarÃµes grelhados: 90g\n      â€¢ Tomates cereja: 30g\n      â€¢ Ervas (salsinha/manjericÃ£o): 5g\n\n2. NUNCA AGRUPE EM UMA DESCRIÃ‡ÃƒO GENÃ‰RICA:\n   - Sempre liste CADA componente individualmente\n   - Inclua TODOS os itens visÃ­veis: prato principal, acompanhamentos, bebidas\n   - GuarniÃ§Ãµes e temperos tambÃ©m devem ser listados\n\n3. BEBIDAS E EXTRAS (NUNCA IGNORE):\n   - Se houver copo/garrafa â†’ Identifique a bebida (suco, Ã¡gua, refrigerante)\n   - Se houver molho/condimento â†’ Liste separadamente\n   - Se houver salada ao lado â†’ Liste como item separado\n   - Se houver pÃ£o/torradas â†’ Liste como item separado\n\n4. MÃNIMO DE ITENS ESPERADO:\n   - Uma foto de refeiÃ§Ã£o tÃ­pica deve ter 2-5 itens\n   - Se vocÃª identificou apenas 1 item, OLHE NOVAMENTE com mais atenÃ§Ã£o\n   - Verifique: acompanhamentos, guarniÃ§Ãµes, bebidas, temperos\n\n5. EXEMPLO CORRETO DE ANÃLISE:\n   Foto de risoto com frutos do mar e copo de suco deve retornar:\n   - Risoto cremoso: 280g\n   - CamarÃµes: 80g\n   - Lagosta/lula (se houver): 50g\n   - Tomates cereja: 25g\n   - Ervas: 5g\n   - Suco de laranja: 200ml\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ“ REGRAS DE PERSPECTIVA (CRÃTICO PARA PESO CORRETO)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n- FOTO DE CIMA (90Â°): Alimento parece MENOR â†’ Adicione +20%\n- FOTO DIAGONAL (45Â°): ReferÃªncia mais confiÃ¡vel\n- FOTO DE FRENTE: DifÃ­cil ver profundidade â†’ Seja conservador\n- SOMBRA GRANDE: Indica altura â†’ Alimento mais volumoso\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ“¦ TAMANHOS DE RECIPIENTES BRASILEIROS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nPRATOS:\n- Prato de sobremesa (15-18cm): 150-250g de comida\n- Prato raso mÃ©dio (22-24cm): 300-450g de comida\n- Prato raso grande (26-28cm): 450-600g de comida\n- Prato fundo: 400-550g de comida\n\nMARMITAS:\n- Marmita P (retangular pequena): 300-400g\n- Marmita M (quadrada mÃ©dia): 450-550g\n- Marmita G (retangular grande): 600-800g\n- Marmita fitness (compartimentos): 400-500g total\n\nCOPOS E BEBIDAS:\n- Copo americano: 190ml\n- Copo long drink: 300ml\n- Copo de suco mÃ©dio: 250ml\n- Garrafa pequena: 300-350ml\n- Lata de refrigerante: 350ml\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš–ï¸ DENSIDADE DOS ALIMENTOS (IMPORTANTE!)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nALIMENTOS DENSOS (pesam MAIS do que parecem):\n- Arroz cozido compactado: 1.1-1.3 g/cmÂ³\n- FeijÃ£o/lentilha: 1.2-1.4 g/cmÂ³\n- PurÃª de batata: 1.1 g/cmÂ³\n- Carne moÃ­da: 1.0-1.1 g/cmÂ³\n\nALIMENTOS LEVES (pesam MENOS do que parecem):\n- Salada de folhas: 0.2-0.4 g/cmÂ³\n- Pipoca: 0.03-0.05 g/cmÂ³\n- Arroz solto/aerado: 0.6-0.8 g/cmÂ³\n- MacarrÃ£o cozido: 0.7-0.9 g/cmÂ³\n\nREFERÃŠNCIA PADRÃƒO:\n- Carne sÃ³lida: 1.0 g/cmÂ³\n- Ãgua: 1.0 g/cmÂ³\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ¥© TABELA NUTRICIONAL BRASILEIRA (por 100g)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nPROTEÃNAS:\n- Frango grelhado: 31g prot, 3g gord, 0g carb = 165 kcal\n- Carne bovina magra: 26g prot, 7g gord, 0g carb = 170 kcal\n- Carne bovina gorda: 20g prot, 15g gord, 0g carb = 220 kcal\n- Peixe branco: 20g prot, 2g gord, 0g carb = 100 kcal\n- SalmÃ£o: 20g prot, 12g gord, 0g carb = 190 kcal\n- Ovo inteiro: 13g prot, 11g gord, 1g carb = 155 kcal\n- CamarÃ£o: 24g prot, 1g gord, 0g carb = 106 kcal\n- Lagosta: 20g prot, 1g gord, 1g carb = 90 kcal\n\nCARBOIDRATOS:\n- Arroz branco: 2.5g prot, 0.3g gord, 28g carb = 130 kcal\n- Arroz integral: 2.6g prot, 0.9g gord, 23g carb = 111 kcal\n- Risoto cremoso: 3g prot, 4g gord, 22g carb = 140 kcal\n- FeijÃ£o carioca: 5g prot, 0.5g gord, 14g carb = 77 kcal\n- Batata cozida: 2g prot, 0.1g gord, 17g carb = 77 kcal\n- MacarrÃ£o cozido: 5g prot, 0.9g gord, 25g carb = 131 kcal\n\nVEGETAIS:\n- Salada mista: 1.5g prot, 0.2g gord, 3g carb = 18 kcal\n- Tomate cereja: 0.9g prot, 0.2g gord, 4g carb = 18 kcal\n- BrÃ³colis: 2.8g prot, 0.4g gord, 7g carb = 34 kcal\n\nBEBIDAS (por 100ml):\n- Suco de laranja natural: 0.7g prot, 0.2g gord, 10g carb = 45 kcal\n- Suco de uva integral: 0.5g prot, 0.1g gord, 14g carb = 60 kcal\n- Refrigerante: 0g prot, 0g gord, 10g carb = 40 kcal\n- Ãgua de coco: 0.2g prot, 0.2g gord, 4g carb = 19 kcal\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ½ï¸ PRATOS BRASILEIROS TÃPICOS (IDENTIFICAR COMPONENTES)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nRISOTO FRUTOS DO MAR (porÃ§Ã£o tÃ­pica 400g total):\n- Risoto cremoso: 280-320g\n- CamarÃµes: 60-100g\n- Lula/polvo: 30-50g\n- Tomates/ervas: 20-30g\n\nPF TÃPICO (porÃ§Ã£o tÃ­pica 500g total):\n- Arroz: 150-200g\n- FeijÃ£o: 100-150g\n- Carne/frango: 100-150g\n- Salada: 50-80g\n\nSALGADOS (individuais):\n- Coxinha mÃ©dia: 80-120g = 250-350 kcal\n- Esfiha fechada: 60-80g = 150-200 kcal\n- Pastel mÃ©dio frito: 100-150g = 300-450 kcal\n- PÃ£o de queijo mÃ©dio: 25-35g = 80-120 kcal\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš ï¸ REGRAS ABSOLUTAS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. ðŸ”´ SEMPRE LISTE CADA COMPONENTE SEPARADAMENTE:\n   âŒ Nunca retorne apenas: \"Prato de risoto com frutos do mar\"\n   âœ… Sempre retorne: risoto + camarÃ£o + lula + tomate + ervas\n\n2. ðŸ”´ INCLUA BEBIDAS SE VISÃVEIS:\n   - Copo na foto? Liste a bebida!\n   - Garrafa na foto? Liste!\n\n3. ðŸ”´ ARREDONDAMENTO:\n   - Arredondar para mÃºltiplos de 10g (ex: 147g â†’ 150g)\n   - Em dÃºvida â†’ arredonde PARA CIMA\n   - ProteÃ­na â†’ seja GENEROSO (melhor errar pra mais)\n\n4. ðŸ”´ TODOS OS PESOS DEVEM SER > 0:\n   - NUNCA retorne peso_gramas: 0\n   - Se nÃ£o conseguir estimar, use 100g como padrÃ£o\n   - Estime sempre, mesmo com baixa confianÃ§a\n\n5. ðŸ”´ RETORNE APENAS JSON VÃLIDO:\n   - Sem markdown (\\`\\`\\`)\n   - Sem explicaÃ§Ãµes extras\n   - NÃºmeros como nÃºmeros, nÃ£o strings\n${dietAnchor}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸŽ¯ ANALISE A FOTO AGORA! LISTE CADA ITEM SEPARADAMENTE!\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;\n\nreturn {\n  json: {\n    promptVision: promptVision,\n    mealType: mealType,\n    hasDiet: !!prescribedMeal,\n    currentHour: currentHour,\n    promptVersion: 'V4-MULTI-ITEM'\n  }\n};\n"
      },
      "id": "476f6c29-f664-42c4-9bcb-37e8c2c14afa",
      "name": "6a-0. Preparar Prompt Vision1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        24576,
        -720
      ],
      "notes": "V2 - PROMPT OTIMIZADO PARA COMIDAS BRASILEIRAS\n\nInclui:\n- Lista de pratos brasileiros comuns\n- ReferÃªncias visuais de peso\n- Regras crÃ­ticas para nÃ£o confundir ingredientes\n- Ã‚ncora da dieta prescrita\n\nEvita erros como:\n- Torta de frango â†’ 'creme + Ã³leo'\n- Strogonoff â†’ 'creme de leite'"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// FASE2: 1. Criar Contexto Inicial (versÃ£o CODE)\n// =====================================================\n\nconst itemData = $('1. Validar e Processar').first().json;\nconst visionData = $('7a-3. Aplicar Aprendizado1').first().json || {};\nconst mealData = $('11a-bis. Registrar RefeiÃ§Ã£o AutomÃ¡tica').first().json || {};\n\nconst conversationId = itemData.conversationId;\nconst patientId = itemData.patientId;\nconst prescriberId = itemData.prescriberId;\n\nif (!conversationId || !patientId) {\n  console.log('âš ï¸ Sem conversationId ou patientId, pulando criaÃ§Ã£o de contexto');\n  return { json: { ...itemData, contextCreated: false } };\n}\n\nconst body = {\n  type: 'meal_logging',\n  patientId: patientId,\n  prescriberId: prescriberId,\n  data: {\n    draftId: mealData.draftId || null,\n    foods: (visionData.analise_foto || {}).alimentos || [],\n    macros: (visionData.analise_foto || {}).macros_totais || {}\n  }\n};\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: `https://web-production-c9eaf.up.railway.app/api/n8n/conversations/${conversationId}/context`,\n    headers: {\n      'X-Webhook-Secret': 'nutribuddy-secret-2024',\n      'Content-Type': 'application/json'\n    },\n    body: body\n  });\n  \n  console.log('âœ… Contexto criado:', response);\n  return { json: { ...itemData, contextCreated: true, contextResponse: response } };\n  \n} catch (error) {\n  console.log('âŒ Erro ao criar contexto:', error.message);\n  return { json: { ...itemData, contextCreated: false, error: error.message } };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        31456,
        -720
      ],
      "id": "fd5240dd-a903-4e06-bb1d-9ff49c69e013",
      "name": "FASE2: 1. Criar Contexto Inicial1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"max_tokens\": 1500,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"VocÃª Ã© um nutricionista brasileiro especializado em anÃ¡lise de alimentos por imagem. Retorne APENAS JSON vÃ¡lido, sem markdown, sem explicaÃ§Ãµes.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"text\",\n          \"text\": \"Analise esta foto de refeiÃ§Ã£o. Liste os alimentos identificados com: nome, peso estimado em gramas, e macros (proteÃ­nas, carboidratos, gorduras, calorias). Retorne APENAS JSON vÃ¡lido no formato: {\\\"alimentos\\\": [{\\\"nome\\\": \\\"...\\\", \\\"peso_gramas\\\": 100, \\\"macros\\\": {\\\"proteinas\\\": 0, \\\"carboidratos\\\": 0, \\\"gorduras\\\": 0, \\\"calorias\\\": 0}}], \\\"macros_totais\\\": {\\\"proteinas\\\": 0, \\\"carboidratos\\\": 0, \\\"gorduras\\\": 0, \\\"calorias\\\": 0}}\"\n        },\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": \"{{ $('1. Validar e Processar').first().json.mediaUrl || $('1. Validar e Processar').first().json.imageUrl }}\",\n            \"detail\": \"high\"\n          }\n        }\n      ]\n    }\n  ]\n}\n",
        "options": {
          "timeout": 60000
        }
      },
      "id": "80d6eb9e-e2aa-4f18-98c9-ed8f8ad47185",
      "name": "6a. Analisar Foto (GPT-4 Vision)1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        26496,
        -720
      ],
      "notesInFlow": true,
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      },
      "onError": "continueRegularOutput",
      "notes": "Chama GPT-4o Vision para analisar foto de refeiÃ§Ã£o.\n\nEntradas:\n- 6a-0: Prompt preparado com dieta como Ã¢ncora\n- 6a-2: Imagem em Base64\n\nSaÃ­da: JSON com alimentos, pesos e macros"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 7a. PARSE GPT-4 VISION (Substitui PARSE-PASSIO)\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst gptResponse = currentItem;\n\nconsole.log('ðŸ“Š [Parse Vision] Processando resposta GPT-4o...');\n\n// Extrair resposta do GPT-4\nlet content = '';\ntry {\n  if (gptResponse.choices && gptResponse.choices[0]) {\n    content = gptResponse.choices[0].message?.content || '';\n  }\n} catch (e) {\n  console.error('âŒ [Parse Vision] Erro ao extrair resposta:', e.message);\n  content = '';\n}\n\nconsole.log('ðŸ“ [Parse Vision] ConteÃºdo raw:', content.substring(0, 200) + '...');\n\n// Limpar markdown se houver\nlet jsonString = content\n  .replace(/```json\\n?/gi, '')\n  .replace(/```\\n?/gi, '')\n  .trim();\n\n// Tentar parsear JSON\nlet parsed = {\n  alimentos: [],\n  macros_totais: { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 },\n  observacoes: 'NÃ£o foi possÃ­vel analisar a imagem'\n};\n\ntry {\n  parsed = JSON.parse(jsonString);\n  console.log('âœ… [Parse Vision] JSON parseado com sucesso');\n  console.log('ðŸ½ï¸ [Parse Vision] Alimentos encontrados:', parsed.alimentos?.length || 0);\n} catch (e) {\n  console.error('âŒ [Parse Vision] Erro ao parsear JSON:', e.message);\n  console.error('âŒ [Parse Vision] String recebida:', jsonString.substring(0, 500));\n  \n  // Tentar extrair JSON de dentro do texto\n  const jsonMatch = jsonString.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    try {\n      parsed = JSON.parse(jsonMatch[0]);\n      console.log('âœ… [Parse Vision] JSON extraÃ­do com regex');\n    } catch (e2) {\n      console.error('âŒ [Parse Vision] Regex tambÃ©m falhou');\n    }\n  }\n}\n\n// Garantir estrutura correta\nif (!parsed.alimentos) parsed.alimentos = [];\nif (!parsed.macros_totais) {\n  parsed.macros_totais = { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 };\n}\n\n// Recalcular macros totais se necessÃ¡rio\nif (parsed.alimentos.length > 0 && (!parsed.macros_totais.calorias || parsed.macros_totais.calorias === 0)) {\n  parsed.macros_totais = parsed.alimentos.reduce((acc, food) => {\n    const macros = food.macros || {};\n    return {\n      proteinas: acc.proteinas + (macros.proteinas || 0),\n      carboidratos: acc.carboidratos + (macros.carboidratos || 0),\n      gorduras: acc.gorduras + (macros.gorduras || 0),\n      calorias: acc.calorias + (macros.calorias || 0)\n    };\n  }, { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 });\n}\n\n// Formatar para o resto do workflow\nconst formattedResponse = {\n  alimentos: parsed.alimentos.map(food => ({\n    nome: food.nome || food.name || 'Alimento',\n    peso_gramas: food.peso_gramas || food.weight || 100,\n    peso_minimo: food.peso_minimo || Math.round((food.peso_gramas || 100) * 0.8),\n    peso_maximo: food.peso_maximo || Math.round((food.peso_gramas || 100) * 1.2),\n    confianca: food.confianca || 'media',\n    macros: {\n      proteinas: food.macros?.proteinas || food.macros?.protein || 0,\n      carboidratos: food.macros?.carboidratos || food.macros?.carbs || 0,\n      gorduras: food.macros?.gorduras || food.macros?.fat || 0,\n      calorias: food.macros?.calorias || food.macros?.calories || 0\n    }\n  })),\n  macros_totais: {\n    proteinas: Math.round(parsed.macros_totais.proteinas || 0),\n    carboidratos: Math.round(parsed.macros_totais.carboidratos || 0),\n    gorduras: Math.round(parsed.macros_totais.gorduras || 0),\n    calorias: Math.round(parsed.macros_totais.calorias || 0)\n  },\n  observacoes: parsed.observacoes || '',\n  fonte: 'gpt-4-vision'\n};\n\nconsole.log('ðŸ“Š [Parse Vision] Resultado final:', {\n  alimentosCount: formattedResponse.alimentos.length,\n  totalCalorias: formattedResponse.macros_totais.calorias\n});\n\n// Pegar dados do item original\nconst originalItem = $('6a-2. Converter para Base64').first().json;\n\nreturn {\n  json: {\n    ...originalItem,\n    analise_foto: formattedResponse,\n    gpt_vision_raw: content\n  }\n};"
      },
      "id": "b52c77a1-b010-47f5-8f6f-502e35d2f587",
      "name": "7a. PARSE-VISION1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        26720,
        -720
      ],
      "notes": "Parseia a resposta do GPT-4 Vision.\n\nExtrai JSON com alimentos, pesos e macros.\nFormata para o resto do workflow entender."
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 7a-3. APLICAR APRENDIZADO DO FIREBASE\n// =====================================================\n// Este nÃ³ aplica correÃ§Ãµes aprendidas aos pesos da Vision AI\n// Se nÃ£o houver correÃ§Ãµes, passa os dados sem modificar\n// =====================================================\n\nconst dadosVision = $('7a. PARSE-VISION1').first().json;\n\n// Buscar correÃ§Ãµes do Firebase (pode estar vazio)\nlet correcoesAprendidas = {};\ntry {\n  const firebaseResponse = $('7a-2. Buscar CorreÃ§Ãµes Firebase').first().json;\n  const learnings = firebaseResponse.learnings || firebaseResponse.data || [];\n  if (firebaseResponse && firebaseResponse.success && learnings.length > 0) {\n    learnings.forEach(l => {\n      correcoesAprendidas[l.foodType] = {\n        correctionFactor: l.avgCorrectionFactor,\n        confidence: l.confidence,\n        totalSamples: l.totalSamples\n      };\n    });\n    console.log('ðŸ§  CorreÃ§Ãµes carregadas:', Object.keys(correcoesAprendidas).length);\n  }\n} catch (e) {\n  console.log('âš ï¸ Firebase nÃ£o disponÃ­vel, continuando sem correÃ§Ãµes');\n}\n\n// Se nÃ£o tem anÃ¡lise de foto, passa direto\nif (!dadosVision.analise_foto || !dadosVision.analise_foto.alimentos) {\n  console.log('âš ï¸ Sem alimentos para processar');\n  return { json: dadosVision };\n}\n\n// FunÃ§Ã£o para normalizar nome do alimento\nfunction normalizar(nome) {\n  return (nome || '')\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/[^a-z0-9 ]/g, '')\n    .trim()\n    .split(' ')[0]; // Pega primeira palavra\n}\n\n// Aplicar correÃ§Ãµes aos alimentos\nlet correcoesAplicadas = 0;\nconst alimentosCorrigidos = dadosVision.analise_foto.alimentos.map(alimento => {\n  const nomeNormalizado = normalizar(alimento.nome || alimento.nome_original);\n  const pesoOriginal = alimento.peso_gramas || 100;\n  \n  // Verificar se existe correÃ§Ã£o aprendida\n  const correcao = correcoesAprendidas[nomeNormalizado];\n  \n  if (correcao && correcao.confidence >= 0.4) {\n    // Aplicar fator de correÃ§Ã£o\n    const pesoCorrigido = Math.round(pesoOriginal * correcao.correctionFactor);\n    const fator = correcao.correctionFactor;\n    \n    console.log(`ðŸ§  ${alimento.nome}: ${pesoOriginal}g x ${fator.toFixed(2)} = ${pesoCorrigido}g`);\n    \n    // Ajustar macros proporcionalmente\n    const macrosAjustados = alimento.macros ? {\n      proteinas: Math.round((alimento.macros.proteinas || 0) * fator * 10) / 10,\n      carboidratos: Math.round((alimento.macros.carboidratos || 0) * fator * 10) / 10,\n      gorduras: Math.round((alimento.macros.gorduras || 0) * fator * 10) / 10,\n      calorias: Math.round((alimento.macros.calorias || 0) * fator)\n    } : alimento.macros;\n    \n    correcoesAplicadas++;\n    \n    return {\n      ...alimento,\n      peso_gramas: pesoCorrigido,\n      _peso_original_vision: pesoOriginal,\n      _correcao_aplicada: true,\n      _fator_correcao: fator,\n      _confianca_correcao: correcao.confidence,\n      macros: macrosAjustados\n    };\n  }\n  \n  // Sem correÃ§Ã£o, retorna original\n  return {\n    ...alimento,\n    _correcao_aplicada: false\n  };\n});\n\n// Recalcular totais se houve correÃ§Ãµes\nlet macrosTotais = dadosVision.analise_foto.macros_totais;\nif (correcoesAplicadas > 0) {\n  macrosTotais = alimentosCorrigidos.reduce((total, al) => ({\n    proteinas: Math.round((total.proteinas + (al.macros?.proteinas || 0)) * 10) / 10,\n    carboidratos: Math.round((total.carboidratos + (al.macros?.carboidratos || 0)) * 10) / 10,\n    gorduras: Math.round((total.gorduras + (al.macros?.gorduras || 0)) * 10) / 10,\n    calorias: Math.round(total.calorias + (al.macros?.calorias || 0))\n  }), { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 });\n}\n\nconsole.log(`âœ… ${correcoesAplicadas} correÃ§Ã£o(Ãµes) aplicada(s)`);\n\n// Retornar dados atualizados\nreturn {\n  json: {\n    ...dadosVision,\n    analise_foto: {\n      ...dadosVision.analise_foto,\n      alimentos: alimentosCorrigidos,\n      macros_totais: macrosTotais,\n      _aprendizado_aplicado: correcoesAplicadas > 0,\n      _total_correcoes: correcoesAplicadas,\n      _correcoes_disponiveis: Object.keys(correcoesAprendidas).length\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        27168,
        -720
      ],
      "id": "e9fa154b-4586-4d3f-beb3-de4b30799862",
      "name": "7a-3. Aplicar Aprendizado1"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 11a-bis. REGISTRAR REFEIÃ‡ÃƒO (V5 - HÃBRIDO INTELIGENTE)\n// =====================================================\n// LÃ“GICA:\n// 1. Texto do paciente = BASE (o que ele disse, registra)\n// 2. AnÃ¡lise da foto = SUGESTÃ•ES (mostra diferenÃ§as para confirmar)\n// 3. Salva comparaÃ§Ã£o para aprendizado\n// =====================================================\n\nconst itemData = $('1. Validar e Processar').first().json;\n\n// Buscar anÃ¡lise da foto\nlet analiseData = {};\ntry {\n  analiseData = $('7a-3. Aplicar Aprendizado1').first().json;\n} catch (e) {\n  try {\n    analiseData = $('7a. PARSE-VISION1').first().json;\n  } catch (e2) {\n    analiseData = {};\n  }\n}\n\nconst patientId = itemData.patientId;\nconst conversationId = itemData.conversationId;\nconst mediaUrl = itemData.mediaUrl || null;\n\n// =====================================================\n// VALIDAÃ‡ÃƒO\n// =====================================================\n\nif (!patientId) {\n  return { json: { ...itemData, mealRegistered: false, reason: 'no_patient_id' } };\n}\n\n// =====================================================\n// EXTRAIR DADOS\n// =====================================================\n\nconst temFoto = !!(mediaUrl || itemData.attachments?.some(a => a.type === 'image'));\nconst recordatorio = itemData.recordatorio || {};\nconst textoDescritivo = recordatorio.textoDescritivo || itemData.content || '';\nconst analiseFoto = analiseData.analise_foto || {};\nconst alimentosFoto = analiseFoto.alimentos || [];\n\nconsole.log('ðŸ“· Tem foto:', temFoto);\nconsole.log('ðŸ“ Texto paciente:', textoDescritivo);\nconsole.log('ðŸ” Alimentos da foto:', alimentosFoto.length);\n\n// =====================================================\n// TABELA DE MACROS\n// =====================================================\n\nconst MACROS = {\n  'ovo': { nome: 'Ovo', peso: 50, p: 6.5, c: 0.5, g: 5, cal: 70 },\n  'ovos': { nome: 'Ovo', peso: 50, p: 6.5, c: 0.5, g: 5, cal: 70 },\n  'queijo': { nome: 'Queijo', peso: 20, p: 5, c: 0.5, g: 6, cal: 75 },\n  'frango': { nome: 'Frango', peso: 100, p: 31, c: 0, g: 3.6, cal: 165 },\n  'tapioca': { nome: 'Tapioca', peso: 30, p: 0.1, c: 26, g: 0, cal: 100 },\n  'crepioca': { nome: 'Crepioca', peso: 150, p: 15, c: 30, g: 8, cal: 250 },\n  'arroz': { nome: 'Arroz', peso: 100, p: 2.5, c: 28, g: 0.3, cal: 130 },\n  'feijÃ£o': { nome: 'FeijÃ£o', peso: 100, p: 9, c: 23, g: 0.5, cal: 127 },\n  'carne': { nome: 'Carne', peso: 100, p: 26, c: 0, g: 15, cal: 250 },\n  'banana': { nome: 'Banana', peso: 100, p: 1.1, c: 23, g: 0.3, cal: 89 },\n  'pÃ£o': { nome: 'PÃ£o', peso: 50, p: 4, c: 28, g: 1.5, cal: 135 },\n  'batata': { nome: 'Batata', peso: 100, p: 2, c: 17, g: 0.1, cal: 77 },\n  'salada': { nome: 'Salada', peso: 100, p: 1, c: 3, g: 0.2, cal: 20 },\n};\n\n// =====================================================\n// FUNÃ‡ÃƒO: PARSEAR TEXTO DO PACIENTE\n// =====================================================\n\nfunction parsearTexto(texto) {\n  if (!texto || texto.length < 3) return [];\n  \n  const alimentos = [];\n  const textoLower = texto.toLowerCase();\n  let match;\n  \n  // \"Xg de alimento\"\n  const padraoGramas = /(\\d+)\\s*(?:g|gramas?)\\s+(?:de\\s+)?(\\w+)/gi;\n  while ((match = padraoGramas.exec(textoLower)) !== null) {\n    const qtd = parseInt(match[1]);\n    const nome = match[2];\n    const dados = MACROS[nome];\n    if (dados) {\n      const fator = qtd / dados.peso;\n      alimentos.push({\n        nome: `${qtd}g de ${dados.nome}`,\n        nome_normalizado: nome,\n        peso_gramas: qtd,\n        fonte: 'texto',\n        macros: {\n          proteinas: Math.round(dados.p * fator * 10) / 10,\n          carboidratos: Math.round(dados.c * fator * 10) / 10,\n          gorduras: Math.round(dados.g * fator * 10) / 10,\n          calorias: Math.round(dados.cal * fator)\n        }\n      });\n    }\n  }\n  \n  // \"X fatia(s) de alimento\"\n  const padraoFatias = /(\\d+)\\s+fatia(?:s)?\\s+(?:de\\s+)?(\\w+)/gi;\n  while ((match = padraoFatias.exec(textoLower)) !== null) {\n    const qtd = parseInt(match[1]);\n    const nome = match[2];\n    const dados = MACROS[nome];\n    if (dados) {\n      alimentos.push({\n        nome: `${qtd} fatia(s) de ${dados.nome}`,\n        nome_normalizado: nome,\n        peso_gramas: dados.peso * qtd,\n        fonte: 'texto',\n        macros: {\n          proteinas: Math.round(dados.p * qtd * 10) / 10,\n          carboidratos: Math.round(dados.c * qtd * 10) / 10,\n          gorduras: Math.round(dados.g * qtd * 10) / 10,\n          calorias: Math.round(dados.cal * qtd)\n        }\n      });\n    }\n  }\n  \n  // \"X colher(es) de alimento\"\n  const padraoColheres = /(\\d+)\\s+colher(?:es)?\\s+(?:de\\s+)?(\\w+)/gi;\n  while ((match = padraoColheres.exec(textoLower)) !== null) {\n    const qtd = parseInt(match[1]);\n    const nome = match[2];\n    const dados = MACROS[nome];\n    if (dados) {\n      const pesoColher = nome === 'tapioca' ? 15 : 20;\n      const fator = (pesoColher * qtd) / dados.peso;\n      alimentos.push({\n        nome: `${qtd} colher(es) de ${dados.nome}`,\n        nome_normalizado: nome,\n        peso_gramas: pesoColher * qtd,\n        fonte: 'texto',\n        macros: {\n          proteinas: Math.round(dados.p * fator * 10) / 10,\n          carboidratos: Math.round(dados.c * fator * 10) / 10,\n          gorduras: Math.round(dados.g * fator * 10) / 10,\n          calorias: Math.round(dados.cal * fator)\n        }\n      });\n    }\n  }\n  \n  // \"X ovos/bananas/etc\"\n  const padraoUnidades = /(\\d+)\\s+(ovos?|bananas?|pÃ£o|pÃ£es)/gi;\n  while ((match = padraoUnidades.exec(textoLower)) !== null) {\n    const qtd = parseInt(match[1]);\n    let nome = match[2].toLowerCase().replace(/s$/, '');\n    if (nome === 'pÃ£e') nome = 'pÃ£o';\n    \n    // Evitar duplicatas\n    if (alimentos.some(a => a.nome_normalizado === nome)) continue;\n    \n    const dados = MACROS[nome] || MACROS[nome + 's'];\n    if (dados) {\n      alimentos.push({\n        nome: `${qtd} ${dados.nome}`,\n        nome_normalizado: nome,\n        peso_gramas: dados.peso * qtd,\n        fonte: 'texto',\n        macros: {\n          proteinas: Math.round(dados.p * qtd * 10) / 10,\n          carboidratos: Math.round(dados.c * qtd * 10) / 10,\n          gorduras: Math.round(dados.g * qtd * 10) / 10,\n          calorias: Math.round(dados.cal * qtd)\n        }\n      });\n    }\n  }\n  \n  return alimentos;\n}\n\n// =====================================================\n// FUNÃ‡ÃƒO: NORMALIZAR NOME PARA COMPARAÃ‡ÃƒO\n// =====================================================\n\nfunction normalizar(nome) {\n  return (nome || '')\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/[^a-z]/g, '')\n    .replace(/s$/, '');\n}\n\n// =====================================================\n// PROCESSAR\n// =====================================================\n\nlet alimentosTexto = [];\nlet alimentosFotoNaoMencionados = [];\nlet alimentosParaRegistrar = [];\nlet macrosTotais = { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 };\n\n// 1. PARSEAR TEXTO DO PACIENTE\nif (textoDescritivo) {\n  alimentosTexto = parsearTexto(textoDescritivo);\n  console.log('âœ… Alimentos do texto:', alimentosTexto.length);\n}\n\n// 2. SE TEM TEXTO: COMPARAR COM FOTO PARA ENCONTRAR DIFERENÃ‡AS\nif (alimentosTexto.length > 0) {\n  // Usar texto como base\n  alimentosParaRegistrar = alimentosTexto;\n  \n  // Encontrar alimentos na foto que NÃƒO foram mencionados no texto\n  const nomesTexto = alimentosTexto.map(a => normalizar(a.nome_normalizado || a.nome));\n  \n  alimentosFotoNaoMencionados = alimentosFoto.filter(af => {\n    const nomeFoto = normalizar(af.nome);\n    return !nomesTexto.some(nt => \n      nomeFoto.includes(nt) || nt.includes(nomeFoto)\n    );\n  });\n  \n  console.log('ðŸ“· Alimentos na foto NÃƒO mencionados:', alimentosFotoNaoMencionados.map(a => a.nome));\n  \n} else if (alimentosFoto.length > 0) {\n  // 3. SEM TEXTO: USAR ANÃLISE DA FOTO\n  alimentosParaRegistrar = alimentosFoto;\n  console.log('ðŸ“· Usando anÃ¡lise da foto');\n  \n} else {\n  // 4. NEM TEXTO NEM FOTO IDENTIFICADA\n  console.log('âš ï¸ Nenhum alimento identificado');\n  return { \n    json: { \n      ...itemData, \n      mealRegistered: false, \n      reason: 'no_foods_detected'\n    } \n  };\n}\n\n// Calcular macros totais\nmacrosTotais = alimentosParaRegistrar.reduce((t, a) => ({\n  proteinas: Math.round((t.proteinas + (a.macros?.proteinas || 0)) * 10) / 10,\n  carboidratos: Math.round((t.carboidratos + (a.macros?.carboidratos || 0)) * 10) / 10,\n  gorduras: Math.round((t.gorduras + (a.macros?.gorduras || 0)) * 10) / 10,\n  calorias: Math.round(t.calorias + (a.macros?.calorias || 0))\n}), { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 });\n\nconsole.log('ðŸ“Š Macros totais:', macrosTotais);\n\n// =====================================================\n// REGISTRAR REFEIÃ‡ÃƒO\n// =====================================================\n\ntry {\n  const brazilTime = new Date().toLocaleString(\"en-US\", { timeZone: \"America/Sao_Paulo\" });\n  const nowBR = new Date(brazilTime);\n  const hour = nowBR.getHours();\n  const mealTime = `${String(hour).padStart(2, '0')}:${String(nowBR.getMinutes()).padStart(2, '0')}`;\n  \n  let mealType = 'snack';\n  if (hour >= 5 && hour < 11) mealType = 'breakfast';\n  else if (hour >= 11 && hour < 15) mealType = 'lunch';\n  else if (hour >= 18 && hour < 23) mealType = 'dinner';\n  else if (hour >= 23 || hour < 5) mealType = 'supper';\n\n  const requestBody = {\n    patientId: patientId,\n    conversationId: conversationId,\n    foods: alimentosParaRegistrar,\n    macros: {\n      calories: macrosTotais.calorias,\n      protein: macrosTotais.proteinas,\n      carbs: macrosTotais.carboidratos,\n      fats: macrosTotais.gorduras\n    },\n    imageUrl: mediaUrl,\n    description: textoDescritivo || 'RefeiÃ§Ã£o analisada por IA',\n    timestamp: itemData.timestamp || new Date().toISOString(),\n    mealTime: mealTime,\n    mealType: mealType,\n    fonte: alimentosTexto.length > 0 ? 'texto_paciente' : 'analise_foto'\n  };\n\n  console.log('ðŸ“¤ Registrando...');\n\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'https://web-production-c9eaf.up.railway.app/api/meals/log-auto',\n    headers: {\n      'X-Webhook-Secret': 'nutribuddy-secret-2024',\n      'Content-Type': 'application/json'\n    },\n    body: requestBody\n  });\n\n  console.log('âœ… Registrado!');\n\n  // =====================================================\n  // RETORNO COM DADOS PARA RESPOSTA INTELIGENTE\n  // =====================================================\n\n  return {\n    json: {\n      ...itemData,\n      \n      // Dados registrados\n      analise_foto: {\n        alimentos: alimentosParaRegistrar,\n        macros_totais: macrosTotais\n      },\n      \n      // ðŸ”¥ PARA A RESPOSTA: usar esses valores!\n      _alimentosRegistrados: alimentosParaRegistrar,\n      _macrosRegistrados: macrosTotais,\n      \n      // ðŸ”¥ PARA PERGUNTA: alimentos na foto que nÃ£o foram mencionados\n      _alimentosFotoNaoMencionados: alimentosFotoNaoMencionados,\n      _temSugestoesFoto: alimentosFotoNaoMencionados.length > 0,\n      \n      // ðŸ”¥ PARA APRENDIZADO\n      _comparacao: {\n        fonteUsada: alimentosTexto.length > 0 ? 'texto' : 'foto',\n        alimentosTexto: alimentosTexto,\n        alimentosFoto: alimentosFoto,\n        diferenca: alimentosFotoNaoMencionados\n      },\n      \n      mealRegistered: true,\n      registrationResponse: response\n    }\n  };\n\n} catch (error) {\n  console.log('âŒ Erro:', error.message);\n  return {\n    json: {\n      ...itemData,\n      mealRegistered: false,\n      error: error.message\n    }\n  };\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        30208,
        -720
      ],
      "id": "14171faa-e4ab-4aea-9504-9030d8656ea8",
      "name": "11a-bis. Registrar RefeiÃ§Ã£o AutomÃ¡tica"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// BUSCAR ALIMENTO NA FOOD DATABASE\n// =====================================================\n// Usa a API /api/foods/lookup para buscar macros\n// Fallback para estimativa se nÃ£o encontrar\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst novoNomeAlimento = currentItem.novoNomeAlimento || '';\nconst novoPeso = currentItem.novoPeso || 100;\n\n// Se nÃ£o tem nome de alimento, passar adiante\nif (!novoNomeAlimento) {\n  return {\n    json: {\n      ...currentItem,\n      foodDbResult: null,\n      useFoodDb: false\n    }\n  };\n}\n\nconsole.log(`ðŸ” Buscando: ${novoNomeAlimento} (${novoPeso}g)`);\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'https://web-production-c9eaf.up.railway.app/api/foods/lookup',\n    headers: {\n      'X-Webhook-Secret': 'nutribuddy-secret-2024',\n      'Content-Type': 'application/json'\n    },\n    body: {\n      name: novoNomeAlimento,\n      weight: novoPeso\n    }\n  });\n\n  if (response.success && response.found) {\n    console.log(`âœ… Encontrado: ${response.data.name} (confianÃ§a: ${response.confidence}%)`);\n    console.log(`ðŸ“Š Macros: P:${response.data.macrosCalculated.proteinas}g | C:${response.data.macrosCalculated.carboidratos}g | G:${response.data.macrosCalculated.gorduras}g | ${response.data.macrosCalculated.calorias}kcal`);\n    \n    return {\n      json: {\n        ...currentItem,\n        foodDbResult: response.data,\n        useFoodDb: true,\n        macrosFromDb: response.data.macrosCalculated,\n        confidence: response.confidence\n      }\n    };\n  } else {\n    console.log(`âš ï¸ Alimento nÃ£o encontrado na base: ${novoNomeAlimento}`);\n    return {\n      json: {\n        ...currentItem,\n        foodDbResult: null,\n        useFoodDb: false,\n        searchedName: novoNomeAlimento\n      }\n    };\n  }\n} catch (error) {\n  console.log(`âŒ Erro ao buscar na Food DB: ${error.message}`);\n  return {\n    json: {\n      ...currentItem,\n      foodDbResult: null,\n      useFoodDb: false,\n      error: error.message\n    }\n  };\n}"
      },
      "id": "da24861d-590e-4690-9a3f-07336e23d16d",
      "name": "Buscar Food DB",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        25600,
        608
      ],
      "notes": "Busca alimento na Food Database do Firebase\nRecebe: novoNomeAlimento, novoPeso\nRetorna: macros do banco se encontrar"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 7a-4. VERIFICAR CONFIANÃ‡A E PERGUNTAR\n// =====================================================\n// Se a IA tem baixa confianÃ§a, pergunta ao paciente\n// antes de registrar\n// =====================================================\n\nconst dadosAnalise = $input.first().json;\nconst analise = dadosAnalise.analise_foto || {};\nconst alimentos = analise.alimentos || [];\n\nconsole.log('=== VERIFICANDO CONFIANÃ‡A ===');\n\n// Verificar se hÃ¡ alimentos com baixa confianÃ§a\nconst alimentosBaixaConfianca = alimentos.filter(a => \n  a.confianca === 'baixa' || \n  (a.confianca === 'media' && (a.peso_gramas < 50 || a.peso_gramas > 500))\n);\n\nconst temBaixaConfianca = alimentosBaixaConfianca.length > 0;\nconst percentualBaixaConfianca = alimentos.length > 0 \n  ? (alimentosBaixaConfianca.length / alimentos.length) * 100 \n  : 0;\n\nconsole.log(`Alimentos total: ${alimentos.length}`);\nconsole.log(`Baixa confianÃ§a: ${alimentosBaixaConfianca.length} (${percentualBaixaConfianca.toFixed(0)}%)`);\n\n// Se mais de 50% tem baixa confianÃ§a, deve perguntar\nconst devePerguntar = percentualBaixaConfianca >= 50;\n\nif (devePerguntar && alimentosBaixaConfianca.length > 0) {\n  console.log('âš ï¸ BAIXA CONFIANÃ‡A - Gerando pergunta');\n  \n  // Gerar pergunta especÃ­fica\n  const primeiro = alimentosBaixaConfianca[0];\n  \n  // SugestÃµes de alimentos similares\n  const sugestoes = {\n    'torta': ['pamonha', 'empadÃ£o', 'quiche'],\n    'pamonha': ['torta salgada', 'milho cozido', 'curau'],\n    'coxinha': ['esfiha', 'quibe', 'bolinho'],\n    'pastel': ['empada', 'folhado', 'risole'],\n    'arroz': ['couscous', 'farofa', 'purÃª'],\n    'frango': ['carne de porco', 'peixe', 'tofu'],\n    'carne': ['frango', 'peixe', 'carne de porco']\n  };\n  \n  const nomeAlimento = (primeiro.nome || '').toLowerCase();\n  let alternativas = [];\n  \n  for (const [key, alts] of Object.entries(sugestoes)) {\n    if (nomeAlimento.includes(key)) {\n      alternativas = alts;\n      break;\n    }\n  }\n  \n  let pergunta;\n  if (alternativas.length > 0) {\n    pergunta = `ðŸ¤” NÃ£o tenho certeza se identifiquei corretamente...\\n\\nIsso Ã© *${primeiro.nome}*?\\n\\nOu seria:\\nâ€¢ ${alternativas.join('\\nâ€¢ ')}?\\n\\nMe confirma que eu registro certinho! ðŸ˜Š`;\n  } else {\n    pergunta = `ðŸ¤” NÃ£o tenho certeza sobre \"${primeiro.nome}\" (${primeiro.peso_gramas}g).\\n\\nEstÃ¡ correto ou vocÃª pode me ajudar com o nome/peso? ðŸ˜Š`;\n  }\n  \n  return {\n    json: {\n      ...dadosAnalise,\n      _devePerguntar: true,\n      _perguntaConfianca: pergunta,\n      _alimentoDuvidoso: primeiro.nome,\n      _alternativasSugeridas: alternativas\n    }\n  };\n}\n\n// Se confianÃ§a OK, seguir normalmente\nconsole.log('âœ… ConfianÃ§a OK - Seguindo fluxo normal');\n\nreturn {\n  json: {\n    ...dadosAnalise,\n    _devePerguntar: false,\n    _confiancaGeral: 100 - percentualBaixaConfianca\n  }\n};"
      },
      "id": "f3713cd0-c905-4aea-b5e5-b7e68e7e36f0",
      "name": "7a-4. Verificar ConfianÃ§a",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        27392,
        -720
      ],
      "notes": "IA PROATIVA\n\nVerifica se Vision tem baixa confianÃ§a:\n- Se >50% dos alimentos tÃªm baixa confianÃ§a\n- Gera pergunta especÃ­fica com alternativas\n- Ex: 'Isso Ã© torta ou pamonha?'"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 11c. VERIFICAR METAS E ALERTAR\n// =====================================================\n// Verifica se o paciente estÃ¡ prÃ³ximo ou passou das metas\n// Adiciona alerta proativo na resposta\n// =====================================================\n\nconst dadosAnalise = $input.first().json;\nconst dietResponse = $('5a. Buscar Dieta (FOTO)').first().json || {};\n\nconsole.log('=== VERIFICANDO METAS ===');\n\n// Extrair macros da refeiÃ§Ã£o atual\nconst macrosRefeicao = dadosAnalise.analise_foto?.macros_totais || {};\nconst caloriasRefeicao = macrosRefeicao.calorias || 0;\nconst proteinaRefeicao = macrosRefeicao.proteinas || 0;\n\n// Extrair metas diÃ¡rias\nconst dietData = dietResponse.data || {};\nconst metaDiaria = {\n  calorias: dietData.dailyCalories || dietData.macros?.calories || 2000,\n  proteinas: dietData.dailyProtein || dietData.macros?.protein || 150\n};\n\nconsole.log('Meta diÃ¡ria:', metaDiaria);\nconsole.log('RefeiÃ§Ã£o atual:', macrosRefeicao);\n\n// Buscar consumo anterior do dia (se disponÃ­vel)\nlet consumoAnteriorHoje = 0;\ntry {\n  // Idealmente buscaria do histÃ³rico do dia\n  // Por enquanto, estimar baseado no horÃ¡rio\nconst brazilTimeTmp = new Date().toLocaleString(\"en-US\", {\n  timeZone: \"America/Sao_Paulo\",\n});\nconst hora = new Date(brazilTimeTmp).getHours();\n  \n  if (hora >= 12 && hora < 15) {\n    // AlmoÃ§o - estimar cafÃ© + lanche = ~400kcal\n    consumoAnteriorHoje = 400;\n  } else if (hora >= 15 && hora < 19) {\n    // Lanche da tarde - estimar cafÃ© + almoÃ§o = ~1000kcal\n    consumoAnteriorHoje = 1000;\n  } else if (hora >= 19) {\n    // Jantar - estimar cafÃ© + almoÃ§o + lanche = ~1400kcal\n    consumoAnteriorHoje = 1400;\n  }\n} catch (e) {\n  console.log('âš ï¸ Erro ao estimar consumo anterior');\n}\n\n// Calcular total estimado do dia\nconst totalEstimadoHoje = consumoAnteriorHoje + caloriasRefeicao;\nconst percentualMeta = (totalEstimadoHoje / metaDiaria.calorias) * 100;\n\nconsole.log(`Total estimado: ${totalEstimadoHoje}kcal (${percentualMeta.toFixed(0)}% da meta)`);\n\n// Gerar alertas\nlet alerta = null;\n\nif (totalEstimadoHoje > metaDiaria.calorias) {\n  const excesso = totalEstimadoHoje - metaDiaria.calorias;\n  alerta = {\n    tipo: 'excesso',\n    icone: 'âš ï¸',\n    mensagem: `VocÃª passou ${Math.round(excesso)}kcal da meta hoje! Que tal uma caminhada apÃ³s o jantar? ðŸš¶â€â™‚ï¸`,\n    gravidade: 'alta'\n  };\n} else if (percentualMeta >= 90) {\n  const falta = metaDiaria.calorias - totalEstimadoHoje;\n  alerta = {\n    tipo: 'proximo',\n    icone: 'ðŸ’¡',\n    mensagem: `VocÃª estÃ¡ a ${Math.round(falta)}kcal da meta. VÃ¡ com calma nas prÃ³ximas! ðŸ˜Š`,\n    gravidade: 'media'\n  };\n} else if (proteinaRefeicao < 20 && (new Date().getHours() >= 11 && new Date().getHours() < 15)) {\n  // Pouca proteÃ­na no almoÃ§o\n  alerta = {\n    tipo: 'proteina_baixa',\n    icone: 'ðŸ’ª',\n    mensagem: `Essa refeiÃ§Ã£o tem pouca proteÃ­na (${Math.round(proteinaRefeicao)}g). Tente compensar no lanche ou jantar!`,\n    gravidade: 'baixa'\n  };\n}\n\n// MotivaÃ§Ã£o positiva\nlet motivacao = null;\n\nif (!alerta && percentualMeta < 80) {\n  motivacao = {\n    icone: 'ðŸ‘',\n    mensagem: `Ã“tima escolha! VocÃª estÃ¡ ${Math.round(percentualMeta)}% da meta. Continue assim!`\n  };\n}\n\nconsole.log('Alerta:', alerta?.tipo || 'nenhum');\nconsole.log('MotivaÃ§Ã£o:', motivacao ? 'sim' : 'nÃ£o');\n\nreturn {\n  json: {\n    ...dadosAnalise,\n    _metaVerificada: true,\n    _percentualMeta: Math.round(percentualMeta),\n    _alerta: alerta,\n    _motivacao: motivacao,\n    _totalEstimadoHoje: totalEstimadoHoje,\n    _metaDiaria: metaDiaria\n  }\n};"
      },
      "id": "d2f0f0f9-c2af-4eea-808b-21a92b70f3c3",
      "name": "11c. Verificar Metas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        31232,
        -720
      ],
      "notes": "IA PROATIVA - METAS\n\nVerifica:\n- Se passou da meta de calorias\n- Se estÃ¡ prÃ³ximo (>90%)\n- Se proteÃ­na estÃ¡ baixa no almoÃ§o\n\nGera alertas e motivaÃ§Ãµes contextuais"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "VocÃª Ã© um assistente de anÃ¡lise de intenÃ§Ã£o para um app de nutriÃ§Ã£o.\n\nCONTEXTO DA ÃšLTIMA ANÃLISE:\n{{ $json.context?.data?.lastAnalysis || 'NÃ£o hÃ¡ anÃ¡lise anterior' }}\n\nÃšLTIMA REFEIÃ‡ÃƒO ANALISADA:\n{{ JSON.stringify($json.context?.data?.alimentos || $json.context?.data?.foods || []) }}\n\nMENSAGEM DO USUÃRIO:\n\"{{ $json.userMessage }}\"\n\nANALISE a mensagem e retorne APENAS um JSON vÃ¡lido no formato:\n{\n  \"intention\": \"correction\" | \"addition\" | \"confirmation\" | \"question\" | \"cancellation\",\n  \"confidence\": 0.0 a 1.0,\n  \"extractedData\": {\n    \"newWeight\": nÃºmero ou null,\n    \"newFoodType\": \"nome do alimento\" ou null,\n    \"originalFood\": \"qual alimento estÃ¡ sendo corrigido\" ou null\n  },\n  \"reasoning\": \"explicaÃ§Ã£o curta\"\n}\n\nEXEMPLOS:\n- \"Eu comi 270g de pamonha\" â†’ correction com newWeight=270, newFoodType=\"pamonha\"\n- \"Na verdade era 200g\" â†’ correction com newWeight=200\n- \"Isso aÃ­ Ã© coxinha\" â†’ correction com newFoodType=\"coxinha\"\n- \"TambÃ©m comi uma banana\" â†’ addition\n- \"OK, pode salvar\" â†’ confirmation\n- \"O que eu comi hoje?\" â†’ question\n\nRESPONDA APENAS O JSON, SEM MARKDOWN:",
              "role": "system"
            },
            {
              "content": "{{ $json.userMessage }}"
            }
          ]
        },
        "options": {
          "maxTokens": 500,
          "temperature": 0.1
        }
      },
      "id": "68169f51-a4bf-42c8-9aa5-88e3d83f78b5",
      "name": "FASE2: 4. Analisar IntenÃ§Ã£o (IA)",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.2,
      "position": [
        24800,
        320
      ],
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      },
      "notes": "V5 - COM IA\n\nUsa GPT para analisar a intenÃ§Ã£o do usuÃ¡rio.\nMuito mais inteligente que regex!\n\nEntende contexto e variaÃ§Ãµes naturais da linguagem."
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// PROCESSAR RESPOSTA DA IA DE INTENÃ‡ÃƒO\n// ============================================\n\nconst input = $input.first().json;\nconst aiResponse = input.message?.content || input.text || '';\n\nconsole.log('ðŸ¤– Resposta da IA:', aiResponse);\n\n// Buscar dados originais\nconst originalData = $('1. Validar e Processar').first().json;\nconst userMessage = (originalData.content || '').toLowerCase()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\n\n// ============================================\n// PRÃ‰-DETECÃ‡ÃƒO: ForÃ§ar correÃ§Ã£o em padrÃµes claros\n// ============================================\nlet forcedCorrection = null;\n\n// PadrÃµes que sÃ£o SEMPRE correÃ§Ã£o\nconst correcaoPatterns = [\n    /^(na verdade|na real|no lugar|corrigindo|era[m]?|sao|sÃ£o)\\s+/i,\n    /\\\\d+\\\\s*(g|gr|gramas?)\\\\s+(de\\\\s+)?/i,\n    /isso (e|Ã©|eh|era)/i\n];\n\nconst eCorrecaoClara = correcaoPatterns.some(p => p.test(originalData.content || ''));\n\nif (eCorrecaoClara) {\n    console.log('ðŸŽ¯ PRÃ‰-DETECÃ‡ÃƒO: Mensagem Ã© claramente uma CORREÃ‡ÃƒO');\n    \n    // Extrair peso\n    const pesoMatch = userMessage.match(/(\\\\d+)\\\\s*(gr?a?m?a?s?|g)/i);\n    const peso = pesoMatch ? parseInt(pesoMatch[1]) : null;\n    \n    // Extrair alimento: Pega tudo o que sobrar depois de gatilhos como \"sao\", \"era\", \"de\", \"eh\", interrompendo peso\n    let alimento = null;\n    // Tenta encontrar o que vem depois dos delimitadores de nome\n    const alimentoMatch = userMessage.match(/(?:de|e|Ã©|eh|era|sao|eram|e o|era o|sao o)\\\\s+([a-z].*)$/i);\n    if (alimentoMatch) {\n        alimento = alimentoMatch[1].trim();\n    } else {\n        // Fallback: Se nÃ£o achou delimitador mas tem peso, tenta pegar o que vem antes ou depois do peso\n        const semPeso = userMessage.replace(/\\\\d+\\\\s*(gr?a?m?a?s?|g)/gi, '').replace(/na verdade|era|sao/gi, '').trim();\n        if (semPeso.length > 2) alimento = semPeso;\n    }\n    \n    forcedCorrection = {\n        intention: 'correction',\n        confidence: 0.99,\n        extractedData: {\n            newWeight: peso,\n            newFoodType: alimento,\n            originalFood: null\n        },\n        reasoning: 'PrÃ©-detecÃ§Ã£o robusta: padrÃ£o de correÃ§Ã£o identificado'\n    };\n}\n\n// ============================================\n// PROCESSAR RESPOSTA DA IA (se nÃ£o forÃ§ou)\n// ============================================\nlet parsed;\n\nif (forcedCorrection) {\n    parsed = forcedCorrection;\n    console.log('âœ… Usando PRÃ‰-DETECÃ‡ÃƒO forÃ§ada');\n} else {\n    try {\n        let cleanResponse = aiResponse.replace(/```json\\\\n?/g, '').replace(/```\\\\n?/g, '').trim();\n        parsed = JSON.parse(cleanResponse);\n    } catch (e) {\n        parsed = { intention: 'question', confidence: 0.3, extractedData: {}, reasoning: 'Erro no parse' };\n    }\n}\n\n// Buscar contexto de forma mais agressiva\nlet contextData = null;\ntry {\n    // Tenta primeiro o nÃ³ de busca ativa\n    contextData = $('FASE2: 2. Buscar Contexto Ativo').first().json;\n} catch (e) {\n    // Se falhar, tenta ver se o nÃ³ 1 trouxe algo\n    try { contextData = $('1. Validar e Processar').first().json.context; } catch (e2) {}\n}\n\nreturn {\n    json: {\n        conversationId: originalData.conversationId,\n        patientId: originalData.patientId,\n        context: contextData?.context || contextData || null,\n        intention: {\n            type: parsed.intention,\n            confidence: parsed.confidence,\n            userMessage: originalData.content,\n            detectionMethod: forcedCorrection ? 'pre_detection' : 'ai_analysis',\n            extractedWeight: parsed.extractedData?.newWeight || null,\n            extractedFood: parsed.extractedData?.newFoodType || null,\n            originalFood: parsed.extractedData?.originalFood || null,\n            reasoning: parsed.reasoning\n        }\n    }\n};"
      },
      "id": "91f2e10f-8bcf-4fe5-88d8-177997c2d3a1",
      "name": "FASE2: 4b. Processar Resposta IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        25152,
        320
      ],
      "notes": "Processa a resposta JSON da IA e formata para o prÃ³ximo nÃ³"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// FASE2: 6a. AÃ‡ÃƒO: CORREÃ‡ÃƒO (V5.2 - LIMPEZA ROBUSTA)\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst intention = currentItem.intention || {};\nconst context = currentItem.context || {};\nconst userMessage = intention.userMessage || '';\n\nconsole.log('=== PROCESSANDO CORREÃ‡ÃƒO V5.2 ===');\n\n// =====================================================\n// 1. OBTER E LIMPAR DADOS EXTRAÃDOS PELA IA\n// =====================================================\nconst novoPeso = intention.extractedWeight;\nlet novoAlimento = intention.extractedFood;\nconst alimentoOriginal = intention.originalFood;\n\n// FunÃ§Ã£o para limpar termos do nome do alimento\nfunction limparNomeAlimento(nome) {\n    if (!nome) return nome;\n    return nome\n        .replace(/^(na verdade|na real|no lugar|corrigindo|sao|sÃ£o|era|eram|e|Ã©|eh|foi|foram|o|a|os|as)\\\\s+/gi, '') \n        .replace(/^(\\\\d+)\\\\s*(g|gr|gramas?)\\\\s*(de|do|da)?\\\\s*/gi, '') \n        .replace(/\\\\s+(\\\\d+)(g|gr|gramas).*$/gi, '') \n        .replace(/^(de|do|da)\\\\s+/gi, '') \n        .trim();\n}\n\nnovoAlimento = limparNomeAlimento(novoAlimento);\n\n// Dados da Ãºltima anÃ¡lise\nconst alimentosOriginais = context.data?.alimentos || context.data?.foods || [];\n// Fallback de macros mais profundo: tenta todos os campos possÃ­veis\nconst totalMacrosContext = (context.data?.totalMacros?.calorias > 0 ? context.data.totalMacros : null) || \n                           (context.data?.macros_totais?.calorias > 0 ? context.data.macros_totais : null) || \n                           (context.data?.macros?.calorias > 0 ? context.data.macros : null) || {};\n\nlet pesoOriginal = 100;\nlet nomeAlimentoOriginal = alimentoOriginal || 'alimento';\nlet indiceAlimento = 0;\n\nif (alimentosOriginais.length > 0) {\n    if (alimentoOriginal) {\n        const idx = alimentosOriginais.findIndex(a => \n            (a.nome || a.name || '').toLowerCase().includes(alimentoOriginal.toLowerCase())\n        );\n        if (idx >= 0) indiceAlimento = idx;\n    }\n    \n    const alimentoAlvo = alimentosOriginais[indiceAlimento];\n    pesoOriginal = alimentoAlvo.peso_gramas || alimentoAlvo.weight || 100;\n    nomeAlimentoOriginal = alimentoAlvo.nome || alimentoAlvo.name || nomeAlimentoOriginal;\n} else if (totalMacrosContext.calorias) {\n    pesoOriginal = 100;\n}\n\nconst isTypeConfusion = !!(novoAlimento && novoAlimento.toLowerCase() !== nomeAlimentoOriginal.toLowerCase());\nlet typeConfusionData = null;\n\nif (isTypeConfusion) {\n    typeConfusionData = {\n        aiIdentified: nomeAlimentoOriginal,\n        actualFood: novoAlimento,\n        patientId: currentItem.patientId,\n        conversationId: currentItem.conversationId,\n        imageUrl: context.data?.imageUrl || context.imageUrl || null\n    };\n}\n\nlet nomeExibicao = novoAlimento || nomeAlimentoOriginal;\n\n// =====================================================\n// 2. CALCULAR NOVOS MACROS\n// =====================================================\nlet macrosTotais = { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 };\nlet alimentosAtualizados = [];\nconst ratio = novoPeso ? (novoPeso / pesoOriginal) : 1;\n\nif (alimentosOriginais.length > 0) {\n    alimentosAtualizados = alimentosOriginais.map((food, index) => {\n        if (index === indiceAlimento) {\n            return {\n                ...food,\n                nome: novoAlimento || food.nome || food.name,\n                peso_gramas: novoPeso || food.peso_gramas,\n                macros: {\n                    proteinas: Math.round((food.macros?.proteinas || 0) * ratio * 10) / 10,\n                    carboidratos: Math.round((food.macros?.carboidratos || 0) * ratio * 10) / 10,\n                    gorduras: Math.round((food.macros?.gorduras || 0) * ratio * 10) / 10,\n                    calorias: Math.round((food.macros?.calorias || 0) * ratio)\n                }\n            };\n        }\n        return food;\n    });\n    macrosTotais = alimentosAtualizados.reduce((acc, food) => ({\n        proteinas: acc.proteinas + (food.macros?.proteinas || 0),\n        carboidratos: acc.carboidratos + (food.macros?.carboidratos || 0),\n        gorduras: acc.gorduras + (food.macros?.gorduras || 0),\n        calorias: acc.calorias + (food.macros?.calorias || 0)\n    }), { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 });\n} else if (totalMacrosContext.calorias) {\n    macrosTotais = {\n        proteinas: Math.round((totalMacrosContext.proteinas || 0) * ratio * 10) / 10,\n        carboidratos: Math.round((totalMacrosContext.carboidratos || 0) * ratio * 10) / 10,\n        gorduras: Math.round((totalMacrosContext.gorduras || 0) * ratio * 10) / 10,\n        calorias: Math.round((totalMacrosContext.calorias || 0) * ratio)\n    };\n    alimentosAtualizados = [{ nome: nomeExibicao, peso_gramas: novoPeso || 100, macros: macrosTotais }];\n}\n\nlet resposta;\nif (novoPeso && novoAlimento) {\n    resposta = `Entendi! Atualizei para *${novoPeso}g de ${nomeExibicao}* ðŸ½ï¸\\\\n\\\\nðŸ“Š *Macros recalculados:*\\\\nâ€¢ ProteÃ­na: ${Math.round(macrosTotais.proteinas)}g\\\\nâ€¢ Carboidratos: ${Math.round(macrosTotais.carboidratos)}g\\\\nâ€¢ Gorduras: ${Math.round(macrosTotais.gorduras)}g\\\\nâ€¢ Calorias: ${Math.round(macrosTotais.calorias)}\\\\n\\\\nâœ… Salvei essa correÃ§Ã£o para melhorar minhas anÃ¡lises futuras! ðŸ§ `;\n} else if (novoPeso) {\n    resposta = `Entendi! Atualizei o *${nomeExibicao}* para *${novoPeso}g* ðŸ“\\\\n\\\\nðŸ“Š *Macros recalculados:*\\\\nâ€¢ ProteÃ­na: ${Math.round(macrosTotais.proteinas)}g\\\\nâ€¢ Carboidratos: ${Math.round(macrosTotais.carboidratos)}g\\\\nâ€¢ Gorduras: ${Math.round(macrosTotais.gorduras)}g\\\\nâ€¢ Calorias: ${Math.round(macrosTotais.calorias)}\\\\n\\\\nâœ… Guardei essa correÃ§Ã£o para aprender! ðŸ§ `;\n} else {\n    resposta = `Entendi! EntÃ£o era *${nomeExibicao}*! ðŸ½ï¸\\\\n\\\\nDeseja ajustar o peso tambÃ©m?`;\n}\n\nreturn {\n    json: {\n        conversationId: currentItem.conversationId,\n        patientId: currentItem.patientId,\n        action: 'correction',\n        correction: { originalFood: nomeAlimentoOriginal, newFood: novoAlimento, originalWeight: pesoOriginal, newWeight: novoPeso },\n        hasTypeConfusion: isTypeConfusion,\n        typeConfusionData: typeConfusionData,\n        feedbackData: { foodType: (novoAlimento || nomeAlimentoOriginal).toLowerCase().replace(/\\\\s+/g, '_'), estimatedWeight: pesoOriginal, correctedWeight: novoPeso || pesoOriginal, patientId: currentItem.patientId },\n        sendFeedback: !!novoPeso,\n        contextUpdate: {\n            data: {\n                alimentos: alimentosAtualizados,\n                foods: alimentosAtualizados,\n                totalMacros: macrosTotais,\n                macros_totais: macrosTotais,\n                lastCorrection: { weight: novoPeso, food: nomeExibicao, at: new Date().toISOString() }\n            }\n        },\n        responseMessage: resposta\n    }\n};"
      },
      "id": "05f1906c-102a-41e8-bb3f-d8b6779610fe",
      "name": "FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        25824,
        608
      ],
      "notes": "V5 - COM DADOS DA IA\n\nRecebe dados jÃ¡ extraÃ­dos pela IA:\n- extractedWeight\n- extractedFood\n- originalFood\n\nResponde de forma inteligente e envia feedback para aprendizado."
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 3a-PRE. DETECTAR CORREÃ‡ÃƒO RÃPIDA (ANTES DO CONTEXTO)\n// =====================================================\n// Este nÃ³ detecta se a mensagem parece ser uma correÃ§Ã£o\n// ANTES de verificar se tem contexto\n// Assim, correÃ§Ãµes funcionam mesmo se o contexto expirou\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst userMessage = (currentItem.content || '').toLowerCase();\nconst originalMessage = currentItem.content || '';\n\nconsole.log('ðŸ” [PRE-CHECK] Verificando se Ã© correÃ§Ã£o:', userMessage);\n\n// PADRÃ•ES DE CORREÃ‡ÃƒO (muito provÃ¡vel)\nconst padroesCor = [\n    /na verdade/i,\n    /eu comi.*\\d+\\s*(g|gr|gramas?)/i,\n    /eram?\\s*\\d+\\s*(g|gr|gramas?)/i,\n    /\\d+\\s*(g|gr|gramas?)\\s*(de\\s+)?\\w+/i,\n    /isso (Ã©|e|eh)\\s+/i,\n    /(nÃ£o|nao).*era/i,\n    /corrig/i,\n    /metade disso/i,\n    /o (certo|correto) (Ã©|e|era)/i\n];\n\nconst pareceCorrecao = padroesCor.some(p => p.test(userMessage));\n\n// Extrair dados bÃ¡sicos se parecer correÃ§Ã£o\nlet dadosExtraidos = null;\nif (pareceCorrecao) {\n    console.log('âœ… [PRE-CHECK] PARECE CORREÃ‡ÃƒO!');\n    \n    // Tentar extrair peso\n    const pesoMatch = userMessage.match(/(\\d+)\\s*(g|gr|gramas?)/i);\n    const peso = pesoMatch ? parseInt(pesoMatch[1]) : null;\n    \n    // Tentar extrair alimento (depois de 'de')\n    const alimentoMatch = userMessage.match(/(?:de\\s+|Ã©\\s+|eh\\s+)(\\w+)/i);\n    const alimento = alimentoMatch ? alimentoMatch[1] : null;\n    \n    dadosExtraidos = {\n        peso: peso,\n        alimento: alimento\n    };\n    \n    console.log('ðŸ“Š [PRE-CHECK] Peso:', peso, 'Alimento:', alimento);\n}\n\n// Retornar com flag\nreturn {\n    json: {\n        ...currentItem,\n        _pareceCorrecao: pareceCorrecao,\n        _dadosCorrecaoRapida: dadosExtraidos,\n        _bypassContext: pareceCorrecao  // Se parece correÃ§Ã£o, nÃ£o precisa ter contexto\n    }\n};"
      },
      "id": "9efe1e74-e9ee-49d7-97af-290882662257",
      "name": "3a-PRE. Detectar CorreÃ§Ã£o RÃ¡pida",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        23904,
        -384
      ],
      "notes": "PRE-CHECK antes de verificar contexto.\n\nDetecta se a mensagem PARECE uma correÃ§Ã£o:\n- 'Eu comi 270g de pamonha'\n- 'Na verdade eram 200g'\n- 'Isso Ã© coxinha'\n\nSe parece correÃ§Ã£o, seta _bypassContext = true\npara ir direto para anÃ¡lise de intenÃ§Ã£o."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f6b33719-9e76-44bb-be2e-159ce0296e55",
              "leftValue": "={{ $json._pareceCorrecao }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        24128,
        -384
      ],
      "id": "497b73c2-2022-49fa-9411-a1867599f948",
      "name": "3a-IF. Ã‰ CorreÃ§Ã£o?"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 3a-MAP. PREPARAR DADOS PARA ANÃLISE DE INTENÃ‡ÃƒO\n// =====================================================\n// Mapeia os campos do input para o formato esperado\n// pelo nÃ³ FASE2: 4. Analisar IntenÃ§Ã£o (IA)\n// =====================================================\n\nconst item = $input.first().json;\n\nconsole.log('ðŸ”„ [MAP] Preparando dados para IA');\nconsole.log('ðŸ“ Mensagem:', item.content);\nconsole.log('ðŸ†” ConversationId:', item.conversationId);\n\nreturn {\n  json: {\n    // Dados bÃ¡sicos\n    conversationId: item.conversationId,\n    patientId: item.patientId,\n    prescriberId: item.prescriberId,\n    \n    // O campo que o OpenAI espera\n    userMessage: item.content,\n    \n    // Contexto (vazio quando vem direto, sem passar pelo contexto)\n    context: {\n      hasContext: false,\n      data: {\n        alimentos: [],\n        foods: []\n      }\n    },\n    \n    // Dados extras da prÃ©-detecÃ§Ã£o (Ãºteis para debug)\n    _pareceCorrecao: item._pareceCorrecao,\n    _dadosCorrecaoRapida: item._dadosCorrecaoRapida,\n    _bypassContext: item._bypassContext\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        24576,
        96
      ],
      "id": "fd6566c9-afee-4e81-9e06-121e4fb87cfa",
      "name": "3a-MAP. Preparar para IA"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "https://web-production-c9eaf.up.railway.app/api/meals/correct-last",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  patientId: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.patientId,\n  foods: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.foods || [],\n  macros: {\n    calories: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.totalMacros?.calorias || 0,\n    protein: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.totalMacros?.proteinas || 0,\n    carbs: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.totalMacros?.carboidratos || 0,\n    fats: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.totalMacros?.gorduras || 0\n  },\n  correctionDetails: {\n    originalFood: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.originalFood || '',\n    newFood: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.newFood || '',\n    originalWeight: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.originalWeight || 0,\n    newWeight: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.newWeight || 0\n  },\n  correctedBy: 'patient'\n}) }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "f72f3adf-2f41-4b6b-8c63-212f1f19caab",
      "name": "FASE2: 6a-4. Atualizar RefeiÃ§Ã£o",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        26720,
        800
      ],
      "onError": "continueRegularOutput",
      "notes": "Atualiza a Ãºltima refeiÃ§Ã£o do paciente com os dados corrigidos.\n\nEndpoint: PATCH /api/meals/correct-last\n\nBody:\n- patientId\n- foods: array de alimentos corrigidos\n- macros: macros recalculados\n- correctionDetails: detalhes da correÃ§Ã£o\n\nO endpoint busca automaticamente a Ãºltima refeiÃ§Ã£o de hoje e atualiza."
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "https://web-production-c9eaf.up.railway.app/api/meals/correct-last",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"patientId\": \"{{ $('1. Validar e Processar').first().json.patientId }}\",\n  \"foods\": {{ JSON.stringify($('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.foods || []) }},\n  \"macros\": {{ JSON.stringify($('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.totalMacros || {}) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        27680,
        96
      ],
      "id": "b3dca7bd-9f36-41b0-871c-d7fda9414aa6",
      "name": "FASE2: 6a-4. Atualizar Banco (Nova API)"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasTypeConfusion }}",
              "value2": true
            }
          ]
        }
      },
      "id": "59abe00c-f6ae-46d1-91a7-17861ab981dd",
      "name": "Ã‰ ConfusÃ£o de Tipo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        26048,
        608
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://web-production-c9eaf.up.railway.app/api/n8n/food-type-confusions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.typeConfusionData) }}",
        "options": {}
      },
      "id": "b9f542cc-e407-42e1-bf68-22f824263b2b",
      "name": "FASE2: 6a-3.5 Enviar ConfusÃ£o de Tipo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        26272,
        528
      ],
      "notes": "Envia a confusÃ£o de tipo para o backend para aprendizado futuro."
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 6b. DETECTAR RESTAURANTE (COM GPT FALLBACK)\n// =====================================================\n// Este nÃ³ detecta quando o paciente pergunta sobre restaurantes\n// e prepara o contexto com macros disponÃ­veis e sugestÃµes de cardÃ¡pio\n// \n// FEATURES:\n// - Base de dados local de restaurantes populares\n// - Fallback para GPT quando restaurante nÃ£o catalogado\n// - Suporte a refinamento (\"quero algo diferente\")\n// =====================================================\n\n// =====================================================\n// 1. BASE DE CARDÃPIOS POPULARES (COMPACTA)\n// =====================================================\nconst RESTAURANT_MENUS = {\n  madero: {\n    name: \"Madero\", items: [\n      { name: \"Cheese Burger Madero\", portion: \"180g\", calories: 650, protein: 38, carbs: 35, fats: 40 },\n      { name: \"Chicken Burger\", portion: \"180g\", calories: 520, protein: 35, carbs: 40, fats: 25 },\n      { name: \"Salada Caesar\", portion: \"300g\", calories: 380, protein: 28, carbs: 15, fats: 25 },\n      { name: \"FilÃ© Mignon Grelhado\", portion: \"250g\", calories: 450, protein: 55, carbs: 5, fats: 25 },\n      { name: \"SalmÃ£o Grelhado\", portion: \"200g\", calories: 380, protein: 42, carbs: 3, fats: 22 },\n      { name: \"Salada Verde\", portion: \"100g\", calories: 45, protein: 2, carbs: 8, fats: 1 }\n    ]\n  },\n  outback: {\n    name: \"Outback\", items: [\n      { name: \"Outback Special (filÃ©)\", portion: \"300g\", calories: 650, protein: 62, carbs: 8, fats: 42 },\n      { name: \"Grilled Salmon\", portion: \"220g\", calories: 420, protein: 48, carbs: 5, fats: 24 },\n      { name: \"Queensland Chicken\", portion: \"280g\", calories: 580, protein: 52, carbs: 15, fats: 35 },\n      { name: \"Caesar Salad\", portion: \"300g\", calories: 420, protein: 32, carbs: 18, fats: 28 }\n    ]\n  },\n  subway: {\n    name: \"Subway\", items: [\n      { name: \"Frango Teriyaki 15cm\", portion: \"220g\", calories: 370, protein: 26, carbs: 48, fats: 8 },\n      { name: \"Peito de Peru 15cm\", portion: \"200g\", calories: 280, protein: 18, carbs: 42, fats: 4 },\n      { name: \"Salada Frango Teriyaki\", portion: \"300g\", calories: 220, protein: 28, carbs: 15, fats: 6 },\n      { name: \"Salada Peito de Peru\", portion: \"280g\", calories: 140, protein: 20, carbs: 12, fats: 3 }\n    ]\n  },\n  mcdonalds: {\n    name: \"McDonald's\", items: [\n      { name: \"McOferta Grelhado\", portion: \"210g\", calories: 420, protein: 32, carbs: 38, fats: 15 },\n      { name: \"Salada Premium\", portion: \"280g\", calories: 180, protein: 22, carbs: 12, fats: 6 },\n      { name: \"Hamburger Simples\", portion: \"105g\", calories: 260, protein: 13, carbs: 31, fats: 10 },\n      { name: \"Chicken McNuggets (6 un)\", portion: \"100g\", calories: 280, protein: 16, carbs: 18, fats: 17 }\n    ]\n  },\n  burgerking: {\n    name: \"Burger King\", items: [\n      { name: \"Whopper Jr\", portion: \"150g\", calories: 370, protein: 16, carbs: 28, fats: 22 },\n      { name: \"Chicken Crispy\", portion: \"200g\", calories: 520, protein: 24, carbs: 48, fats: 26 }\n    ]\n  },\n  habibs: {\n    name: \"Habib's\", items: [\n      { name: \"Esfiha de Frango (1 un)\", portion: \"55g\", calories: 125, protein: 7, carbs: 14, fats: 5 },\n      { name: \"Beirute de Frango\", portion: \"270g\", calories: 540, protein: 32, carbs: 52, fats: 22 },\n      { name: \"Tabule\", portion: \"150g\", calories: 180, protein: 4, carbs: 28, fats: 7 }\n    ]\n  },\n  cocobambu: {\n    name: \"Coco Bambu\", items: [\n      { name: \"FilÃ© de Peixe Grelhado\", portion: \"280g\", calories: 380, protein: 48, carbs: 8, fats: 18 },\n      { name: \"SalmÃ£o Grelhado\", portion: \"250g\", calories: 420, protein: 45, carbs: 5, fats: 25 },\n      { name: \"Salada Coco Bambu\", portion: \"300g\", calories: 280, protein: 18, carbs: 22, fats: 15 }\n    ]\n  },\n  dominos: {\n    name: \"Domino's Pizza\", items: [\n      { name: \"Pizza Margherita (1 fatia)\", portion: \"100g\", calories: 250, protein: 11, carbs: 32, fats: 9 },\n      { name: \"Pizza Frango c/ Catupiry (1 fatia)\", portion: \"115g\", calories: 295, protein: 15, carbs: 28, fats: 13 },\n      { name: \"Salada Caesar\", portion: \"250g\", calories: 220, protein: 18, carbs: 12, fats: 12 }\n    ]\n  }\n};\n\n// =====================================================\n// 2. DETECÃ‡ÃƒO DE RESTAURANTE E REFINAMENTO\n// =====================================================\nconst RESTAURANT_PATTERNS = [\n  /quero\\s+(comer|pedir|ir)\\s+(em|no|na|algo\\s+do)\\s+(.+)/i,\n  /o\\s+que\\s+(posso|consigo|dÃ¡\\s+pra)\\s+(comer|pedir)\\s+(em|no|na|do)\\s+(.+)/i,\n  /vou\\s+(comer|jantar|almoÃ§ar)\\s+(no|na|em)\\s+(.+)/i,\n  /sugest(Ã£o|Ãµes|ao)\\s+(para|do|da|pra)\\s+(.+)/i,\n  /(madero|outback|subway|mcdonald|burger\\s*king|habib|coco\\s*bambu|domino)/i\n];\n\nconst REFINEMENT_PATTERNS = [\n  /quero\\s+(algo|outra|outras)\\s+(diferente|opÃ§)/i,\n  /nÃ£o\\s+(quero|gosto|curto)/i,\n  /tem\\s+(outra|algo|mais)/i,\n  /prefiro\\s+(algo|outra)/i,\n  /sem\\s+(carne|frango|peixe|carboidrato|carb|fritura)/i,\n  /mais\\s+(leve|proteÃ­na|proteina|saudÃ¡vel|saudavel)/i,\n  /menos\\s+(caloria|gordura|carb)/i\n];\n\n// =====================================================\n// 3. FUNÃ‡Ã•ES AUXILIARES\n// =====================================================\nfunction normalizeRestaurantName(name) {\n  if (!name) return null;\n  const n = name.toLowerCase().trim().replace(/[''`]/g, '').replace(/\\s+/g, '');\n  const aliases = {\n    \"mcdonalds\": \"mcdonalds\", \"mcdonald's\": \"mcdonalds\", \"macdonalds\": \"mcdonalds\", \"mc\": \"mcdonalds\",\n    \"bk\": \"burgerking\", \"burgerking\": \"burgerking\",\n    \"habib's\": \"habibs\", \"habibs\": \"habibs\", \"habib\": \"habibs\",\n    \"cocobambu\": \"cocobambu\", \"coco\": \"cocobambu\",\n    \"dominos\": \"dominos\", \"dominospizza\": \"dominos\", \"domino's\": \"dominos\"\n  };\n  return aliases[n] || n;\n}\n\nfunction getMealTypeByHour(hour) {\n  if (hour >= 5 && hour < 10) return { type: 'cafe_manha', label: 'CafÃ© da ManhÃ£' };\n  if (hour >= 10 && hour < 12) return { type: 'lanche_manha', label: 'Lanche da ManhÃ£' };\n  if (hour >= 12 && hour < 15) return { type: 'almoco', label: 'AlmoÃ§o' };\n  if (hour >= 15 && hour < 18) return { type: 'lanche_tarde', label: 'Lanche da Tarde' };\n  if (hour >= 18 && hour < 22) return { type: 'jantar', label: 'Jantar' };\n  return { type: 'ceia', label: 'Ceia' };\n}\n\nfunction findMatchingItems(menu, macrosAvailable, filters = {}) {\n  if (!menu || !menu.items) return [];\n  \n  return menu.items\n    .filter(item => {\n      // Filtros bÃ¡sicos\n      if (item.calories > macrosAvailable.calories * 1.15) return false;\n      \n      // Filtros do usuÃ¡rio\n      if (filters.noCarne && /carne|picanha|filÃ©|bife/i.test(item.name)) return false;\n      if (filters.noFrango && /frango|chicken/i.test(item.name)) return false;\n      if (filters.noPeixe && /peixe|salmÃ£o|atum|camarÃ£o/i.test(item.name)) return false;\n      if (filters.lowCarb && item.carbs > 30) return false;\n      if (filters.highProtein && item.protein < 25) return false;\n      \n      return true;\n    })\n    .sort((a, b) => (b.protein / b.calories) - (a.protein / a.calories))\n    .slice(0, 5);\n}\n\nfunction detectRefinementFilters(message) {\n  const filters = {};\n  const m = message.toLowerCase();\n  \n  if (/sem\\s*carne|vegetarian|vegano/i.test(m)) filters.noCarne = true;\n  if (/sem\\s*frango/i.test(m)) filters.noFrango = true;\n  if (/sem\\s*peixe|sem\\s*frutos/i.test(m)) filters.noPeixe = true;\n  if (/low\\s*carb|sem\\s*carb|menos\\s*carb|pouco\\s*carb/i.test(m)) filters.lowCarb = true;\n  if (/mais\\s*prote[iÃ­]na|alta\\s*prote[iÃ­]na/i.test(m)) filters.highProtein = true;\n  if (/mais\\s*leve|menos\\s*caloria/i.test(m)) filters.lighter = true;\n  \n  return filters;\n}\n\n// =====================================================\n// 4. PROCESSAMENTO PRINCIPAL\n// =====================================================\n\n// Buscar dados do contexto anterior\nconst currentItem = $('6. Construir Contexto IA').first().json || {};\nconst userMessage = currentItem.messageContent || '';\nconst dietPlan = currentItem.dietPlan || {};\nconst patientName = currentItem.patientName || 'Paciente';\n\nconsole.log('ðŸ” [6b] Analisando mensagem:', userMessage);\n\n// Detectar se Ã© pergunta sobre restaurante\nlet restaurantName = null;\nlet isRestaurantQuery = false;\nlet isRefinementRequest = false;\n\n// Verificar se Ã© pedido de refinamento\nfor (const pattern of REFINEMENT_PATTERNS) {\n  if (pattern.test(userMessage)) {\n    isRefinementRequest = true;\n    break;\n  }\n}\n\n// Verificar se Ã© pergunta sobre restaurante\nfor (const pattern of RESTAURANT_PATTERNS) {\n  const match = userMessage.match(pattern);\n  if (match) {\n    const groups = match.filter(g => g && g.length > 2);\n    restaurantName = groups[groups.length - 1];\n    isRestaurantQuery = true;\n    break;\n  }\n}\n\n// Se nÃ£o Ã© sobre restaurante, passar adiante sem modificaÃ§Ã£o\nif (!isRestaurantQuery && !isRefinementRequest) {\n  console.log('âŒ [6b] NÃ£o Ã© pergunta sobre restaurante');\n  return { json: { ...currentItem, isRestaurantQuery: false } };\n}\n\nconsole.log('âœ… [6b] Detectado restaurante:', restaurantName);\n\n// Normalizar nome do restaurante\nconst normalizedName = normalizeRestaurantName(restaurantName);\nconst menu = RESTAURANT_MENUS[normalizedName];\nconst isKnownRestaurant = !!menu;\n\n// Detectar filtros de refinamento\nconst userFilters = detectRefinementFilters(userMessage);\nconsole.log('ðŸ” [6b] Filtros detectados:', userFilters);\n\n// RefeiÃ§Ã£o atual baseada no horÃ¡rio\nconst now = new Date();\nconst currentHour = now.getHours();\nconst currentMeal = getMealTypeByHour(currentHour);\n\n// Calcular macros disponÃ­veis para a refeiÃ§Ã£o\nconst dailyMacros = dietPlan.macros || { protein: 120, carbs: 180, fats: 60, calories: 1800 };\nconst mealFraction = (currentMeal.type === 'almoco' || currentMeal.type === 'jantar') ? 0.35 : 0.15;\n\nconst macrosAvailable = {\n  protein: Math.round(dailyMacros.protein * mealFraction),\n  carbs: Math.round(dailyMacros.carbs * mealFraction),\n  fats: Math.round(dailyMacros.fats * mealFraction),\n  calories: Math.round(dailyMacros.calories * mealFraction)\n};\n\nconsole.log('ðŸ“Š [6b] Macros disponÃ­veis:', macrosAvailable);\n\n// Encontrar sugestÃµes do cardÃ¡pio (com filtros aplicados)\nlet suggestions = isKnownRestaurant ? findMatchingItems(menu, macrosAvailable, userFilters) : [];\n\n// =====================================================\n// 5. MONTAR CONTEXTO PARA A IA\n// =====================================================\nconst restaurantContext = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ½ï¸ CONTEXTO ESPECIAL - SUGESTÃƒO DE RESTAURANTE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nðŸ‘¤ PACIENTE: ${patientName}\nðŸ“ RESTAURANTE: ${isKnownRestaurant ? menu.name : (restaurantName || 'NÃ£o especificado')}\nâ° REFEIÃ‡ÃƒO: ${currentMeal.label} (${currentHour}:${String(now.getMinutes()).padStart(2, '0')})\n\nðŸ“Š CRÃ‰DITO DE MACROS PARA ${currentMeal.label.toUpperCase()}:\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘ ðŸ”¥ Calorias: ${macrosAvailable.calories} kcal               â•‘\nâ•‘ ðŸ’ª ProteÃ­na: ${macrosAvailable.protein}g                    â•‘\nâ•‘ ðŸž Carboidratos: ${macrosAvailable.carbs}g                 â•‘\nâ•‘ ðŸ¥‘ Gorduras: ${macrosAvailable.fats}g                      â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n${Object.keys(userFilters).length > 0 ? `\nðŸ” FILTROS DO PACIENTE:\n${userFilters.noCarne ? 'â€¢ Sem carne vermelha\\n' : ''}${userFilters.noFrango ? 'â€¢ Sem frango\\n' : ''}${userFilters.noPeixe ? 'â€¢ Sem peixe/frutos do mar\\n' : ''}${userFilters.lowCarb ? 'â€¢ Low carb (menos carboidrato)\\n' : ''}${userFilters.highProtein ? 'â€¢ Alta proteÃ­na\\n' : ''}${userFilters.lighter ? 'â€¢ OpÃ§Ãµes mais leves\\n' : ''}\n` : ''}\n\n${isKnownRestaurant ? `\nâœ… RESTAURANTE CATALOGADO: ${menu.name}\n\nðŸ” OPÃ‡Ã•ES QUE CABEM NO SEU PLANO:\n${suggestions.length > 0 ? suggestions.map(s => \n  `â€¢ ${s.name} (${s.portion}) - ${s.calories}kcal | ${s.protein}g P | ${s.carbs}g C | ${s.fats}g G`\n).join('\\n') : 'âš ï¸ Nenhuma opÃ§Ã£o encontrada com os filtros atuais.'}\n\nðŸ“‹ CARDÃPIO COMPLETO (para referÃªncia):\n${menu.items.map(i => `â€¢ ${i.name}: ${i.calories}kcal | ${i.protein}g P | ${i.carbs}g C | ${i.fats}g G`).join('\\n')}\n` : `\nâš ï¸ RESTAURANTE NÃƒO CATALOGADO: \"${restaurantName || 'desconhecido'}\"\n\nUse seu conhecimento geral sobre este restaurante para sugerir opÃ§Ãµes.\nPriorize:\nâ€¢ ProteÃ­nas magras (frango grelhado, peixe, filÃ©)\nâ€¢ Saladas e vegetais\nâ€¢ PorÃ§Ãµes menores\nâ€¢ Evitar frituras e molhos pesados\n\nSe nÃ£o conhecer o restaurante, pergunte ao paciente qual o tipo de comida servida.\n`}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸŽ¯ FORMATO OBRIGATÃ“RIO DA RESPOSTA:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nResponda EXATAMENTE neste formato:\n\n\"Seu crÃ©dito para o ${currentMeal.label.toLowerCase()} Ã© de:\nðŸ“Š ${macrosAvailable.calories} kcal | ${macrosAvailable.protein}g P | ${macrosAvailable.carbs}g C | ${macrosAvailable.fats}g G\n\nNo ${isKnownRestaurant ? menu.name : (restaurantName || 'restaurante')}, considerando esses macros, vocÃª pode escolher:\n\nâœ… [OpÃ§Ã£o 1] (porÃ§Ã£o) - Xkcal | Xg P | Xg C | Xg G\n   ðŸ’¡ [Dica de ajuste se necessÃ¡rio]\n\nâœ… [OpÃ§Ã£o 2] (porÃ§Ã£o) - Xkcal | Xg P | Xg C | Xg G\n\nâœ… [OpÃ§Ã£o 3] (porÃ§Ã£o) - Xkcal | Xg P | Xg C | Xg G\n\nâŒ Evite: [2-3 itens que estouram os macros]\n\nðŸ’¬ Quer outras opÃ§Ãµes? Me diz o que prefere (mais leve, sem carne, low carb...)!\"\n\nREGRAS:\n1. Seja ESPECÃFICO com porÃ§Ãµes\n2. Sugira AJUSTES quando necessÃ¡rio (ex: \"sem batata\", \"meia porÃ§Ã£o\")\n3. SEMPRE ofereÃ§a a opÃ§Ã£o de refinamento no final\n4. Priorize opÃ§Ãµes com MAIS proteÃ­na\n5. MÃ¡ximo 3-4 sugestÃµes principais\n6. Se paciente pedir algo diferente, adapte as sugestÃµes\n`;\n\nconsole.log('âœ… [6b] Contexto de restaurante gerado');\n\nreturn {\n  json: {\n    ...currentItem,\n    isRestaurantQuery: true,\n    restaurantName: isKnownRestaurant ? menu.name : restaurantName,\n    isKnownRestaurant: isKnownRestaurant,\n    currentMeal: currentMeal,\n    macrosAvailable: macrosAvailable,\n    suggestions: suggestions,\n    userFilters: userFilters,\n    isRefinementRequest: isRefinementRequest,\n    // SUBSTITUIR o contexto original pelo contexto de restaurante\n    context: restaurantContext\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        27392,
        -192
      ],
      "id": "0964728a-81da-4eb7-92ea-373d48fbe1b1",
      "name": "6b. Detectar Restaurante"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// BUSCAR BANCO DE APRENDIZADO + PASSAR DADOS (MERGE)\n// =====================================================\n// IMPORTANTE: Este nÃ³ precisa:\n// 1. Fazer o HTTP request para buscar dados de aprendizado\n// 2. MANTER todos os dados que vieram do input (anÃ¡lise, etc)\n// =====================================================\n\nconst inputData = $input.first().json;\n\nconsole.log('ðŸŽ“ === BUSCAR APRENDIZADO ===');\nconsole.log('ðŸ“¥ Campos recebidos do input:', Object.keys(inputData).slice(0, 10).join(', '));\n\n// Verificar se tem anÃ¡lise no input\nconst temAnalise = !!(\n  inputData.analise_foto?.alimentos?.length ||\n  inputData.analysisData?.alimentos?.length ||\n  inputData.comparison?.alimentos?.length ||\n  inputData.alimentos?.length\n);\n\nconsole.log('ðŸ• Tem anÃ¡lise no input:', temAnalise);\n\n// Buscar dados de aprendizado do Firebase\nlet dadosAprendizado = {};\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'GET',\n    url: 'https://web-production-c9eaf.up.railway.app/api/n8n/food-learning',\n    headers: {\n      'X-Webhook-Secret': 'nutribuddy-secret-2024',\n      'Content-Type': 'application/json'\n    },\n    qs: {\n      patientId: inputData.patientId\n    }\n  });\n\n  dadosAprendizado = response.data || {};\n  console.log('âœ… Dados de aprendizado recuperados:', Object.keys(dadosAprendizado).length, 'alimentos');\n\n} catch (error) {\n  console.log('âš ï¸ Banco de aprendizado nÃ£o disponÃ­vel:', error.message);\n  dadosAprendizado = {};\n}\n\n// =====================================================\n// ðŸ”¥ RETORNO: MANTER TODOS OS DADOS DO INPUT + APRENDIZADO\n// =====================================================\n\nreturn {\n  json: {\n    // ðŸ”¥ CRUCIAL: Passar TODOS os dados do input\n    ...inputData,\n    \n    // Adicionar dados de aprendizado\n    dadosAprendizado: dadosAprendizado,\n    dados: dadosAprendizado, // Alias para compatibilidade\n    \n    // Metadata\n    _aprendizadoCarregado: Object.keys(dadosAprendizado).length > 0,\n    _aprendizadoTotal: Object.keys(dadosAprendizado).length\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        29312,
        -720
      ],
      "id": "2935ba03-b1fb-4326-ad75-d7316faa9e60",
      "name": "Buscar Banco Aprendizado"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// ðŸ§  NÃ“ DE REFLEXÃƒO INTELIGENTE - META-COGNIÃ‡ÃƒO (V2)\n// =====================================================\n// CORRIGIDO: Usa $input em vez de referÃªncias a nÃ³s especÃ­ficos\n// Assim funciona independente da ordem do workflow\n// =====================================================\n\nconst CONFIG = {\n  MAX_MENSAGENS_HISTORICO: 20,\n  TOLERANCIA_DIFERENCA_KCAL: 50,\n  TOLERANCIA_DIFERENCA_MACRO: 10,\n  TEMPO_CONTEXTO_MINUTOS: 30,\n  MIN_AMOSTRAS_APRENDIZADO: 3,\n};\n\n// =====================================================\n// ðŸ”¥ BUSCAR DADOS DO INPUT (nÃ£o de nÃ³s especÃ­ficos!)\n// =====================================================\n\nconst inputData = $input.first().json;\n\nconsole.log('ðŸ§  === REFLEXÃƒO V2 - USANDO INPUT ===');\nconsole.log('ðŸ“¥ Campos no input:', Object.keys(inputData).join(', '));\n\n// Dados bÃ¡sicos\nconst patientId = inputData.patientId;\nconst conversationId = inputData.conversationId;\nconst mensagemAtual = inputData.content || inputData.messageContent || '';\nconst temFoto = inputData.hasImage || inputData._photoPriority || inputData.mediaUrl;\n\n// ðŸ• ANÃLISE - buscar de vÃ¡rias formas possÃ­veis\nlet analiseAtual = null;\n\n// Tentar diferentes campos onde a anÃ¡lise pode estar\nconst possiveisCampos = [\n  'analise_foto',\n  'analysisData', \n  'comparison',\n  'analise',\n  'parsed_response',\n  'gpt_analysis'\n];\n\nfor (const campo of possiveisCampos) {\n  if (inputData[campo] && (inputData[campo].alimentos || inputData[campo].macros_totais)) {\n    analiseAtual = inputData[campo];\n    console.log(`ðŸ“Š AnÃ¡lise encontrada em: ${campo}`);\n    break;\n  }\n}\n\n// Se ainda nÃ£o encontrou, procurar alimentos diretamente no input\nif (!analiseAtual) {\n  if (inputData.alimentos && Array.isArray(inputData.alimentos)) {\n    analiseAtual = {\n      alimentos: inputData.alimentos,\n      macros_totais: inputData.macros_totais || inputData.macros || {}\n    };\n    console.log('ðŸ“Š AnÃ¡lise encontrada diretamente no input');\n  }\n}\n\n// Fallback: criar anÃ¡lise vazia\nif (!analiseAtual) {\n  analiseAtual = { alimentos: [], macros_totais: {} };\n  console.log('âš ï¸ Nenhuma anÃ¡lise encontrada, usando vazio');\n}\n\n// Dados de aprendizado (podem vir do nÃ³ anterior Buscar Aprendizado)\nconst dadosAprendizado = inputData.dados || inputData.dadosAprendizado || {};\n\nconsole.log('ðŸ“ Mensagem:', mensagemAtual.substring(0, 50) + '...');\nconsole.log('ðŸ• Alimentos:', (analiseAtual.alimentos || []).length);\nconsole.log('ðŸŽ“ Aprendizado:', Object.keys(dadosAprendizado).length, 'alimentos');\n\n// =====================================================\n// FUNÃ‡Ã•ES DE ANÃLISE\n// =====================================================\n\nfunction extrairValores(texto) {\n  const valores = { calorias: null, proteinas: null, carboidratos: null, gorduras: null };\n  if (!texto) return valores;\n  \n  const kcalMatch = texto.match(/(\\d+)\\s*(?:kcal|calorias?)/i);\n  if (kcalMatch) valores.calorias = parseInt(kcalMatch[1]);\n  \n  const protMatch = texto.match(/(\\d+)\\s*g?\\s*(?:de\\s+)?(?:prote[Ã­i]na|P\\b)/i);\n  if (protMatch) valores.proteinas = parseInt(protMatch[1]);\n  \n  const carbMatch = texto.match(/(\\d+)\\s*g?\\s*(?:de\\s+)?(?:carboidrato|carb|C\\b)/i);\n  if (carbMatch) valores.carboidratos = parseInt(carbMatch[1]);\n  \n  const gordMatch = texto.match(/(\\d+)\\s*g?\\s*(?:de\\s+)?(?:gordura|G\\b)/i);\n  if (gordMatch) valores.gorduras = parseInt(gordMatch[1]);\n  \n  return valores;\n}\n\nfunction detectarCorrecao(mensagem) {\n  const padroes = [\n    /na verdade/i, /na real/i, /errado/i, /corrig/i, /ajust/i,\n    /nÃ£o era/i, /eram? \\d+/i, /era \\d+/i, /sÃ³ \\d+/i, /apenas \\d+/i\n  ];\n  return padroes.some(p => p.test(mensagem));\n}\n\n// =====================================================\n// EXTRAIR VALORES DA ANÃLISE\n// =====================================================\n\nconst alimentosAtuais = analiseAtual.alimentos || [];\nconst macrosAtuais = analiseAtual.macros_totais || {};\n\nconst valoresAtuais = {\n  calorias: Math.round(macrosAtuais.calorias || macrosAtuais.calories || 0),\n  proteinas: Math.round(macrosAtuais.proteinas || macrosAtuais.protein || 0),\n  carboidratos: Math.round(macrosAtuais.carboidratos || macrosAtuais.carbs || 0),\n  gorduras: Math.round(macrosAtuais.gorduras || macrosAtuais.fats || 0)\n};\n\nconsole.log('ðŸ“Š Valores da anÃ¡lise:', valoresAtuais);\n\n// Se nÃ£o tem valores, tentar calcular da lista de alimentos\nif (valoresAtuais.calorias === 0 && alimentosAtuais.length > 0) {\n  console.log('ðŸ”„ Calculando macros da lista de alimentos...');\n  \n  alimentosAtuais.forEach(alimento => {\n    const macros = alimento.macros || alimento.nutrition || {};\n    valoresAtuais.calorias += Math.round(macros.calorias || macros.calories || 0);\n    valoresAtuais.proteinas += Math.round(macros.proteinas || macros.protein || 0);\n    valoresAtuais.carboidratos += Math.round(macros.carboidratos || macros.carbs || 0);\n    valoresAtuais.gorduras += Math.round(macros.gorduras || macros.fats || 0);\n  });\n  \n  console.log('ðŸ“Š Valores recalculados:', valoresAtuais);\n}\n\n// =====================================================\n// DECISÃƒO\n// =====================================================\n\nconst ehCorrecao = detectarCorrecao(mensagemAtual);\n\nlet decisao = {\n  acao: alimentosAtuais.length > 0 ? 'responder_normal' : 'sem_alimentos',\n  usarValoresHistorico: false,\n  valoresParaUsar: valoresAtuais,\n  alertas: [],\n  sugestoes: []\n};\n\nif (alimentosAtuais.length === 0 && temFoto) {\n  decisao.alertas.push({\n    tipo: 'foto_sem_analise',\n    mensagem: 'Foto enviada mas nenhum alimento foi identificado na anÃ¡lise'\n  });\n}\n\n// =====================================================\n// CONTEXTO PARA A IA\n// =====================================================\n\nconst contextoReflexao = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ§  REFLEXÃƒO INTELIGENTE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nðŸ“Š ALIMENTOS IDENTIFICADOS: ${alimentosAtuais.length}\n${alimentosAtuais.length > 0 ? alimentosAtuais.map(a => `   â€¢ ${a.nome || a.name}`).join('\\n') : '   âš ï¸ Nenhum alimento identificado'}\n\nâœ… VALORES A USAR:\n   Calorias: ${valoresAtuais.calorias} kcal\n   ProteÃ­na: ${valoresAtuais.proteinas}g\n   Carboidratos: ${valoresAtuais.carboidratos}g\n   Gorduras: ${valoresAtuais.gorduras}g\n\n${ehCorrecao ? 'ðŸ”§ CORREÃ‡ÃƒO DETECTADA - aceitar novos valores do paciente' : ''}\n\nâš ï¸ REGRAS:\n1. USE EXATAMENTE os valores acima\n2. NÃƒO calcule outros valores\n3. Seja DIRETO e CONCISO\n`;\n\nconsole.log('âœ… ReflexÃ£o concluÃ­da. Alimentos:', alimentosAtuais.length);\n\n// =====================================================\n// RETORNO - passar TUDO para o prÃ³ximo nÃ³\n// =====================================================\n\nreturn {\n  json: {\n    // Passar todos os dados originais\n    ...inputData,\n    \n    // AnÃ¡lise (garantir que estÃ¡ disponÃ­vel)\n    analise_foto: analiseAtual,\n    \n    // Valores definitivos\n    _valoresDefinitivos: valoresAtuais,\n    _alimentosIdentificados: alimentosAtuais,\n    \n    // Contexto de reflexÃ£o\n    _contextoReflexao: contextoReflexao,\n    _reflexao: {\n      decisao: decisao,\n      ehCorrecao: ehCorrecao\n    },\n    \n    // Alertas\n    _alertas: decisao.alertas\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        29536,
        -720
      ],
      "id": "505bd6fb-a124-4303-8627-03c5d372d811",
      "name": "ReflexÃ£o Inteligente"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// ðŸ“¤ ENVIAR CORREÃ‡ÃƒO PARA APRENDIZADO\n// =====================================================\n// Este nÃ³ deve ser chamado quando o paciente corrige\n// uma estimativa da IA. Ele envia os dados para o \n// sistema de calibraÃ§Ã£o para aprendizado contÃ­nuo.\n// =====================================================\n//\n// ONDE COLOCAR NO N8N:\n// ApÃ³s \"FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o\" ou quando detectar\n// que o paciente estÃ¡ corrigindo valores.\n//\n// FLUXO:\n// CorreÃ§Ã£o do paciente â†’ Este nÃ³ â†’ API de calibraÃ§Ã£o\n// =====================================================\n\nconst inputData = $input.first().json;\n\n// Tentar pegar dados da correÃ§Ã£o\nlet dadosCorrecao = inputData.correction || inputData.contextUpdate?.data || {};\nconst patientId = inputData.patientId;\nconst conversationId = inputData.conversationId;\n\nconsole.log('ðŸ“¤ === ENVIANDO CORREÃ‡ÃƒO PARA APRENDIZADO ===');\nconsole.log('ðŸ“ Dados da correÃ§Ã£o:', JSON.stringify(dadosCorrecao).substring(0, 200));\n\n// Verificar se tem dados vÃ¡lidos para enviar\nif (!dadosCorrecao.originalFood && !dadosCorrecao.newFood && !dadosCorrecao.alimentos) {\n  console.log('âš ï¸ Nenhuma correÃ§Ã£o vÃ¡lida para enviar');\n  return { json: { ...inputData, _aprendizadoEnviado: false, _motivo: 'sem_dados' } };\n}\n\n// Preparar dados para a API de calibraÃ§Ã£o\nconst sugestoes = [];\n\n// Se tem correÃ§Ã£o de alimento especÃ­fico\nif (dadosCorrecao.originalFood && dadosCorrecao.newFood) {\n  sugestoes.push({\n    tipo: 'correcao_alimento',\n    alimentoOriginal: dadosCorrecao.originalFood,\n    alimentoCorrigido: dadosCorrecao.newFood,\n    pesoOriginal: dadosCorrecao.originalWeight,\n    pesoCorrigido: dadosCorrecao.newWeight,\n    fonte: 'correcao_paciente',\n    patientId: patientId,\n    timestamp: new Date().toISOString()\n  });\n}\n\n// Se tem lista de alimentos corrigidos\nif (dadosCorrecao.foods && Array.isArray(dadosCorrecao.foods)) {\n  dadosCorrecao.foods.forEach(food => {\n    if (food.corrigido || food.fonte === 'correcao') {\n      sugestoes.push({\n        tipo: 'peso_corrigido',\n        nomeAlimento: food.nome || food.name,\n        pesoOriginal: food.pesoOriginal || food.peso_estimado,\n        pesoCorrigido: food.peso_gramas || food.peso,\n        macrosCorrigidos: food.macros,\n        fonte: 'correcao_paciente',\n        patientId: patientId,\n        timestamp: new Date().toISOString()\n      });\n    }\n  });\n}\n\n// Se nÃ£o tem sugestÃµes especÃ­ficas, mas tem alimentos, criar sugestÃ£o genÃ©rica\nif (sugestoes.length === 0 && dadosCorrecao.alimentos) {\n  sugestoes.push({\n    tipo: 'refeicao_corrigida',\n    alimentos: dadosCorrecao.alimentos,\n    macrosTotais: dadosCorrecao.totalMacros || dadosCorrecao.macros,\n    descricao: inputData.userMessage || inputData.content,\n    fonte: 'correcao_paciente',\n    patientId: patientId,\n    timestamp: new Date().toISOString()\n  });\n}\n\nconsole.log(`ðŸ“Š ${sugestoes.length} sugestÃ£o(Ãµes) para enviar`);\n\n// Enviar para a API de calibraÃ§Ã£o\nif (sugestoes.length > 0) {\n  try {\n    for (const sugestao of sugestoes) {\n      const response = await this.helpers.httpRequest({\n        method: 'POST',\n        url: 'https://web-production-c9eaf.up.railway.app/api/n8n/food-calibration/suggestions',\n        headers: {\n          'X-Webhook-Secret': 'nutribuddy-secret-2024',\n          'Content-Type': 'application/json'\n        },\n        body: {\n          patientId: patientId,\n          conversationId: conversationId,\n          suggestion: sugestao,\n          status: 'pending', // Aguardando aprovaÃ§Ã£o do nutricionista\n          createdAt: new Date().toISOString()\n        }\n      });\n      \n      console.log('âœ… SugestÃ£o enviada:', sugestao.tipo);\n    }\n    \n    return { \n      json: { \n        ...inputData, \n        _aprendizadoEnviado: true, \n        _sugestoesEnviadas: sugestoes.length \n      } \n    };\n    \n  } catch (error) {\n    console.log('âŒ Erro ao enviar:', error.message);\n    return { \n      json: { \n        ...inputData, \n        _aprendizadoEnviado: false, \n        _erro: error.message \n      } \n    };\n  }\n}\n\nreturn { json: { ...inputData, _aprendizadoEnviado: false, _motivo: 'sem_sugestoes' } };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        27168,
        96
      ],
      "id": "3feac044-f861-4b53-a9b4-2edf628f4d27",
      "name": "Enviar Aprendizado"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// ðŸ“ CALIBRAÃ‡ÃƒO INTELIGENTE DE PORÃ‡Ã•ES\n// =====================================================\n// Ajusta quantidades baseado em:\n// 1. Colheres rasas vs cheias (padrÃ£o: rasas)\n// 2. Tamanhos de porÃ§Ãµes comuns no Brasil\n// 3. Aprendizado de correÃ§Ãµes anteriores\n// =====================================================\n\n// =====================================================\n// TABELA DE PORÃ‡Ã•ES BRASILEIRAS (TACO + IBGE POF)\n// =====================================================\n\nconst PORCOES = {\n  // COLHERES\n  colher_sopa: {\n    rasa: { peso: 10, descricao: 'colher de sopa rasa' },\n    cheia: { peso: 15, descricao: 'colher de sopa cheia' },\n    padrao: 'rasa' // Assumir rasa por padrÃ£o\n  },\n  \n  colher_sobremesa: {\n    rasa: { peso: 5, descricao: 'colher de sobremesa rasa' },\n    cheia: { peso: 8, descricao: 'colher de sobremesa cheia' },\n    padrao: 'rasa'\n  },\n  \n  colher_cha: {\n    rasa: { peso: 3, descricao: 'colher de chÃ¡ rasa' },\n    cheia: { peso: 5, descricao: 'colher de chÃ¡ cheia' },\n    padrao: 'rasa'\n  },\n  \n  // COPOS E XÃCARAS\n  copo_americano: { peso: 200, descricao: 'copo americano (200ml)' },\n  xicara_cha: { peso: 180, descricao: 'xÃ­cara de chÃ¡' },\n  xicara_cafe: { peso: 50, descricao: 'xÃ­cara de cafÃ©' },\n  \n  // UNIDADES COMUNS\n  fatia_pao: { peso: 25, descricao: 'fatia de pÃ£o de forma' },\n  fatia_queijo: { peso: 20, descricao: 'fatia de queijo' },\n  fatia_presunto: { peso: 15, descricao: 'fatia de presunto' },\n  fatia_pizza: { peso: 100, descricao: 'fatia de pizza mÃ©dia' },\n  \n  // PORÃ‡Ã•ES PADRÃƒO\n  porcao_arroz: { peso: 100, descricao: 'porÃ§Ã£o de arroz (escumadeira)' },\n  porcao_feijao: { peso: 80, descricao: 'porÃ§Ã£o de feijÃ£o (concha)' },\n  porcao_carne: { peso: 100, descricao: 'porÃ§Ã£o de carne (palma da mÃ£o)' },\n  porcao_salada: { peso: 50, descricao: 'porÃ§Ã£o de salada' }\n};\n\n// =====================================================\n// MACROS POR 100G (TABELA TACO + USDA)\n// =====================================================\n\nconst MACROS_100G = {\n  // TAPIOCA\n  tapioca: { nome: 'Tapioca (goma)', p: 0.1, c: 87, g: 0.1, cal: 345, densidade: 0.5 },\n  tapioca_hidratada: { nome: 'Tapioca hidratada', p: 0.1, c: 26, g: 0, cal: 100, densidade: 0.8 },\n  \n  // OVOS\n  ovo: { nome: 'Ovo inteiro', p: 13, c: 1, g: 10, cal: 140, peso_unidade: 50 },\n  clara: { nome: 'Clara de ovo', p: 11, c: 1, g: 0, cal: 50, peso_unidade: 33 },\n  gema: { nome: 'Gema de ovo', p: 16, c: 1, g: 27, cal: 320, peso_unidade: 17 },\n  \n  // QUEIJOS\n  queijo_mussarela: { nome: 'Queijo mussarela', p: 22, c: 2, g: 22, cal: 290, peso_fatia: 20 },\n  queijo_prato: { nome: 'Queijo prato', p: 23, c: 1, g: 25, cal: 320, peso_fatia: 20 },\n  queijo_cottage: { nome: 'Queijo cottage', p: 12, c: 3, g: 4, cal: 100 },\n  \n  // CARNES\n  frango_peito: { nome: 'Peito de frango', p: 31, c: 0, g: 3, cal: 165 },\n  frango_coxa: { nome: 'Coxa de frango', p: 26, c: 0, g: 10, cal: 200 },\n  carne_patinho: { nome: 'Carne bovina (patinho)', p: 35, c: 0, g: 7, cal: 200 },\n  carne_acÃ©m: { nome: 'Carne bovina (acÃ©m)', p: 26, c: 0, g: 15, cal: 250 },\n  \n  // CARBOIDRATOS\n  arroz_branco: { nome: 'Arroz branco cozido', p: 2.5, c: 28, g: 0.3, cal: 130 },\n  arroz_integral: { nome: 'Arroz integral cozido', p: 2.6, c: 23, g: 0.9, cal: 110 },\n  feijao_carioca: { nome: 'FeijÃ£o carioca cozido', p: 5, c: 14, g: 0.5, cal: 80 },\n  batata: { nome: 'Batata cozida', p: 2, c: 17, g: 0.1, cal: 77 },\n  macarrao: { nome: 'MacarrÃ£o cozido', p: 5, c: 25, g: 0.5, cal: 125 },\n  \n  // PÃƒES\n  pao_frances: { nome: 'PÃ£o francÃªs', p: 8, c: 57, g: 3, cal: 290, peso_unidade: 50 },\n  pao_forma: { nome: 'PÃ£o de forma', p: 9, c: 50, g: 4, cal: 275, peso_fatia: 25 },\n  pao_integral: { nome: 'PÃ£o integral', p: 11, c: 42, g: 5, cal: 255, peso_fatia: 25 },\n  \n  // FRUTAS\n  banana: { nome: 'Banana', p: 1.1, c: 23, g: 0.3, cal: 89, peso_unidade: 100 },\n  maca: { nome: 'MaÃ§Ã£', p: 0.3, c: 14, g: 0.2, cal: 52, peso_unidade: 130 },\n  laranja: { nome: 'Laranja', p: 0.9, c: 12, g: 0.1, cal: 47, peso_unidade: 150 },\n  \n  // LEITE E DERIVADOS\n  leite_integral: { nome: 'Leite integral', p: 3, c: 5, g: 3, cal: 60 },\n  leite_desnatado: { nome: 'Leite desnatado', p: 3.4, c: 5, g: 0.1, cal: 35 },\n  iogurte_natural: { nome: 'Iogurte natural', p: 4, c: 6, g: 3, cal: 65 },\n  \n  // PIZZA\n  pizza_mussarela: { nome: 'Pizza mussarela', p: 11, c: 28, g: 9, cal: 240 },\n  pizza_frango: { nome: 'Pizza frango catupiry', p: 14, c: 26, g: 12, cal: 270 }\n};\n\n// =====================================================\n// FUNÃ‡ÃƒO: INTERPRETAR QUANTIDADE\n// =====================================================\n\nfunction interpretarQuantidade(texto, nomeAlimento) {\n  texto = (texto || '').toLowerCase();\n  nomeAlimento = (nomeAlimento || '').toLowerCase();\n  \n  let resultado = {\n    quantidade: 1,\n    unidade: 'unidade',\n    pesoGramas: 0,\n    confianca: 'media',\n    tipoColher: null\n  };\n  \n  // Detectar colheres\n  const matchColher = texto.match(/(\\d+)\\s*colher(?:es)?(?:\\s+de)?\\s*(sopa|sobremesa|chÃ¡|cha)/i);\n  if (matchColher) {\n    const qtd = parseInt(matchColher[1]);\n    const tipo = matchColher[2].toLowerCase().replace('Ã¡', 'a');\n    \n    // Verificar se especificou rasa ou cheia\n    const ehCheia = texto.includes('cheia');\n    const ehRasa = texto.includes('rasa') || !ehCheia; // PadrÃ£o: rasa\n    \n    let tipoColher = 'colher_sopa';\n    if (tipo === 'sobremesa') tipoColher = 'colher_sobremesa';\n    if (tipo === 'cha') tipoColher = 'colher_cha';\n    \n    const porcao = PORCOES[tipoColher];\n    const pesoPorColher = ehRasa ? porcao.rasa.peso : porcao.cheia.peso;\n    \n    resultado = {\n      quantidade: qtd,\n      unidade: tipoColher,\n      pesoGramas: qtd * pesoPorColher,\n      confianca: 'alta',\n      tipoColher: ehRasa ? 'rasa' : 'cheia'\n    };\n    \n    console.log(`ðŸ“ ${qtd} ${porcao.rasa.descricao} = ${resultado.pesoGramas}g`);\n    return resultado;\n  }\n  \n  // Detectar fatias\n  const matchFatia = texto.match(/(\\d+)\\s*fatia(?:s)?/i);\n  if (matchFatia) {\n    const qtd = parseInt(matchFatia[1]);\n    let pesoFatia = 20; // PadrÃ£o\n    \n    if (nomeAlimento.includes('queijo')) pesoFatia = PORCOES.fatia_queijo.peso;\n    if (nomeAlimento.includes('presunto')) pesoFatia = PORCOES.fatia_presunto.peso;\n    if (nomeAlimento.includes('pÃ£o') || nomeAlimento.includes('pao')) pesoFatia = PORCOES.fatia_pao.peso;\n    if (nomeAlimento.includes('pizza')) pesoFatia = PORCOES.fatia_pizza.peso;\n    \n    resultado = {\n      quantidade: qtd,\n      unidade: 'fatia',\n      pesoGramas: qtd * pesoFatia,\n      confianca: 'alta'\n    };\n    return resultado;\n  }\n  \n  // Detectar gramas explÃ­citas\n  const matchGramas = texto.match(/(\\d+)\\s*(?:g|gramas?)/i);\n  if (matchGramas) {\n    resultado = {\n      quantidade: parseInt(matchGramas[1]),\n      unidade: 'gramas',\n      pesoGramas: parseInt(matchGramas[1]),\n      confianca: 'muito_alta'\n    };\n    return resultado;\n  }\n  \n  // Detectar unidades\n  const matchUnidade = texto.match(/(\\d+)\\s*(ovos?|bananas?|maÃ§Ã£s?|laranjas?)/i);\n  if (matchUnidade) {\n    const qtd = parseInt(matchUnidade[1]);\n    let pesoUnidade = 50; // PadrÃ£o\n    \n    const item = matchUnidade[2].toLowerCase();\n    if (item.includes('ovo')) pesoUnidade = MACROS_100G.ovo.peso_unidade;\n    if (item.includes('banana')) pesoUnidade = MACROS_100G.banana.peso_unidade;\n    \n    resultado = {\n      quantidade: qtd,\n      unidade: 'unidade',\n      pesoGramas: qtd * pesoUnidade,\n      confianca: 'alta'\n    };\n    return resultado;\n  }\n  \n  return resultado;\n}\n\n// =====================================================\n// FUNÃ‡ÃƒO: CALCULAR MACROS COM CALIBRAÃ‡ÃƒO\n// =====================================================\n\nfunction calcularMacrosCalibrados(nomeAlimento, pesoGramas, fatorAprendizado = 1.0) {\n  nomeAlimento = (nomeAlimento || '').toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '');\n  \n  // Buscar na tabela\n  let macrosRef = null;\n  for (const [key, dados] of Object.entries(MACROS_100G)) {\n    if (nomeAlimento.includes(key) || key.includes(nomeAlimento.split(' ')[0])) {\n      macrosRef = dados;\n      break;\n    }\n  }\n  \n  if (!macrosRef) {\n    console.log(`âš ï¸ ${nomeAlimento} nÃ£o encontrado na tabela TACO`);\n    return null;\n  }\n  \n  // Aplicar fator de aprendizado\n  const pesoAjustado = pesoGramas * fatorAprendizado;\n  const fator = pesoAjustado / 100;\n  \n  return {\n    nome: macrosRef.nome,\n    peso_gramas: Math.round(pesoAjustado),\n    macros: {\n      proteinas: Math.round(macrosRef.p * fator * 10) / 10,\n      carboidratos: Math.round(macrosRef.c * fator * 10) / 10,\n      gorduras: Math.round(macrosRef.g * fator * 10) / 10,\n      calorias: Math.round(macrosRef.cal * fator)\n    },\n    fonte: 'TACO_calibrado',\n    fatorAprendizado: fatorAprendizado\n  };\n}\n\n// =====================================================\n// CÃ“DIGO DO NÃ“ N8N\n// =====================================================\n\nconst inputData = $input.first().json;\nconst textoDescritivo = inputData.recordatorio?.textoDescritivo || inputData.content || '';\n\n// Buscar alimentos e dados de aprendizado\nlet alimentos = inputData.analise_foto?.alimentos || inputData.alimentos || [];\nconst dadosAprendizado = inputData.dadosAprendizado || inputData.dados || {};\n\nconsole.log('ðŸ“ === CALIBRAÃ‡ÃƒO DE PORÃ‡Ã•ES ===');\nconsole.log('ðŸ“ Texto:', textoDescritivo.substring(0, 50));\nconsole.log('ðŸ¥— Alimentos para calibrar:', alimentos.length);\n\n// Processar cada alimento\nconst alimentosCalibrados = [];\nlet macrosTotais = { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 };\n\nfor (const alimento of alimentos) {\n  const nome = alimento.nome || alimento.name || '';\n  \n  // Interpretar quantidade do texto\n  const qtdInterpretada = interpretarQuantidade(textoDescritivo, nome);\n  \n  // Buscar fator de aprendizado se disponÃ­vel\n  let fatorAprendizado = 1.0;\n  const nomeNormalizado = nome.toLowerCase().replace(/\\s+/g, '_');\n  if (dadosAprendizado[nomeNormalizado]) {\n    fatorAprendizado = dadosAprendizado[nomeNormalizado].fator_correcao || 1.0;\n    console.log(`ðŸŽ“ Usando fator aprendido para ${nome}: ${fatorAprendizado}`);\n  }\n  \n  // Determinar peso final\n  let pesoFinal = qtdInterpretada.pesoGramas || alimento.peso_gramas || alimento.weight || 100;\n  \n  // Calcular macros com tabela TACO\n  const macrosCalc = calcularMacrosCalibrados(nome, pesoFinal, fatorAprendizado);\n  \n  if (macrosCalc) {\n    alimentosCalibrados.push({\n      ...alimento,\n      nome: macrosCalc.nome || nome,\n      peso_gramas: macrosCalc.peso_gramas,\n      macros: macrosCalc.macros,\n      _calibrado: true,\n      _fonte: macrosCalc.fonte,\n      _tipoColher: qtdInterpretada.tipoColher,\n      _fatorAprendizado: fatorAprendizado\n    });\n    \n    macrosTotais.proteinas += macrosCalc.macros.proteinas;\n    macrosTotais.carboidratos += macrosCalc.macros.carboidratos;\n    macrosTotais.gorduras += macrosCalc.macros.gorduras;\n    macrosTotais.calorias += macrosCalc.macros.calorias;\n    \n  } else {\n    // Manter original se nÃ£o encontrou na tabela\n    alimentosCalibrados.push(alimento);\n    const macros = alimento.macros || {};\n    macrosTotais.proteinas += macros.proteinas || 0;\n    macrosTotais.carboidratos += macros.carboidratos || 0;\n    macrosTotais.gorduras += macros.gorduras || 0;\n    macrosTotais.calorias += macros.calorias || 0;\n  }\n}\n\n// Arredondar totais\nmacrosTotais.proteinas = Math.round(macrosTotais.proteinas * 10) / 10;\nmacrosTotais.carboidratos = Math.round(macrosTotais.carboidratos * 10) / 10;\nmacrosTotais.gorduras = Math.round(macrosTotais.gorduras * 10) / 10;\nmacrosTotais.calorias = Math.round(macrosTotais.calorias);\n\nconsole.log('ðŸ“Š Macros calibrados:', macrosTotais);\n\nreturn {\n  json: {\n    ...inputData,\n    \n    // Alimentos calibrados\n    analise_foto: {\n      ...inputData.analise_foto,\n      alimentos: alimentosCalibrados,\n      macros_totais: macrosTotais,\n      _alimentosOriginais: alimentos\n    },\n    \n    // Metadados\n    _calibracao: {\n      aplicada: true,\n      usouTabela: 'TACO',\n      usouAprendizado: Object.keys(dadosAprendizado).length > 0,\n      tipoColherPadrao: 'rasa'\n    }\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        29984,
        -720
      ],
      "id": "c9edd74b-e95c-43e3-b4c4-d159efb9747d",
      "name": "Calibrar PorÃ§Ãµes"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// ðŸ³ DETECÃ‡ÃƒO DE PRATOS COMPOSTOS\n// =====================================================\n// Identifica quando ingredientes formam um prato Ãºnico\n// Em vez de: \"3 ovos + queijo + tapioca\" \n// Retorna: \"Crepioca (3 ovos, queijo, tapioca)\"\n// =====================================================\n\n// =====================================================\n// BASE DE PRATOS BRASILEIROS\n// =====================================================\n\nconst PRATOS_COMPOSTOS = {\n  // =====================================================\n  // PRATOS COM OVO\n  // =====================================================\n  crepioca: {\n    nome: 'Crepioca',\n    ingredientesBase: ['tapioca', 'ovo'],\n    recheiosPossiveis: ['queijo', 'frango', 'presunto', 'tomate', 'peito de peru', 'requeijÃ£o'],\n    padraoVisual: 'massa amarela dobrada ou enrolada',\n    palavrasChave: ['crepioca', 'crepyoca', 'crepe de tapioca', 'tapioca com ovo'],\n    macrosBase: { p: 12, c: 26, g: 8, cal: 220 },\n    categoria: 'cafe_manha'\n  },\n  \n  omelete: {\n    nome: 'Omelete',\n    ingredientesBase: ['ovo'],\n    recheiosPossiveis: ['queijo', 'presunto', 'tomate', 'cebola', 'pimentÃ£o', 'espinafre', 'bacon', 'calabresa'],\n    padraoVisual: 'massa amarela dobrada com recheio visÃ­vel',\n    palavrasChave: ['omelete', 'omelette', 'omelete recheado', 'omelete de'],\n    macrosBase: { p: 13, c: 1, g: 10, cal: 150 },\n    categoria: 'cafe_manha'\n  },\n  \n  ovo_mexido: {\n    nome: 'Ovos Mexidos',\n    ingredientesBase: ['ovo'],\n    recheiosPossiveis: ['queijo', 'tomate', 'cebola', 'presunto', 'bacon'],\n    padraoVisual: 'ovos mexidos no prato',\n    palavrasChave: ['ovo mexido', 'ovos mexidos', 'mexido de ovo'],\n    macrosBase: { p: 13, c: 1, g: 11, cal: 155 },\n    categoria: 'cafe_manha'\n  },\n\n  // =====================================================\n  // TAPIOCAS\n  // =====================================================\n  tapioca: {\n    nome: 'Tapioca',\n    ingredientesBase: ['tapioca'],\n    recheiosPossiveis: ['queijo', 'coco', 'frango', 'banana', 'manteiga', 'presunto', 'requeijÃ£o', 'nutella', 'doce de leite'],\n    padraoVisual: 'disco branco dobrado',\n    palavrasChave: ['tapioca', 'beiju', 'tapioca recheada', 'tapioca com'],\n    macrosBase: { p: 0.1, c: 26, g: 0, cal: 100 },\n    categoria: 'cafe_manha'\n  },\n  \n  tapioca_fit: {\n    nome: 'Tapioca Fit',\n    ingredientesBase: ['tapioca'],\n    recheiosPossiveis: ['frango', 'atum', 'queijo cottage', 'peito de peru', 'chia', 'linhaÃ§a'],\n    padraoVisual: 'disco branco com recheio proteico',\n    palavrasChave: ['tapioca fit', 'tapioca proteica', 'tapioca low carb'],\n    macrosBase: { p: 15, c: 20, g: 3, cal: 170 },\n    categoria: 'cafe_manha'\n  },\n\n  // =====================================================\n  // SANDUÃCHES\n  // =====================================================\n  sanduiche_natural: {\n    nome: 'SanduÃ­che Natural',\n    ingredientesBase: ['pÃ£o', 'frango'],\n    recheiosPossiveis: ['alface', 'tomate', 'cenoura', 'milho', 'maionese', 'requeijÃ£o', 'cream cheese'],\n    padraoVisual: 'sanduÃ­che triangular com recheio',\n    palavrasChave: ['sanduÃ­che natural', 'lanche natural', 'natural de frango'],\n    macrosBase: { p: 18, c: 30, g: 8, cal: 260 },\n    categoria: 'lanche'\n  },\n  \n  misto_quente: {\n    nome: 'Misto Quente',\n    ingredientesBase: ['pÃ£o', 'presunto', 'queijo'],\n    recheiosPossiveis: ['manteiga', 'tomate'],\n    padraoVisual: 'sanduÃ­che tostado',\n    palavrasChave: ['misto quente', 'misto', 'queijo quente'],\n    macrosBase: { p: 12, c: 25, g: 14, cal: 270 },\n    categoria: 'lanche'\n  },\n  \n  hamburguer: {\n    nome: 'HambÃºrguer',\n    ingredientesBase: ['pÃ£o', 'hamburguer', 'carne'],\n    recheiosPossiveis: ['queijo', 'alface', 'tomate', 'cebola', 'bacon', 'maionese', 'ketchup', 'mostarda'],\n    padraoVisual: 'sanduÃ­che redondo grande',\n    palavrasChave: ['hamburguer', 'hambÃºrguer', 'burger', 'x-burger', 'x-tudo', 'x-salada'],\n    macrosBase: { p: 25, c: 35, g: 20, cal: 420 },\n    categoria: 'lanche'\n  },\n  \n  wrap: {\n    nome: 'Wrap',\n    ingredientesBase: ['tortilla', 'wrap'],\n    recheiosPossiveis: ['frango', 'alface', 'tomate', 'queijo', 'maionese', 'cream cheese'],\n    padraoVisual: 'tortilla enrolada',\n    palavrasChave: ['wrap', 'burrito', 'tortilla', 'wrap de frango'],\n    macrosBase: { p: 10, c: 25, g: 8, cal: 210 },\n    categoria: 'lanche'\n  },\n  \n  hot_dog: {\n    nome: 'Hot Dog',\n    ingredientesBase: ['pÃ£o', 'salsicha'],\n    recheiosPossiveis: ['molho', 'ketchup', 'mostarda', 'maionese', 'batata palha', 'milho', 'ervilha', 'queijo'],\n    padraoVisual: 'pÃ£o com salsicha',\n    palavrasChave: ['hot dog', 'cachorro quente', 'hotdog'],\n    macrosBase: { p: 10, c: 28, g: 15, cal: 290 },\n    categoria: 'lanche'\n  },\n\n  // =====================================================\n  // PRATOS BRASILEIROS\n  // =====================================================\n  prato_feito: {\n    nome: 'PF (Prato Feito)',\n    ingredientesBase: ['arroz', 'feijÃ£o'],\n    recheiosPossiveis: ['bife', 'frango', 'carne', 'ovo', 'salada', 'farofa', 'batata', 'macarrÃ£o'],\n    padraoVisual: 'prato completo com divisÃ³rias',\n    palavrasChave: ['prato feito', 'pf', 'prato do dia', 'comercial', 'executivo'],\n    macrosBase: { p: 30, c: 60, g: 15, cal: 500 },\n    categoria: 'almoco'\n  },\n  \n  marmita: {\n    nome: 'Marmita',\n    ingredientesBase: ['arroz'],\n    recheiosPossiveis: ['feijÃ£o', 'carne', 'frango', 'salada', 'legumes', 'farofa', 'ovo'],\n    padraoVisual: 'recipiente com divisÃ³rias',\n    palavrasChave: ['marmita', 'marmitex', 'quentinha'],\n    macrosBase: { p: 28, c: 55, g: 12, cal: 440 },\n    categoria: 'almoco'\n  },\n  \n  feijoada: {\n    nome: 'Feijoada',\n    ingredientesBase: ['feijÃ£o preto', 'carne de porco'],\n    recheiosPossiveis: ['linguiÃ§a', 'bacon', 'costela', 'couve', 'farofa', 'laranja', 'arroz'],\n    padraoVisual: 'caldeirÃ£o de feijÃ£o escuro com carnes',\n    palavrasChave: ['feijoada', 'feijÃ£o preto com carne'],\n    macrosBase: { p: 35, c: 40, g: 25, cal: 530 },\n    categoria: 'almoco'\n  },\n  \n  strogonoff: {\n    nome: 'Strogonoff',\n    ingredientesBase: ['frango', 'creme de leite'],\n    recheiosPossiveis: ['arroz', 'batata palha', 'champignon', 'ketchup'],\n    padraoVisual: 'molho cremoso com carne',\n    palavrasChave: ['strogonoff', 'estrogonofe', 'strog'],\n    macrosBase: { p: 28, c: 35, g: 18, cal: 420 },\n    categoria: 'almoco'\n  },\n\n  // =====================================================\n  // BEBIDAS E VITAMINAS\n  // =====================================================\n  vitamina: {\n    nome: 'Vitamina',\n    ingredientesBase: ['leite', 'banana'],\n    recheiosPossiveis: ['aveia', 'whey', 'mel', 'morango', 'mamÃ£o', 'maÃ§Ã£', 'linhaÃ§a'],\n    padraoVisual: 'copo com lÃ­quido cremoso',\n    palavrasChave: ['vitamina', 'shake', 'smoothie', 'vitamina de'],\n    macrosBase: { p: 8, c: 35, g: 4, cal: 200 },\n    categoria: 'bebida'\n  },\n  \n  suco_verde: {\n    nome: 'Suco Verde',\n    ingredientesBase: ['couve'],\n    recheiosPossiveis: ['limÃ£o', 'gengibre', 'maÃ§Ã£', 'laranja', 'pepino', 'abacaxi', 'hortelÃ£'],\n    padraoVisual: 'copo com lÃ­quido verde',\n    palavrasChave: ['suco verde', 'suco detox', 'green juice', 'detox'],\n    macrosBase: { p: 1, c: 15, g: 0, cal: 60 },\n    categoria: 'bebida'\n  },\n  \n  whey_shake: {\n    nome: 'Shake de Whey',\n    ingredientesBase: ['whey', 'leite'],\n    recheiosPossiveis: ['banana', 'aveia', 'pasta de amendoim', 'cacau', 'gelo'],\n    padraoVisual: 'copo/coqueteleira com shake',\n    palavrasChave: ['whey', 'shake de whey', 'shake proteico', 'batida de whey'],\n    macrosBase: { p: 30, c: 20, g: 5, cal: 250 },\n    categoria: 'bebida'\n  },\n\n  // =====================================================\n  // BOWLS\n  // =====================================================\n  acai: {\n    nome: 'AÃ§aÃ­',\n    ingredientesBase: ['aÃ§aÃ­'],\n    recheiosPossiveis: ['granola', 'banana', 'morango', 'leite condensado', 'mel', 'paÃ§oca', 'amendoim'],\n    padraoVisual: 'tigela roxa cremosa',\n    palavrasChave: ['aÃ§aÃ­', 'acai', 'aÃ§aÃ­ bowl', 'tigela de aÃ§aÃ­'],\n    macrosBase: { p: 2, c: 30, g: 5, cal: 170 },\n    categoria: 'lanche'\n  },\n  \n  poke: {\n    nome: 'Poke Bowl',\n    ingredientesBase: ['arroz', 'peixe'],\n    recheiosPossiveis: ['salmÃ£o', 'atum', 'abacate', 'manga', 'pepino', 'edamame', 'gengibre'],\n    padraoVisual: 'bowl com arroz e proteÃ­na',\n    palavrasChave: ['poke', 'poke bowl', 'bowl havaiano', 'poke de'],\n    macrosBase: { p: 25, c: 45, g: 12, cal: 400 },\n    categoria: 'almoco'\n  },\n  \n  buddha_bowl: {\n    nome: 'Buddha Bowl',\n    ingredientesBase: ['quinoa', 'legumes'],\n    recheiosPossiveis: ['grÃ£o de bico', 'abacate', 'tomate', 'pepino', 'tahine', 'hummus'],\n    padraoVisual: 'bowl colorido com vegetais',\n    palavrasChave: ['buddha bowl', 'bowl saudÃ¡vel', 'bowl vegano', 'bowl fit'],\n    macrosBase: { p: 15, c: 40, g: 15, cal: 350 },\n    categoria: 'almoco'\n  },\n\n  // =====================================================\n  // SALADAS\n  // =====================================================\n  salada_caesar: {\n    nome: 'Salada Caesar',\n    ingredientesBase: ['alface', 'frango'],\n    recheiosPossiveis: ['parmesÃ£o', 'croutons', 'molho caesar', 'bacon'],\n    padraoVisual: 'salada verde com frango grelhado',\n    palavrasChave: ['salada caesar', 'caesar salad', 'salada de frango'],\n    macrosBase: { p: 22, c: 12, g: 14, cal: 260 },\n    categoria: 'almoco'\n  },\n  \n  // =====================================================\n  // MASSAS\n  // =====================================================\n  macarrao_bolonhesa: {\n    nome: 'MacarrÃ£o Ã  Bolonhesa',\n    ingredientesBase: ['macarrÃ£o', 'carne'],\n    recheiosPossiveis: ['molho de tomate', 'queijo', 'parmesÃ£o', 'cebola', 'alho'],\n    padraoVisual: 'prato de massa com molho vermelho',\n    palavrasChave: ['macarrÃ£o', 'espaguete', 'bolonhesa', 'macarronada'],\n    macrosBase: { p: 18, c: 55, g: 12, cal: 400 },\n    categoria: 'almoco'\n  },\n  \n  lasanha: {\n    nome: 'Lasanha',\n    ingredientesBase: ['massa', 'carne', 'queijo'],\n    recheiosPossiveis: ['molho branco', 'presunto', 'molho vermelho', 'frango'],\n    padraoVisual: 'prato retangular com camadas',\n    palavrasChave: ['lasanha', 'lasanha de', 'lazanha'],\n    macrosBase: { p: 22, c: 40, g: 18, cal: 410 },\n    categoria: 'almoco'\n  },\n\n  // =====================================================\n  // PIZZAS\n  // =====================================================\n  pizza: {\n    nome: 'Pizza',\n    ingredientesBase: ['massa', 'queijo', 'molho'],\n    recheiosPossiveis: ['calabresa', 'presunto', 'frango', 'bacon', 'tomate', 'cebola', 'azeitona', 'catupiry'],\n    padraoVisual: 'disco com cobertura',\n    palavrasChave: ['pizza', 'fatia de pizza', 'pizza de'],\n    macrosBase: { p: 11, c: 28, g: 10, cal: 250 }, // por fatia\n    categoria: 'jantar'\n  },\n\n  // =====================================================\n  // SOPAS E CALDOS\n  // =====================================================\n  sopa: {\n    nome: 'Sopa',\n    ingredientesBase: ['legumes', 'caldo'],\n    recheiosPossiveis: ['frango', 'carne', 'macarrÃ£o', 'batata', 'cenoura', 'chuchu'],\n    padraoVisual: 'tigela com caldo e ingredientes',\n    palavrasChave: ['sopa', 'caldo', 'sopa de', 'caldo de'],\n    macrosBase: { p: 8, c: 15, g: 3, cal: 120 },\n    categoria: 'jantar'\n  },\n  \n  canja: {\n    nome: 'Canja de Galinha',\n    ingredientesBase: ['frango', 'arroz'],\n    recheiosPossiveis: ['cenoura', 'batata', 'cebola', 'salsinha'],\n    padraoVisual: 'caldo amarelo com arroz e frango',\n    palavrasChave: ['canja', 'canja de galinha', 'sopinha de galinha'],\n    macrosBase: { p: 12, c: 20, g: 4, cal: 165 },\n    categoria: 'jantar'\n  }\n};\n\n// =====================================================\n// FUNÃ‡ÃƒO PRINCIPAL: DETECTAR PRATO COMPOSTO\n// =====================================================\n\nfunction detectarPratoComposto(texto, alimentos) {\n  texto = (texto || '').toLowerCase();\n  \n  // 1. Primeiro: buscar por palavra-chave no texto\n  for (const [id, prato] of Object.entries(PRATOS_COMPOSTOS)) {\n    for (const palavra of prato.palavrasChave) {\n      if (texto.includes(palavra)) {\n        return {\n          detectado: true,\n          pratoId: id,\n          pratoNome: prato.nome,\n          metodo: 'palavra_chave',\n          confianca: 'alta'\n        };\n      }\n    }\n  }\n  \n  // 2. Segundo: analisar combinaÃ§Ã£o de ingredientes\n  const nomesAlimentos = alimentos.map(a => (a.nome || a.name || '').toLowerCase());\n  \n  for (const [id, prato] of Object.entries(PRATOS_COMPOSTOS)) {\n    const temBase = prato.ingredientesBase.every(base => \n      nomesAlimentos.some(nome => nome.includes(base))\n    );\n    \n    if (temBase) {\n      const recheiosEncontrados = prato.recheiosPossiveis.filter(rec =>\n        nomesAlimentos.some(nome => nome.includes(rec))\n      );\n      \n      if (recheiosEncontrados.length > 0 || prato.ingredientesBase.length >= 2) {\n        return {\n          detectado: true,\n          pratoId: id,\n          pratoNome: prato.nome,\n          ingredientesBase: prato.ingredientesBase,\n          recheiosEncontrados: recheiosEncontrados,\n          metodo: 'combinacao_ingredientes',\n          confianca: recheiosEncontrados.length > 0 ? 'media' : 'baixa'\n        };\n      }\n    }\n  }\n  \n  return { detectado: false };\n}\n\n// =====================================================\n// FUNÃ‡ÃƒO: CONSOLIDAR INGREDIENTES EM PRATO\n// =====================================================\n\nfunction consolidarEmPrato(alimentos, pratoDetectado) {\n  if (!pratoDetectado.detectado) {\n    return { consolidado: false, alimentos: alimentos };\n  }\n  \n  const prato = PRATOS_COMPOSTOS[pratoDetectado.pratoId];\n  \n  // Calcular macros totais dos ingredientes\n  let macrosTotais = { p: 0, c: 0, g: 0, cal: 0 };\n  const ingredientesUsados = [];\n  \n  alimentos.forEach(alimento => {\n    const macros = alimento.macros || {};\n    macrosTotais.p += macros.proteinas || macros.protein || 0;\n    macrosTotais.c += macros.carboidratos || macros.carbs || 0;\n    macrosTotais.g += macros.gorduras || macros.fats || 0;\n    macrosTotais.cal += macros.calorias || macros.calories || 0;\n    \n    ingredientesUsados.push(alimento.nome || alimento.name);\n  });\n  \n  // Criar descriÃ§Ã£o do prato\n  const descricao = ingredientesUsados.join(', ');\n  \n  return {\n    consolidado: true,\n    pratoConsolidado: {\n      nome: `${prato.nome} (${descricao})`,\n      tipo: pratoDetectado.pratoId,\n      ingredientes: ingredientesUsados,\n      peso_gramas: alimentos.reduce((t, a) => t + (a.peso_gramas || a.weight || 0), 0),\n      macros: {\n        proteinas: Math.round(macrosTotais.p * 10) / 10,\n        carboidratos: Math.round(macrosTotais.c * 10) / 10,\n        gorduras: Math.round(macrosTotais.g * 10) / 10,\n        calorias: Math.round(macrosTotais.cal)\n      },\n      confianca: pratoDetectado.confianca,\n      metodoDeteccao: pratoDetectado.metodo\n    },\n    ingredientesOriginais: alimentos\n  };\n}\n\n// =====================================================\n// CÃ“DIGO DO NÃ“ N8N\n// =====================================================\n\nconst inputData = $input.first().json;\nconst textoDescritivo = inputData.recordatorio?.textoDescritivo || inputData.content || '';\n\n// Buscar alimentos da anÃ¡lise\nlet alimentos = [];\nif (inputData.analise_foto?.alimentos) {\n  alimentos = inputData.analise_foto.alimentos;\n} else if (inputData.alimentos) {\n  alimentos = inputData.alimentos;\n} else if (inputData._alimentosIdentificados) {\n  alimentos = inputData._alimentosIdentificados;\n}\n\nconsole.log('ðŸ³ === DETECÃ‡ÃƒO DE PRATOS COMPOSTOS ===');\nconsole.log('ðŸ“ Texto:', textoDescritivo.substring(0, 50));\nconsole.log('ðŸ¥— Alimentos:', alimentos.length);\n\n// Detectar prato composto\nconst pratoDetectado = detectarPratoComposto(textoDescritivo, alimentos);\n\nif (pratoDetectado.detectado) {\n  console.log(`âœ… Prato detectado: ${pratoDetectado.pratoNome} (${pratoDetectado.confianca})`);\n  \n  const resultado = consolidarEmPrato(alimentos, pratoDetectado);\n  \n  return {\n    json: {\n      ...inputData,\n      \n      // Prato consolidado\n      _pratoComposto: resultado.pratoConsolidado,\n      _ehPratoComposto: true,\n      \n      // Substituir anÃ¡lise pelo prato consolidado\n      analise_foto: {\n        ...inputData.analise_foto,\n        alimentos: [resultado.pratoConsolidado],\n        macros_totais: resultado.pratoConsolidado.macros,\n        _alimentosOriginais: resultado.ingredientesOriginais\n      },\n      \n      // Metadados\n      _deteccaoPrato: pratoDetectado\n    }\n  };\n  \n} else {\n  console.log('âŒ Nenhum prato composto detectado - mantendo ingredientes separados');\n  \n  return {\n    json: {\n      ...inputData,\n      _ehPratoComposto: false,\n      _deteccaoPrato: { detectado: false }\n    }\n  };\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        29760,
        -720
      ],
      "id": "d7ba643d-c646-4862-a300-957402828a39",
      "name": "Detectar Prato Composto"
    },
    {
      "parameters": {
        "url": "=https://nutribuddy.dog/api/onboarding/check?phone={{ $json.patientPhone || $json.body.patientPhone }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "12803196-07ef-412e-9ab9-f4d7494996bb",
      "name": "ONBOARD: Verificar Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        23232,
        -768
      ],
      "onError": "continueRegularOutput",
      "notes": "Verifica se o paciente estÃ¡ em processo de onboarding"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "onboard-check-1",
              "leftValue": "={{ $json.isOnboarding === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "09c0ff58-769d-44da-bd98-175010f72d27",
      "name": "ONBOARD: Ã‰ Onboarding?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        23456,
        -768
      ],
      "notes": "TRUE = paciente em onboarding, FALSE = paciente normal"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, redirectedTo: 'onboarding' } }}",
        "options": {}
      },
      "id": "15f21646-d4fd-4930-ad64-8698e92104f5",
      "name": "ONBOARD: Responder",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        23680,
        -1344
      ],
      "notes": "Finaliza o fluxo apÃ³s redirecionar para onboarding"
    },
    {
      "parameters": {
        "jsCode": "const statusData = $('ONBOARD: Verificar Status').first().json;\nconst webhookData = $('1. Validar e Processar').first().json;\n\nconst patientId = statusData.id;\nconst nome = statusData.name || 'Paciente';\nconst email = statusData.email || '';\nconst primeiroNome = nome.split(' ')[0];\n\nconst userMessage = (webhookData.content || '').toLowerCase().trim();\n\n// Verificar se confirmou email\nconst confirmou = \n  userMessage.includes('sim') || \n  userMessage.includes('certo') ||\n  userMessage.includes('correto') || \n  userMessage.includes('ok') ||\n  userMessage === 's';\n\nlet resposta = '';\n\nif (confirmou) {\n  const link = `https://nutribuddy.dog/paciente/configurar/${patientId}`;\n  resposta = `Ã“timo, ${primeiroNome}! ðŸ˜Š\\n\\nClique no link abaixo para confirmar seus dados e criar sua senha:\\n\\n${link}\\n\\nDepois Ã© sÃ³ me mandar as fotos das suas refeiÃ§Ãµes! ðŸ“¸`;\n} else {\n  resposta = `${primeiroNome}, seu email Ã© ${email}?\\n\\nResponda *SIM* se estiver correto.`;\n}\n\nreturn {\n  json: {\n    resposta,\n    confirmou,\n    patientId,\n    conversationId: webhookData.conversationId,\n    prescriberId: webhookData.prescriberId || statusData.prescriberId\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        23456,
        -1344
      ],
      "id": "e7dc00ea-b9c9-4af3-8773-bf3ffd0eaf50",
      "name": "ONBOARD: Redirecionar"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"senderId\": \"{{ $json.prescriberId }}\",\n  \"senderRole\": \"prescriber\",\n  \"content\": {{ JSON.stringify($json.resposta) }},\n  \"type\": \"text\",\n  \"isAiGenerated\": true\n}",
        "options": {}
      },
      "id": "83d15e8a-b59e-4979-ab17-51263821fd2e",
      "name": "ONBOARD: Enviar Resposta",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        23904,
        -1152
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-confirmou",
              "leftValue": "={{ $('ONBOARD: Redirecionar').first().json.confirmou }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9a9dd18c-39ad-406e-9764-c1014f33931a",
      "name": "ONBOARD: Confirmou?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        24128,
        -1152
      ]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://nutribuddy.dog/api/patients/{{ $('ONBOARD: Redirecionar').first().json.patientId }}/onboarding-status",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"onboardingStatus\": \"pending_account_creation\",\n  \"lastInteraction\": \"{{ new Date().toISOString() }}\"\n}",
        "options": {}
      },
      "id": "93d50134-da92-4d81-8dae-abdd48114848",
      "name": "ONBOARD: Atualizar Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        24352,
        -1232
      ]
    },
    {
      "parameters": {},
      "id": "1938aea0-3625-465d-8e59-92a2786c2e05",
      "name": "ONBOARD: Fim",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        24576,
        -1152
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook: Nova Mensagem": {
      "main": [
        [
          {
            "node": "1. Validar e Processar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1. Validar e Processar": {
      "main": [
        [
          {
            "node": "2. Foi Filtrado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2. Foi Filtrado?": {
      "main": [
        [
          {
            "node": "Responder: Filtrado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "2a. TEM ÃUDIO?",
            "type": "main",
            "index": 0
          },
          {
            "node": "ONBOARD: Verificar Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. Buscar Conversa": {
      "main": [
        [
          {
            "node": "3-bis. Checar Assinatura",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3-bis. Checar Assinatura": {
      "main": [
        [
          {
            "node": "4. Buscar HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder: Assinatura Suspensa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4. Buscar HistÃ³rico": {
      "main": [
        [
          {
            "node": "5. Buscar Dieta do Paciente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5. Buscar Dieta do Paciente": {
      "main": [
        [
          {
            "node": "5h. Detectar Pergunta sobre HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6. Construir Contexto IA": {
      "main": [
        [
          {
            "node": "6b. Detectar Restaurante",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7. AnÃ¡lise IA (OpenAI)": {
      "main": [
        [
          {
            "node": "8. Parse AnÃ¡lise IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8. Parse AnÃ¡lise IA": {
      "main": [
        [
          {
            "node": "9. Deve Responder?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9. Deve Responder?": {
      "main": [
        [
          {
            "node": "10. Enviar Auto-resposta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "NÃ£o Responder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "10. Enviar Auto-resposta": {
      "main": [
        [
          {
            "node": "12. Responder: Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. TEM FOTO?": {
      "main": [
        [
          {
            "node": "4a. Buscar Conversa (FOTO)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3a-PRE. Detectar CorreÃ§Ã£o RÃ¡pida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4a. Buscar Conversa (FOTO)": {
      "main": [
        [
          {
            "node": "4-bis. Checar (FOTO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4-bis. Checar (FOTO)": {
      "main": [
        [
          {
            "node": "5a. Buscar Dieta (FOTO)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder: Assinatura Suspensa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5a. Buscar Dieta (FOTO)": {
      "main": [
        [
          {
            "node": "6a-0. Preparar Prompt Vision1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8a. Comparar com Dieta": {
      "main": [
        [
          {
            "node": "Buscar Banco Aprendizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9a. Construir Contexto Resposta": {
      "main": [
        [
          {
            "node": "10a. IA Gera Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "10a. IA Gera Resposta": {
      "main": [
        [
          {
            "node": "11a. Parse Resposta Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11a. Parse Resposta Final": {
      "main": [
        [
          {
            "node": "11c. Verificar Metas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "12a. Enviar Resposta (FOTO)": {
      "main": [
        [
          {
            "node": "12. Responder: Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5c. Tem Dieta Prescrita?": {
      "main": [
        [
          {
            "node": "5d. IF: Tem Dieta?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5d. IF: Tem Dieta?": {
      "main": [
        [
          {
            "node": "5e. Usar Dieta Prescrita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "5b. Buscar Macros Perfil (FALLBACK)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5b. Buscar Macros Perfil (FALLBACK)": {
      "main": [
        [
          {
            "node": "5f. Usar Macros do Perfil",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5e. Usar Dieta Prescrita": {
      "main": [
        [
          {
            "node": "5g. Buscar CorreÃ§Ãµes Aprendidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5f. Usar Macros do Perfil": {
      "main": [
        [
          {
            "node": "5g. Buscar CorreÃ§Ãµes Aprendidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6a-1. Baixar Imagem": {
      "main": [
        [
          {
            "node": "6a-2. Converter para Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6a-2. Converter para Base64": {
      "main": [
        [
          {
            "node": "6a. Analisar Foto (GPT-4 Vision)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 2. Buscar Contexto Ativo": {
      "main": [
        [
          {
            "node": "FASE2: 3. Tem Contexto Ativo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 3. Tem Contexto Ativo?": {
      "main": [
        [
          {
            "node": "FASE2: 4. Analisar IntenÃ§Ã£o (IA)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "4. Buscar HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6b. AÃ§Ã£o: AdiÃ§Ã£o": {
      "main": [
        [
          {
            "node": "Enviar Aprendizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6c. AÃ§Ã£o: ConfirmaÃ§Ã£o": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 8. Registrar RefeiÃ§Ã£o": {
      "main": [
        [
          {
            "node": "FASE2: 9. Deletar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6d. AÃ§Ã£o: Cancelamento": {
      "main": [
        [
          {
            "node": "FASE2: 9. Deletar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 9. Deletar Contexto": {
      "main": [
        [
          {
            "node": "FASE2: 10. Enviar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 10. Enviar Resposta": {
      "main": [
        [
          {
            "node": "FASE2: 11. Responder Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2a. TEM ÃUDIO?": {
      "main": [
        [
          {
            "node": "AUDIO: 1. Baixar Arquivo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3. Buscar Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AUDIO: 1. Baixar Arquivo": {
      "main": [
        [
          {
            "node": "AUDIO: 2. Preparar para Whisper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AUDIO: 2. Preparar para Whisper": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AUDIO: 4. Parse TranscriÃ§Ã£o": {
      "main": [
        [
          {
            "node": "3. Buscar Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "AUDIO: 4. Parse TranscriÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11b. Dividir em 3 Mensagens": {
      "main": [
        [
          {
            "node": "12a. Enviar Resposta (FOTO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5h. Detectar Pergunta sobre HistÃ³rico": {
      "main": [
        [
          {
            "node": "5h-IF. Ã‰ Pergunta sobre HistÃ³rico?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5h-IF. Ã‰ Pergunta sobre HistÃ³rico?": {
      "main": [
        [
          {
            "node": "5i. Extrair PerÃ­odo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "5z. Buscar Contexto Completo do Paciente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5i. Extrair PerÃ­odo": {
      "main": [
        [
          {
            "node": "5j. Buscar HistÃ³rico DiÃ¡rio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5j. Buscar HistÃ³rico DiÃ¡rio": {
      "main": [
        [
          {
            "node": "5k. Construir Contexto com HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5k. Construir Contexto com HistÃ³rico": {
      "main": [
        [
          {
            "node": "6. Construir Contexto IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3a. Tem Contexto FASE2?": {
      "main": [
        [
          {
            "node": "3b. IF: Tem Dados?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3b. IF: Tem Dados?": {
      "main": [
        [
          {
            "node": "FASE2: 4. Analisar IntenÃ§Ã£o (IA)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3. Buscar Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Roteador de IntenÃ§Ã£o": {
      "main": [
        [
          {
            "node": "FASE2: 6b. AÃ§Ã£o: AdiÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FASE2: 6c. AÃ§Ã£o: ConfirmaÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar Food DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FASE2: 6d. AÃ§Ã£o: Cancelamento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "4. Buscar HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "4. Buscar HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5z. Buscar Contexto Completo do Paciente": {
      "main": [
        [
          {
            "node": "6. Construir Contexto IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7d. Detectar Embalagem": {
      "main": [
        [
          {
            "node": "7d-IF. Pular?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7d. Vision - Ler Embalagem": {
      "main": [
        [
          {
            "node": "7e-1. Preparar Busca API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7e-3. Aplicar Dados API": {
      "main": [
        [
          {
            "node": "8a. Comparar com Dieta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7e-2. Buscar Open Food Facts": {
      "main": [
        [
          {
            "node": "7e-3. Aplicar Dados API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7e-1. Preparar Busca API": {
      "main": [
        [
          {
            "node": "7e-2. Buscar Open Food Facts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7d-IF. Pular?": {
      "main": [
        [
          {
            "node": "8a. Comparar com Dieta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "7d. Vision - Ler Embalagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7a-2. Buscar CorreÃ§Ãµes Firebase": {
      "main": [
        [
          {
            "node": "7a-3. Aplicar Aprendizado1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Tem SugestÃµes?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5g. Buscar CorreÃ§Ãµes Aprendidas": {
      "main": [
        [
          {
            "node": "6a-1. Baixar Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tem SugestÃµes?": {
      "main": [
        [
          {
            "node": "Salvar SugestÃ£o no Studio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FASE2: 8. Registrar RefeiÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar SugestÃ£o no Studio": {
      "main": [
        [
          {
            "node": "FASE2: 8. Registrar RefeiÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6a-0. Preparar Prompt Vision1": {
      "main": [
        [
          {
            "node": "5c. Tem Dieta Prescrita?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 1. Criar Contexto Inicial1": {
      "main": [
        [
          {
            "node": "11b. Dividir em 3 Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6a. Analisar Foto (GPT-4 Vision)1": {
      "main": [
        [
          {
            "node": "7a. PARSE-VISION1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7a. PARSE-VISION1": {
      "main": [
        [
          {
            "node": "7a-2. Buscar CorreÃ§Ãµes Firebase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7a-3. Aplicar Aprendizado1": {
      "main": [
        [
          {
            "node": "7a-4. Verificar ConfianÃ§a",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11a-bis. Registrar RefeiÃ§Ã£o AutomÃ¡tica": {
      "main": [
        [
          {
            "node": "9a. Construir Contexto Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Food DB": {
      "main": [
        [
          {
            "node": "FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7a-4. Verificar ConfianÃ§a": {
      "main": [
        [
          {
            "node": "7d. Detectar Embalagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11c. Verificar Metas": {
      "main": [
        [
          {
            "node": "FASE2: 1. Criar Contexto Inicial1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 4. Analisar IntenÃ§Ã£o (IA)": {
      "main": [
        [
          {
            "node": "FASE2: 4b. Processar Resposta IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 4b. Processar Resposta IA": {
      "main": [
        [
          {
            "node": "Roteador de IntenÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o": {
      "main": [
        [
          {
            "node": "Ã‰ ConfusÃ£o de Tipo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ã‰ ConfusÃ£o de Tipo?": {
      "main": [
        [
          {
            "node": "FASE2: 6a-3.5 Enviar ConfusÃ£o de Tipo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FASE2: 6a-3. Enviar para SugestÃµes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a-3.5 Enviar ConfusÃ£o de Tipo": {
      "main": [
        [
          {
            "node": "FASE2: 6a-3. Enviar para SugestÃµes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a-3. Enviar para SugestÃµes": {
      "main": [
        [
          {
            "node": "FASE2: 6a-4. Atualizar RefeiÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a-4. Atualizar RefeiÃ§Ã£o": {
      "main": [
        [
          {
            "node": "FASE2: 6a-2. Enviar Feedback Aprendizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a-2. Enviar Feedback Aprendizado": {
      "main": [
        [
          {
            "node": "Enviar Aprendizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 7. Atualizar Contexto1": {
      "main": [
        [
          {
            "node": "FASE2: 6a-4. Atualizar Banco (Nova API)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a-4. Atualizar Banco (Nova API)": {
      "main": [
        [
          {
            "node": "FASE2: 10. Enviar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3a-PRE. Detectar CorreÃ§Ã£o RÃ¡pida": {
      "main": [
        [
          {
            "node": "3a-IF. Ã‰ CorreÃ§Ã£o?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3a-IF. Ã‰ CorreÃ§Ã£o?": {
      "main": [
        [
          {
            "node": "3a-MAP. Preparar para IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3a. Tem Contexto FASE2?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3a-MAP. Preparar para IA": {
      "main": [
        [
          {
            "node": "FASE2: 4. Analisar IntenÃ§Ã£o (IA)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6b. Detectar Restaurante": {
      "main": [
        [
          {
            "node": "7. AnÃ¡lise IA (OpenAI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Banco Aprendizado": {
      "main": [
        [
          {
            "node": "ReflexÃ£o Inteligente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ReflexÃ£o Inteligente": {
      "main": [
        [
          {
            "node": "Detectar Prato Composto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calibrar PorÃ§Ãµes": {
      "main": [
        [
          {
            "node": "11a-bis. Registrar RefeiÃ§Ã£o AutomÃ¡tica",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detectar Prato Composto": {
      "main": [
        [
          {
            "node": "Calibrar PorÃ§Ãµes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Aprendizado": {
      "main": [
        [
          {
            "node": "FASE2: 7. Atualizar Contexto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ONBOARD: Verificar Status": {
      "main": [
        [
          {
            "node": "ONBOARD: Ã‰ Onboarding?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ONBOARD: Ã‰ Onboarding?": {
      "main": [
        [
          {
            "node": "ONBOARD: Redirecionar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3. TEM FOTO?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ONBOARD: Redirecionar": {
      "main": [
        [
          {
            "node": "ONBOARD: Enviar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ONBOARD: Enviar Resposta": {
      "main": [
        [
          {
            "node": "ONBOARD: Confirmou?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ONBOARD: Confirmou?": {
      "main": [
        [
          {
            "node": "ONBOARD: Atualizar Status",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ONBOARD: Responder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ONBOARD: Atualizar Status": {
      "main": [
        [
          {
            "node": "ONBOARD: Responder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "d1aa4122-332c-4c1c-9f8c-8519c5794ebd",
  "meta": {
    "instanceId": "2ecd07a43b0e041940f064474e8a18afb2a90a41122cda3ef71839a8bff4edf7"
  },
  "id": "3bxyZ4N6ILTd7ozY",
  "tags": []
}